<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0d1117;
      height: 100vh;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      color: #e6edf3;
      overflow: hidden;
    }

    .header {
      background: #161b22;
      padding: 1rem 2rem;
      text-align: center;
      border-bottom: 1px solid #30363d;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      color: #e6edf3;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .city-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .city-selector label {
      color: #e6edf3;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .city-select {
      background: #0d1117;
      color: #e6edf3;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    .city-select:focus {
      outline: none;
      border-color: #1f6feb;
    }

    .city-select option {
      background: #0d1117;
      color: #e6edf3;
    }

    .user-info span {
      color: #8b949e;
      font-size: 0.9rem;
    }

    .logout-btn {
      background: #21262d;
      color: #e6edf3;
      border: 1px solid #30363d;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .logout-btn:hover {
      background: #30363d;
      border-color: #484f58;
    }

    .chat-container {
      flex: 1;
      width: 100%;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px); /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’å¼•ã */
    }

    #chat {
      flex: 1;
      background: #0d1117;
      border-radius: 0;
      padding: 1rem;
      margin-bottom: 0;
      overflow-y: auto;
      border: none;
      border-bottom: 1px solid #30363d;
      min-height: auto;
      max-height: none;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .msg {
      margin: 0.75rem 0;
      padding: 0.75rem 1rem;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in;
      line-height: 1.6;
      display: inline-block;
      width: fit-content;
      min-width: 60px;
    }

    .user {
      background: #6e7681;
      color: #ffffff;
      margin-left: auto;
      text-align: right;
      border-radius: 18px 18px 4px 18px;
      align-self: flex-end;
    }

    .ai {
      background: #21262d;
      color: #e6edf3;
      border: 1px solid #30363d;
      border-radius: 18px 18px 18px 4px;
      align-self: flex-start;
    }

    .search-result {
      background: #0c2d6b;
      border-left: 4px solid #1f6feb;
      padding: 0.75rem 1rem;
      margin: 0.75rem 0;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #e6edf3;
      align-self: flex-start;
      width: fit-content;
      max-width: 80%;
    }

    .input-container {
      display: flex;
      gap: 0.5rem;
      background: #161b22;
      padding: 1rem 2rem;
      border-radius: 0;
      border: none;
      border-top: 1px solid #30363d;
      box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.3);
      position: sticky;
      bottom: 0;
    }

    #input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid #30363d;
      border-radius: 8px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s ease;
      background: #0d1117;
      color: #e6edf3;
    }

    #input:focus {
      border-color: #1f6feb;
      box-shadow: 0 0 0 2px rgba(31, 111, 235, 0.2);
    }

    #input::placeholder {
      color: #8b949e;
    }

    #send {
      padding: 0.75rem 1.5rem;
      background: #1f6feb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #send:hover {
      background: #388bfd;
      transform: translateY(-1px);
    }

    #send:active {
      transform: translateY(0);
      background: #1f6feb;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #30363d;
      border-top: 3px solid #1f6feb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 0.75rem 1rem;
      background: #21262d;
      border-radius: 18px 18px 18px 4px;
      margin: 0.75rem 0;
      max-width: 80%;
      border: 1px solid #30363d;
      align-self: flex-start;
      width: fit-content;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #8b949e;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    @media (max-width: 768px) {
      .chat-container { 
        padding: 0; 
        height: calc(100vh - 70px);
      }
      .msg { max-width: 90%; }
      .input-container { 
        flex-direction: column; 
        padding: 1rem;
      }
      .header {
        padding: 1rem;
      }
      #chat { 
        height: 100%;
        padding: 0.5rem;
      }
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
    #chat::-webkit-scrollbar {
      width: 8px;
    }

    #chat::-webkit-scrollbar-track {
      background: #0d1117;
    }

    #chat::-webkit-scrollbar-thumb {
      background: #30363d;
      border-radius: 4px;
    }

    #chat::-webkit-scrollbar-thumb:hover {
      background: #484f58;
    }
  </style>
</head>
<body>
  <div class="header">
            <h1 id="ai-title"> ç„¡æ–™AIå­¦ç¿’ãƒãƒ£ãƒƒãƒˆ</h1>
    <div class="user-info">
      <div class="city-selector">
        <label for="city-select">éƒ½å¸‚:</label>
        <select id="city-select" class="city-select" style="background: #333; color: white; border: 1px solid #555; padding: 5px; border-radius: 4px;">
          <option value="Tokyo">æ±äº¬</option>
          <option value="Osaka">å¤§é˜ª</option>
        </select>
      </div>
      <button onclick="showLearningSettings()" class="learning-btn" style="background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px; cursor: pointer;">ğŸ§  å­¦ç¿’è¨­å®š</button>
      <button onclick="showSystemStatus()" class="system-btn" style="background: #555; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px; cursor: pointer;">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</button>
      <span id="user-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
      <button id="logout-btn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <div class="chat-container">
    <div id="chat">
      <div class="msg ai">
         ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ<br>
        ã€Œã€‡ã€‡ã«ã¤ã„ã¦èª¿ã¹ã¦ã€ã‚„ã€Œã€‡ã€‡ã‚’æ¤œç´¢ã—ã¦ã€ã¨è¨€ãˆã°ã€Googleæ¤œç´¢ã‚’é–‹ãã¾ã™ã€‚<br>
        ã¾ãŸã€AIã®åå‰å¤‰æ›´ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‘¼ã³æ–¹å¤‰æ›´ã‚‚å¯èƒ½ã§ã™ï¼<br>
        ä¾‹ï¼šã€Œã‚ãªãŸã¯AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€ã€Œç§ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å‘¼ã‚“ã§ã€<br><br>
        <strong> ç„¡æ–™AIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ æ­è¼‰ï¼š</strong><br>
        â€¢ é«˜åº¦ãªæ„Ÿæƒ…åˆ†æã¨æ–‡è„ˆç†è§£<br>
        â€¢ 100,000ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¼šè©±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹<br>
        â€¢ å­¦ç¿’æ©Ÿèƒ½ã«ã‚ˆã‚‹ç¶™ç¶šçš„ãªæ”¹å–„<br>
        â€¢ æ¤œç´¢æ©Ÿèƒ½ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æƒ…å ±æä¾›<br>
        â€¢ æ°—æ¸©ãƒ»å¤©æ°—æƒ…å ±ã®å–å¾—<br>
        â€¢ éƒ½å¸‚é¸æŠæ©Ÿèƒ½ï¼ˆæ±äº¬ãƒ»å¤§é˜ªï¼‰<br>
        â€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘½ä»¤ã®å­¦ç¿’æ©Ÿèƒ½<br>
        â€¢ å®Œå…¨ç„¡æ–™ã®é«˜åº¦AIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
      </div>
    </div>

    <div class="input-container">
      <input id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." />
      <button id="send" style="background: #333; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">é€ä¿¡</button>
    </div>
  </div>

  <script>
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    function checkAuth() {
      if (localStorage.getItem('is_logged_in') !== 'true') {
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
    if (!checkAuth()) {
      // èªè¨¼ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ãŸå ´åˆã¯å‡¦ç†ã‚’åœæ­¢
      throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    async function loadUserInfo() {
      try {
        const response = await fetch('get_user_info.php');
        const data = await response.json();
        
        if (data.success) {
          const fullName = data.data.full_name;
          document.getElementById('user-name').textContent = `ã‚ˆã†ã“ãã€${fullName}ã•ã‚“`;
          
          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°
          localStorage.setItem('user_name', fullName);
          localStorage.setItem('user_id', data.data.id);
        } else {
          // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
          const userName = localStorage.getItem('user_name') || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
          document.getElementById('user-name').textContent = `ã‚ˆã†ã“ãã€${userName}ã•ã‚“`;
        }
      } catch (error) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
        const userName = localStorage.getItem('user_name') || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
        document.getElementById('user-name').textContent = `ã‚ˆã†ã“ãã€${userName}ã•ã‚“`;
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    loadUserInfo();

    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const send = document.getElementById("send");

    // 10ä¸‡ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¼šè©±çµ„ã¿åˆã‚ã›ã‚’ä½œæˆ
    const conversationPatterns = generateConversationPatterns();
    
    // ä¼šè©±å±¥æ­´ã‚’ä¿å­˜
    let conversationHistory = [];
    
    // é«˜åº¦ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
    class AdvancedContextManager {
      constructor() {
        this.contexts = new Map(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
        this.globalContext = {
          currentTopic: '',
          userMood: 'neutral',
          conversationLength: 0,
          lastUserMessage: '',
          interests: [],
          timeOfDay: '',
          season: '',
          lastResponseType: '',
          // æ–°ã—ã„é«˜åº¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          topicHistory: [],
          moodTrend: [],
          conversationFlow: [],
          userPreferences: {},
          emotionalState: {},
          attentionLevel: 'normal',
          responseQuality: []
        };
      }
      
      getContext(userId = 'default') {
        if (!this.contexts.has(userId)) {
          this.contexts.set(userId, this.createNewContext());
        }
        return this.contexts.get(userId);
      }
      
      createNewContext() {
        return {
          currentTopic: '',
          userMood: 'neutral',
          conversationLength: 0,
          lastUserMessage: '',
          interests: [],
          timeOfDay: this.getTimeOfDay(),
          season: this.getCurrentSeason(),
          lastResponseType: '',
          topicHistory: [],
          moodTrend: [],
          conversationFlow: [],
          userPreferences: {},
          emotionalState: {},
          attentionLevel: 'normal',
          responseQuality: [],
          // é«˜åº¦ãªåˆ†æçµæœ
          semanticContext: {},
          discourseMarkers: [],
          turnTaking: [],
          topicShifts: [],
          emotionalContinuity: []
        };
      }
      
      updateContext(userId, message, analysis, response) {
        const context = this.getContext(userId);
        
        // åŸºæœ¬æƒ…å ±ã®æ›´æ–°
        context.lastUserMessage = message;
        context.conversationLength++;
        context.lastResponseType = this.classifyResponseType(response);
        
        // ãƒˆãƒ”ãƒƒã‚¯ã®è¿½è·¡
        this.updateTopicContext(context, analysis);
        
        // æ„Ÿæƒ…ã®è¿½è·¡
        this.updateEmotionalContext(context, analysis);
        
        // ä¼šè©±ã®æµã‚Œã®åˆ†æ
        this.updateConversationFlow(context, message, response);
        
        // æ³¨æ„ãƒ¬ãƒ™ãƒ«ã®æ¨å®š
        context.attentionLevel = this.estimateAttentionLevel(context);
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä¿å­˜
        this.contexts.set(userId, context);
      }
      
      updateTopicContext(context, analysis) {
        if (analysis.topic && analysis.topic !== context.currentTopic) {
          // ãƒˆãƒ”ãƒƒã‚¯ã®å¤‰æ›´ã‚’è¨˜éŒ²
          if (context.currentTopic) {
            context.topicShifts.push({
              from: context.currentTopic,
              to: analysis.topic,
              timestamp: new Date().toISOString()
            });
          }
          
          context.currentTopic = analysis.topic;
          context.topicHistory.push({
            topic: analysis.topic,
            timestamp: new Date().toISOString(),
            confidence: analysis.confidence || 0
          });
          
          // ãƒˆãƒ”ãƒƒã‚¯å±¥æ­´ã‚’æœ€æ–°20ä»¶ã«åˆ¶é™
          if (context.topicHistory.length > 20) {
            context.topicHistory = context.topicHistory.slice(-20);
          }
        }
      }
      
      updateEmotionalContext(context, analysis) {
        if (analysis.emotions) {
          context.emotionalState = analysis.emotions;
          context.moodTrend.push({
            emotions: analysis.emotions,
            sentiment: analysis.sentiment,
            intensity: analysis.emotionLevel,
            timestamp: new Date().toISOString()
          });
          
          // æ„Ÿæƒ…ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æœ€æ–°50ä»¶ã«åˆ¶é™
          if (context.moodTrend.length > 50) {
            context.moodTrend = context.moodTrend.slice(-50);
          }
          
          // æ„Ÿæƒ…ã®é€£ç¶šæ€§ã‚’åˆ†æ
          this.analyzeEmotionalContinuity(context);
        }
      }
      
      updateConversationFlow(context, message, response) {
        context.conversationFlow.push({
          userMessage: message,
          aiResponse: response,
          timestamp: new Date().toISOString(),
          turnType: this.classifyTurnType(message, response)
        });
        
        // ä¼šè©±ãƒ•ãƒ­ãƒ¼ã‚’æœ€æ–°100ä»¶ã«åˆ¶é™
        if (context.conversationFlow.length > 100) {
          context.conversationFlow = context.conversationFlow.slice(-100);
        }
      }
      
      classifyResponseType(response) {
        if (response.includes('æ¤œç´¢')) return 'search';
        if (response.includes('æ™‚é–“') || response.includes('å¤©æ°—')) return 'information';
        if (response.includes('ã‚ã‚ŠãŒã¨ã†') || response.includes('ã©ã†ã„ãŸã—ã¾ã—ã¦')) return 'gratitude';
        if (response.includes('ï¼Ÿ') || response.includes('æ•™ãˆã¦')) return 'question';
        return 'conversation';
      }
      
      classifyTurnType(message, response) {
        const messageType = this.getMessageType(message);
        const responseType = this.getMessageType(response);
        
        if (messageType === 'question' && responseType === 'answer') return 'qa';
        if (messageType === 'statement' && responseType === 'acknowledgment') return 'ack';
        if (messageType === 'greeting' && responseType === 'greeting') return 'greeting';
        return 'conversation';
      }
      
      getMessageType(text) {
        if (text.includes('ï¼Ÿ') || text.includes('?')) return 'question';
        if (text.includes('ã“ã‚“ã«ã¡ã¯') || text.includes('ãŠã¯ã‚ˆã†')) return 'greeting';
        if (text.includes('ã‚ã‚ŠãŒã¨ã†')) return 'gratitude';
        if (text.includes('ã€‚') || text.includes('ï¼')) return 'statement';
        return 'conversation';
      }
      
      analyzeEmotionalContinuity(context) {
        if (context.moodTrend.length < 2) return;
        
        const recentMoods = context.moodTrend.slice(-5);
        const emotionalContinuity = {
          stability: this.calculateEmotionalStability(recentMoods),
          trend: this.calculateEmotionalTrend(recentMoods),
          volatility: this.calculateEmotionalVolatility(recentMoods)
        };
        
        context.emotionalContinuity.push({
          ...emotionalContinuity,
          timestamp: new Date().toISOString()
        });
      }
      
      calculateEmotionalStability(moods) {
        if (moods.length < 2) return 1;
        
        const intensityChanges = [];
        for (let i = 1; i < moods.length; i++) {
          const change = Math.abs(moods[i].intensity - moods[i-1].intensity);
          intensityChanges.push(change);
        }
        
        const averageChange = intensityChanges.reduce((sum, change) => sum + change, 0) / intensityChanges.length;
        return Math.max(0, 1 - averageChange / 10);
      }
      
      calculateEmotionalTrend(moods) {
        if (moods.length < 2) return 'stable';
        
        const firstMood = moods[0].intensity;
        const lastMood = moods[moods.length - 1].intensity;
        const change = lastMood - firstMood;
        
        if (change > 1) return 'improving';
        if (change < -1) return 'declining';
        return 'stable';
      }
      
      calculateEmotionalVolatility(moods) {
        if (moods.length < 2) return 0;
        
        const intensities = moods.map(mood => mood.intensity);
        const mean = intensities.reduce((sum, intensity) => sum + intensity, 0) / intensities.length;
        const variance = intensities.reduce((sum, intensity) => sum + Math.pow(intensity - mean, 2), 0) / intensities.length;
        
        return Math.sqrt(variance);
      }
      
      estimateAttentionLevel(context) {
        const recentFlow = context.conversationFlow.slice(-10);
        const messageLengths = recentFlow.map(flow => flow.userMessage.length);
        const averageLength = messageLengths.reduce((sum, length) => sum + length, 0) / messageLengths.length;
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é•·ã•ã¨æ„Ÿæƒ…ã®å¼·åº¦ã‹ã‚‰æ³¨æ„ãƒ¬ãƒ™ãƒ«ã‚’æ¨å®š
        if (averageLength > 50 && context.emotionalState.joy > 5) return 'high';
        if (averageLength < 10 && context.emotionalState.confusion > 5) return 'low';
        return 'normal';
      }
      
      getTimeOfDay() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return 'morning';
        if (hour >= 12 && hour < 17) return 'afternoon';
        if (hour >= 17 && hour < 21) return 'evening';
        return 'night';
      }
      
      getCurrentSeason() {
        const month = new Date().getMonth() + 1;
        if (month >= 3 && month <= 5) return 'spring';
        if (month >= 6 && month <= 8) return 'summer';
        if (month >= 9 && month <= 11) return 'autumn';
        return 'winter';
      }
      
      getContextSummary(userId = 'default') {
        const context = this.getContext(userId);
        return {
          currentTopic: context.currentTopic,
          userMood: context.userMood,
          conversationLength: context.conversationLength,
          attentionLevel: context.attentionLevel,
          emotionalTrend: context.emotionalContinuity.length > 0 ? 
            context.emotionalContinuity[context.emotionalContinuity.length - 1] : null,
          recentTopics: context.topicHistory.slice(-5),
          moodStability: context.emotionalContinuity.length > 0 ? 
            context.emotionalContinuity[context.emotionalContinuity.length - 1].stability : 1
        };
      }
    }
    
    // é«˜åº¦ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    const advancedContextManager = new AdvancedContextManager();
    
    // å¾“æ¥ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
    let conversationContext = {
      currentTopic: '',
      userMood: 'neutral',
      conversationLength: 0,
      lastUserMessage: '',
      interests: [],
      timeOfDay: '',
      season: '',
      lastResponseType: ''
    };
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç®¡ç†
    let userPreferences = {
      aiName: 'AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ', // AIã®åå‰
      userName: '', // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‘¼ã³æ–¹
      customCommands: {}, // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰
      personality: 'friendly', // AIã®æ€§æ ¼
      language: 'ja', // ä½¿ç”¨è¨€èª
      responseStyle: 'normal', // å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«
      selectedCity: 'Tokyo', // é¸æŠã•ã‚ŒãŸéƒ½å¸‚ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ±äº¬ï¼‰
      // æ–°ã—ã„å­¦ç¿’æ©Ÿèƒ½

      learningMode: true,
      learningStyle: 'adaptive', // adaptive, pattern, contextual
      responseComplexity: 'medium', // simple, medium, complex
      autoLearn: true
    };
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadUserPreferences() {
      try {
        const saved = localStorage.getItem('userPreferences');
        if (saved) {
          const parsed = JSON.parse(saved);
          userPreferences = { ...userPreferences, ...parsed };
          console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', userPreferences);
        }
      } catch (error) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    function saveUserPreferences() {
      try {
        localStorage.setItem('userPreferences', JSON.stringify(userPreferences));
        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ:', userPreferences);
      } catch (error) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // éƒ½å¸‚ãƒ‡ãƒ¼ã‚¿
    const cityData = {
      'Tokyo': {
        name: 'æ±äº¬',
        latitude: 35.6762,
        longitude: 139.6503,
        timezone: 'Asia/Tokyo'
      },
      'Osaka': {
        name: 'å¤§é˜ª',
        latitude: 34.6937,
        longitude: 135.5023,
        timezone: 'Asia/Tokyo'
      }
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’èª­ã¿è¾¼ã¿
    loadUserPreferences();
    
    // AIã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
    updateAITitle();
    
    // éƒ½å¸‚é¸æŠã®åˆæœŸåŒ–
    initializeCitySelector();
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
    console.log('ç„¡æ–™AIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸï¼');
    console.log('ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†:', conversationContext);
    
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ
    window.addEventListener('error', function(e) {
      console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', e.error);
    });
    
    window.addEventListener('unhandledrejection', function(e) {
      console.error('æœªå‡¦ç†ã®Promiseæ‹’å¦:', e.reason);
    });

    // é«˜åº¦ãªæ„Ÿæƒ…åˆ†æã¨ãƒˆãƒ”ãƒƒã‚¯æŠ½å‡º
    function analyzeUserMessage(message) {
      const analysis = {
        sentiment: 'neutral', // positive, negative, neutral
        topic: '',
        intent: '',
        urgency: 'low',
        formality: 'casual',
        keywords: [],
        emotionLevel: 0, // -5 to +5
        questionType: '', // specific, general, rhetorical
        contextClues: [],
        personalInfo: false, // å€‹äººçš„ãªæƒ…å ±ã‚’å«ã‚€ã‹
        // æ–°ã—ã„é«˜åº¦åˆ†æãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        emotions: {}, // è©³ç´°ãªæ„Ÿæƒ…åˆ†æ
        confidence: 0, // åˆ†æã®ä¿¡é ¼åº¦
        complexity: 'simple', // æ–‡ã®è¤‡é›‘ã•
        politeness: 'neutral', // ä¸å¯§ã•ãƒ¬ãƒ™ãƒ«
        sarcasm: false, // çš®è‚‰ã®æ¤œå‡º
        emphasis: [] // å¼·èª¿è¡¨ç¾
      };
      
      // é«˜åº¦ãªæ„Ÿæƒ…åˆ†æã‚·ã‚¹ãƒ†ãƒ 
      const emotionAnalyzer = new AdvancedEmotionAnalyzer();
      const emotionResult = emotionAnalyzer.analyze(message);
      
      // æ„Ÿæƒ…åˆ†æçµæœã‚’çµ±åˆ
      analysis.emotions = emotionResult.emotions;
      analysis.sentiment = emotionResult.primarySentiment;
      analysis.emotionLevel = emotionResult.intensity;
      analysis.confidence = emotionResult.confidence;
      
      // å¾“æ¥ã®æ„Ÿæƒ…åˆ†æï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      const positiveWords = {
        strong: ['æœ€é«˜', 'ç´ æ™´ã‚‰ã—ã„', 'æ„Ÿå‹•', 'èˆˆå¥®', 'æ„›ã—ã¦ã‚‹', 'å¤§å¥½ã', 'å®Œç’§', 'é©šã'],
        medium: ['å¬‰ã—ã„', 'æ¥½ã—ã„', 'è‰¯ã„', 'å¥½ã', 'æ„Ÿè¬', 'ã‚ã‚ŠãŒã¨ã†', 'å¹¸ã›', 'æœŸå¾…', 'å¸Œæœ›', 'æº€è¶³'],
        mild: ['ã„ã„', 'ã‚ˆã„', 'ã¾ã‚ã¾ã‚', 'ãã“ãã“', 'ãªã‚“ã¨ã‹', 'ãŠã‹ã’ã§']
      };
      
      const negativeWords = {
        strong: ['æœ€æ‚ª', 'çµ¶æœ›', 'æ€’ã‚Š', 'æ†ã„', 'è¨±ã›ãªã„', 'è‹¦ã—ã„', 'ã‚€ã‹ã¤ã', 'è…¹ç«‹ã¤'],
        medium: ['æ‚²ã—ã„', 'å›°ã£ãŸ', 'å¤§å¤‰', 'è¾›ã„', 'å«Œã„', 'æ€–ã„', 'ä¸å®‰', 'å¿ƒé…', 'ã‚¤ãƒ©ã‚¤ãƒ©', 'è½ã¡è¾¼ã¿'],
        mild: ['å¾®å¦™', 'ã¡ã‚‡ã£ã¨', 'å°‘ã—å›°ã‚‹', 'ã‚„ã‚„ä¸å®‰', 'è»½ãå¿ƒé…']
      };
      
      // æ„Ÿæƒ…ãƒ¬ãƒ™ãƒ«ã®è¨ˆç®—
      Object.entries(positiveWords).forEach(([level, words]) => {
        words.forEach(word => {
          if (message.includes(word)) {
            analysis.sentiment = 'positive';
            analysis.keywords.push(word);
            switch(level) {
              case 'strong': analysis.emotionLevel += 3; break;
              case 'medium': analysis.emotionLevel += 2; break;
              case 'mild': analysis.emotionLevel += 1; break;
            }
          }
        });
      });
      
      Object.entries(negativeWords).forEach(([level, words]) => {
        words.forEach(word => {
          if (message.includes(word)) {
            analysis.sentiment = 'negative';
            analysis.keywords.push(word);
            switch(level) {
              case 'strong': analysis.emotionLevel -= 3; break;
              case 'medium': analysis.emotionLevel -= 2; break;
              case 'mild': analysis.emotionLevel -= 1; break;
            }
          }
        });
      });
      
      // æ„Ÿæƒ…ãƒ¬ãƒ™ãƒ«ã®æ­£è¦åŒ–
      analysis.emotionLevel = Math.max(-5, Math.min(5, analysis.emotionLevel));
      
      // æ‹¡å¼µã•ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯åˆ†æ
      const topics = {
        'work': ['ä»•äº‹', 'ä¼šç¤¾', 'ã‚ªãƒ•ã‚£ã‚¹', 'ä¼šè­°', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ', 'ä¸Šå¸', 'åŒåƒš', 'æ®‹æ¥­', 'è»¢è·', 'ã‚­ãƒ£ãƒªã‚¢', 'è·å ´', 'éƒ¨ç½²', 'å–¶æ¥­', 'é–‹ç™º', 'ä¼ç”»'],
        'hobby': ['è¶£å‘³', 'æ˜ ç”»', 'éŸ³æ¥½', 'ã‚¹ãƒãƒ¼ãƒ„', 'ã‚²ãƒ¼ãƒ ', 'èª­æ›¸', 'æ–™ç†', 'æ—…è¡Œ', 'å†™çœŸ', 'ã‚¢ãƒ¼ãƒˆ', 'é‡£ã‚Š', 'ãƒ‰ãƒ©ã‚¤ãƒ–', 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°', 'ã‚«ãƒ©ã‚ªã‚±'],
        'family': ['å®¶æ—', 'å­ä¾›', 'è¦ª', 'å…„å¼Ÿ', 'å§‰å¦¹', 'å¤«', 'å¦»', 'çµå©š', 'è‚²å…', 'å®¶äº‹', 'ä¸¡è¦ª', 'ç¥–çˆ¶æ¯', 'å­«', 'æ¯å­', 'å¨˜'],
        'health': ['å¥åº·', 'ç—…æ°—', 'ç—…é™¢', 'è–¬', 'é‹å‹•', 'ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ', 'ç¡çœ ', 'ã‚¹ãƒˆãƒ¬ã‚¹', 'ç–²åŠ´', 'ä½“èª¿', 'é¢¨é‚ª', 'é ­ç—›', 'è…°ç—›', 'ã‚¸ãƒ '],
        'technology': ['ãƒ‘ã‚½ã‚³ãƒ³', 'ã‚¹ãƒãƒ›', 'ã‚¢ãƒ—ãƒª', 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ', 'AI', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', 'ã‚²ãƒ¼ãƒ ', 'SNS', 'ã‚½ãƒ•ãƒˆ', 'ãƒãƒ¼ãƒ‰', 'ã‚¯ãƒ©ã‚¦ãƒ‰'],
        'food': ['é£Ÿã¹ç‰©', 'æ–™ç†', 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', 'ã‚«ãƒ•ã‚§', 'ãŠé…’', 'ç”˜ã„ã‚‚ã®', 'å’Œé£Ÿ', 'æ´‹é£Ÿ', 'ä¸­è¯', 'ãƒ©ãƒ³ãƒ', 'å¤•é£Ÿ', 'æœé£Ÿ', 'ãŠã‚„ã¤', 'ãƒ‡ã‚¶ãƒ¼ãƒˆ'],
        'weather': ['å¤©æ°—', 'é›¨', 'é›ª', 'æ™´ã‚Œ', 'æ›‡ã‚Š', 'æš‘ã„', 'å¯’ã„', 'æ˜¥', 'å¤', 'ç§‹', 'å†¬', 'æ°—æ¸©', 'æ¹¿åº¦', 'å°é¢¨', 'æ¢…é›¨'],
        'study': ['å‹‰å¼·', 'å­¦æ ¡', 'å¤§å­¦', 'è©¦é¨“', 'å®¿é¡Œ', 'æˆæ¥­', 'è¬›ç¾©', 'å—é¨“', 'è³‡æ ¼', 'å­¦ç¿’', 'ãƒ†ã‚¹ãƒˆ', 'æˆç¸¾'],
        'relationship': ['å‹é”', 'æ‹äºº', 'å½¼æ°', 'å½¼å¥³', 'ãƒ‡ãƒ¼ãƒˆ', 'æ‹æ„›', 'å‹æƒ…', 'äººé–“é–¢ä¿‚', 'ä»˜ãåˆã„', 'å‡ºä¼šã„'],
        'shopping': ['è²·ã„ç‰©', 'æœ', 'é´', 'ãƒãƒƒã‚°', 'åŒ–ç²§å“', 'å®¶é›»', 'å®¶å…·', 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ', 'ã‚®ãƒ•ãƒˆ', 'ã‚»ãƒ¼ãƒ«'],
        'entertainment': ['ãƒ†ãƒ¬ãƒ“', 'YouTube', 'Netflix', 'ã‚¢ãƒ‹ãƒ¡', 'ãƒ‰ãƒ©ãƒ', 'ãƒãƒ©ã‚¨ãƒ†ã‚£', 'ãƒ‹ãƒ¥ãƒ¼ã‚¹', 'ã‚³ãƒ³ã‚µãƒ¼ãƒˆ', 'ãƒ©ã‚¤ãƒ–'],
        'daily': ['æ—¥å¸¸', 'æ¯æ—¥', 'æ™®æ®µ', 'æœ', 'æ˜¼', 'å¤œ', 'ä»Šæ—¥', 'æ˜æ—¥', 'æ˜¨æ—¥', 'é€±æœ«', 'å¹³æ—¥']
      };
      
      Object.entries(topics).forEach(([key, words]) => {
        words.forEach(word => {
          if (message.includes(word)) {
            analysis.topic = key;
            analysis.keywords.push(word);
          }
        });
      });
      
      // é«˜åº¦ãªæ„å›³åˆ†æ
      // è³ªå•ã®ç¨®é¡ã‚’è©³ç´°ã«åˆ†æ
      if (message.includes('?') || message.includes('ï¼Ÿ')) {
        analysis.intent = 'question';
        if (message.includes('ã©ã†æ€ã†') || message.includes('ã©ã†æ„Ÿã˜ã‚‹')) {
          analysis.questionType = 'opinion';
        } else if (message.includes('ä½•') || message.includes('ã„ã¤') || message.includes('ã©ã“') || message.includes('èª°')) {
          analysis.questionType = 'specific';
        } else {
          analysis.questionType = 'general';
        }
      } else if (message.includes('æ•™ãˆã¦') || message.includes('ã©ã†ã—ã¦') || message.includes('ãªãœ') || message.includes('ç†ç”±') || message.includes('åŸå› ')) {
        analysis.intent = 'question';
        analysis.questionType = 'explanation';
      } else if (message.includes('ãŠé¡˜ã„') || message.includes('é ¼ã‚€') || message.includes('æ‰‹ä¼ã£ã¦') || message.includes('åŠ©ã‘ã¦') || message.includes('ã‚„ã£ã¦') || message.includes('ä½œæˆã—ã¦') || message.includes('èª¿ã¹ã¦')) {
        analysis.intent = 'request';
        if (message.includes('æ€¥ã„ã§') || message.includes('ã™ãã«') || message.includes('è‡³æ€¥')) {
          analysis.urgency = 'high';
        }
      } else if (message.includes('ã‚ã‚ŠãŒã¨ã†') || message.includes('æ„Ÿè¬') || message.includes('ã‚µãƒ³ã‚­ãƒ¥ãƒ¼') || message.includes('thanks') || message.includes('åŠ©ã‹ã£ãŸ')) {
        analysis.intent = 'gratitude';
      } else if (message.includes('ã“ã‚“ã«ã¡ã¯') || message.includes('ãŠã¯ã‚ˆã†') || message.includes('ã“ã‚“ã°ã‚“ã¯') || message.includes('ã¯ã˜ã‚ã¾ã—ã¦') || message.includes('ãŠç–²ã‚Œ')) {
        analysis.intent = 'greeting';
      } else if (message.includes('ã•ã‚ˆã†ãªã‚‰') || message.includes('ãƒã‚¤ãƒã‚¤') || message.includes('ã¾ãŸã­') || message.includes('ãŠç–²ã‚Œæ§˜') || message.includes('å¤±ç¤¼ã—ã¾ã™')) {
        analysis.intent = 'farewell';
      } else if (message.includes('ç›¸è«‡') || message.includes('æ‚©ã¿') || message.includes('å›°ã£ã¦ã‚‹') || message.includes('ã‚¢ãƒ‰ãƒã‚¤ã‚¹')) {
        analysis.intent = 'consultation';
      } else if (message.includes('å ±å‘Š') || message.includes('çŸ¥ã‚‰ã›') || message.includes('ä¼ãˆã‚‹') || message.includes('é€£çµ¡')) {
        analysis.intent = 'information';
      }
      
      // å€‹äººæƒ…å ±ã®æ¤œå‡º
      if (message.includes('ç§ã¯') || message.includes('åƒ•ã¯') || message.includes('ä¿ºã¯') || message.includes('è‡ªåˆ†ã¯')) {
        analysis.personalInfo = true;
      }
      
      // æ•¬èªã®æ¤œå‡º
      if (message.includes('ã§ã™') || message.includes('ã¾ã™') || message.includes('ã”ã–ã„ã¾ã™') || message.includes('ã„ãŸã—ã¾ã™')) {
        analysis.formality = 'formal';
      } else if (message.includes('ã ') || message.includes('ã§ã‚ã‚‹') || message.includes('ã ã‚ˆ') || message.includes('ã ã­')) {
        analysis.formality = 'casual';
      }
      
      // æ–‡è„ˆæ‰‹ãŒã‹ã‚Šã®æŠ½å‡º
      if (message.includes('ã§ã‚‚') || message.includes('ã—ã‹ã—') || message.includes('ãŸã ')) {
        analysis.contextClues.push('contrast');
      }
      if (message.includes('ãã‚Œã§') || message.includes('ã ã‹ã‚‰') || message.includes('ãªã®ã§')) {
        analysis.contextClues.push('consequence');
      }
      if (message.includes('ä¾‹ãˆã°') || message.includes('ãŸã¨ãˆã°') || message.includes('å…·ä½“çš„ã«')) {
        analysis.contextClues.push('example');
      }
      
      return analysis;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘½ä»¤ã®å­¦ç¿’ãƒ»å‡¦ç†
    function processUserCommand(message) {
      const command = message.toLowerCase().trim();
      
      // AIã®åå‰å¤‰æ›´
      if (command.includes('åå‰') && (command.includes('å‘¼ã‚“ã§') || command.includes('å‘¼ã³æ–¹') || command.includes('åå‰ã‚’'))) {
        const nameMatch = message.match(/[ã€Œã€]([^ã€ã€]+)[ã€ã€]/);
        if (nameMatch) {
          const newName = nameMatch[1];
          userPreferences.aiName = newName;
          saveUserPreferences();
          updateAITitle();
          return `ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã“ã‚Œã‹ã‚‰ã¯ã€Œ${newName}ã€ã¨å‘¼ã°ã›ã¦ã„ãŸã ãã¾ã™ã€‚`;
        } else {
          return 'AIã®åå‰ã‚’å¤‰æ›´ã—ãŸã„å ´åˆã¯ã€ã€Œã€‡ã€‡ã¨å‘¼ã‚“ã§ã€ã®ã‚ˆã†ã«ã€Œã€ã§å›²ã‚“ã§æ•™ãˆã¦ãã ã•ã„ã€‚';
        }
      }
      
      // AIã®åå‰ã‚’ç›´æ¥æŒ‡å®šï¼ˆæ–°ã—ã„æ©Ÿèƒ½ï¼‰
      if (message.includes('ã‚ãªãŸã¯') && (message.includes('ã§ã™') || message.includes('ã ') || message.includes('ã ã‚ˆ'))) {
        const nameMatch = message.match(/ã‚ãªãŸã¯[ã€Œã€]?([^ã€ã€\s]+)[ã€ã€]?ã§ã™?/);
        if (nameMatch) {
          const newName = nameMatch[1];
          userPreferences.aiName = newName;
          saveUserPreferences();
          updateAITitle();
          return `ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã“ã‚Œã‹ã‚‰ã¯ã€Œ${newName}ã€ã¨ã—ã¦æ´»å‹•ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚`;
        }
      }
      
      // AIã®åå‰ã‚’è‹±èªã§æŒ‡å®š
      if (message.includes('you are') || message.includes('you\'re')) {
        const nameMatch = message.match(/you\s+(?:are|re)\s+[ã€Œã€]?([^ã€ã€\s]+)[ã€ã€]?/i);
        if (nameMatch) {
          const newName = nameMatch[1];
          userPreferences.aiName = newName;
          saveUserPreferences();
          updateAITitle();
          return `Thank you! From now on, I will be "${newName}".`;
        }
      }
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‘¼ã³æ–¹å¤‰æ›´
      if (command.includes('ç§') && (command.includes('å‘¼ã‚“ã§') || command.includes('å‘¼ã³æ–¹') || command.includes('åå‰ã‚’'))) {
        const nameMatch = message.match(/[ã€Œã€]([^ã€ã€]+)[ã€ã€]/);
        if (nameMatch) {
          const newUserName = nameMatch[1];
          userPreferences.userName = newUserName;
          saveUserPreferences();
          return `ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã“ã‚Œã‹ã‚‰ã¯ã€Œ${newUserName}ã€ã•ã‚“ã¨å‘¼ã³ã¾ã™ã­ã€‚`;
        } else {
          return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‘¼ã³æ–¹ã‚’å¤‰æ›´ã—ãŸã„å ´åˆã¯ã€ã€Œç§ã‚’ã€‡ã€‡ã¨å‘¼ã‚“ã§ã€ã®ã‚ˆã†ã«ã€Œã€ã§å›²ã‚“ã§æ•™ãˆã¦ãã ã•ã„ã€‚';
        }
      }
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ç›´æ¥æŒ‡å®šï¼ˆæ–°ã—ã„æ©Ÿèƒ½ï¼‰
      if (message.includes('ç§ã®åå‰ã¯') || message.includes('åƒ•ã®åå‰ã¯') || message.includes('ä¿ºã®åå‰ã¯')) {
        const nameMatch = message.match(/(?:ç§|åƒ•|ä¿º)ã®åå‰ã¯[ã€Œã€]?([^ã€ã€\s]+)[ã€ã€]?/);
        if (nameMatch) {
          const newUserName = nameMatch[1];
          userPreferences.userName = newUserName;
          saveUserPreferences();
          return `ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã“ã‚Œã‹ã‚‰ã¯ã€Œ${newUserName}ã€ã•ã‚“ã¨å‘¼ã³ã¾ã™ã­ã€‚`;
        }
      }
      
      // è‹±èªã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åæŒ‡å®š
      if (message.includes('call me') || message.includes('my name is')) {
        let nameMatch;
        if (message.includes('call me')) {
          nameMatch = message.match(/call\s+me\s+[ã€Œã€]?([^ã€ã€\s]+)[ã€ã€]?/i);
        } else if (message.includes('my name is')) {
          nameMatch = message.match(/my\s+name\s+is\s+[ã€Œã€]?([^ã€ã€\s]+)[ã€ã€]?/i);
        }
        
        if (nameMatch) {
          const newUserName = nameMatch[1];
          userPreferences.userName = newUserName;
          saveUserPreferences();
          return `Thank you! From now on, I will call you "${newUserName}".`;
        }
      }
      
      // AIã®æ€§æ ¼å¤‰æ›´
      if (command.includes('æ€§æ ¼') && (command.includes('å¤‰ãˆã¦') || command.includes('å¤‰æ›´') || command.includes('è¨­å®š'))) {
        if (command.includes('è¦ªã—ã¿ã‚„ã™ã„') || command.includes('ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼')) {
          userPreferences.personality = 'friendly';
          saveUserPreferences();
          return 'æ€§æ ¼ã‚’è¦ªã—ã¿ã‚„ã™ã„ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªæ€§æ ¼ã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else if (command.includes('ä¸å¯§') || command.includes('ãƒ•ã‚©ãƒ¼ãƒãƒ«')) {
          userPreferences.personality = 'formal';
          saveUserPreferences();
          return 'æ€§æ ¼ã‚’ä¸å¯§ã§ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªæ€§æ ¼ã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else if (command.includes('é¢ç™½ã„') || command.includes('ãƒ¦ãƒ¼ãƒ¢ã‚¢')) {
          userPreferences.personality = 'humorous';
          saveUserPreferences();
          return 'æ€§æ ¼ã‚’é¢ç™½ãã¦ãƒ¦ãƒ¼ãƒ¢ã‚¢ã®ã‚ã‚‹æ€§æ ¼ã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else if (command.includes('å°‚é–€çš„') || command.includes('ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«')) {
          userPreferences.personality = 'professional';
          saveUserPreferences();
          return 'æ€§æ ¼ã‚’å°‚é–€çš„ã§ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªæ€§æ ¼ã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else {
          return 'åˆ©ç”¨å¯èƒ½ãªæ€§æ ¼: è¦ªã—ã¿ã‚„ã™ã„ã€ä¸å¯§ã€é¢ç™½ã„ã€å°‚é–€çš„ã€‚ã©ã®æ€§æ ¼ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ';
        }
      }
      
      // å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
      if (command.includes('å¿œç­”') && (command.includes('å¤‰ãˆã¦') || command.includes('å¤‰æ›´') || command.includes('ã‚¹ã‚¿ã‚¤ãƒ«'))) {
        if (command.includes('ç°¡æ½”') || command.includes('çŸ­ã')) {
          userPreferences.responseStyle = 'concise';
          saveUserPreferences();
          return 'å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç°¡æ½”ã§çŸ­ã„ã‚¹ã‚¿ã‚¤ãƒ«ã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else if (command.includes('è©³ã—ã') || command.includes('é•·ã')) {
          userPreferences.responseStyle = 'detailed';
          saveUserPreferences();
          return 'å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è©³ã—ãé•·ã„ã‚¹ã‚¿ã‚¤ãƒ«ã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else if (command.includes('çµµæ–‡å­—') || command.includes('å¯æ„›ã')) {
          userPreferences.responseStyle = 'cute';
          saveUserPreferences();
          return 'å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµµæ–‡å­—ã‚’ä½¿ã£ãŸå¯æ„›ã„ã‚¹ã‚¿ã‚¤ãƒ«ã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else {
          return 'åˆ©ç”¨å¯èƒ½ãªå¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«: ç°¡æ½”ã€è©³ã—ãã€çµµæ–‡å­—ã€‚ã©ã®ã‚¹ã‚¿ã‚¤ãƒ«ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ';
        }
      }
      
      // è¨€èªå¤‰æ›´
      if (command.includes('è¨€èª') && (command.includes('å¤‰ãˆã¦') || command.includes('å¤‰æ›´') || command.includes('è¨­å®š'))) {
        if (command.includes('è‹±èª') || command.includes('english')) {
          userPreferences.language = 'en';
          saveUserPreferences();
          return 'è¨€èªã‚’è‹±èªã«å¤‰æ›´ã—ã¾ã—ãŸï¼I will respond in English from now on.';
        } else if (command.includes('æ—¥æœ¬èª') || command.includes('japanese')) {
          userPreferences.language = 'ja';
          saveUserPreferences();
          return 'è¨€èªã‚’æ—¥æœ¬èªã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else {
          return 'åˆ©ç”¨å¯èƒ½ãªè¨€èª: æ—¥æœ¬èªã€è‹±èªã€‚ã©ã®è¨€èªã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ';
        }
      }
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã®å­¦ç¿’ï¼ˆè¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œï¼‰
      let commandLearned = false;
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã€Œè¦šãˆã¦ã€ã€Œã‚³ãƒãƒ³ãƒ‰ã€ã‚’å«ã‚€å ´åˆ
      if (command.includes('è¦šãˆã¦') && command.includes('ã‚³ãƒãƒ³ãƒ‰')) {
        const commandMatch = message.match(/ã€Œ([^ã€]+)ã€ã¨è¨€ã£ãŸã‚‰ã€Œ([^ã€]+)ã€ã¨ç­”ãˆã¦/);
        if (commandMatch) {
          const trigger = commandMatch[1];
          const response = commandMatch[2];
          userPreferences.customCommands[trigger] = response;
          saveUserPreferences();
          commandLearned = true;
          console.log('ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã‚’å­¦ç¿’ã—ã¾ã—ãŸ:', { trigger, response, allCommands: userPreferences.customCommands });
          return `è¦šãˆã¾ã—ãŸï¼ã€Œ${trigger}ã€ã¨è¨€ã£ãŸã‚‰ã€Œ${response}ã€ã¨ç­”ãˆã¾ã™ã€‚`;
        }
      }
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ã€Œã¨è¨€ã£ãŸã‚‰ã€ã€Œã¨ç­”ãˆã¦ã€ã‚’å«ã‚€å ´åˆ
      if (!commandLearned && (message.includes('ã¨è¨€ã£ãŸã‚‰') || message.includes('ã¨è¨€ã‚ã‚ŒãŸã‚‰'))) {
        const commandMatch = message.match(/ã€Œ([^ã€]+)ã€?(?:ã¨è¨€ã£ãŸã‚‰|ã¨è¨€ã‚ã‚ŒãŸã‚‰)ã€Œ([^ã€]+)ã€?(?:ã¨ç­”ãˆã¦|ã¨è¿”ã—ã¦|ã¨è¿”ã—ã¦ãã ã•ã„)/);
        if (commandMatch) {
          const trigger = commandMatch[1];
          const response = commandMatch[2];
          userPreferences.customCommands[trigger] = response;
          saveUserPreferences();
          commandLearned = true;
          return `è¦šãˆã¾ã—ãŸï¼ã€Œ${trigger}ã€ã¨è¨€ã‚ã‚ŒãŸã‚‰ã€Œ${response}ã€ã¨ç­”ãˆã¾ã™ã€‚`;
        }
      }
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³3: ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã®å ´åˆ
      if (!commandLearned && (message.includes('ã¨è¨€ã£ãŸã‚‰') || message.includes('ã¨è¨€ã‚ã‚ŒãŸã‚‰'))) {
        const commandMatch = message.match(/([^ã€Œã€]+)(?:ã¨è¨€ã£ãŸã‚‰|ã¨è¨€ã‚ã‚ŒãŸã‚‰)([^ã€Œã€]+)(?:ã¨ç­”ãˆã¦|ã¨è¿”ã—ã¦|ã¨è¿”ã—ã¦ãã ã•ã„)/);
        if (commandMatch) {
          const trigger = commandMatch[1].trim();
          const response = commandMatch[2].trim();
          userPreferences.customCommands[trigger] = response;
          saveUserPreferences();
          commandLearned = true;
          return `è¦šãˆã¾ã—ãŸï¼ã€Œ${trigger}ã€ã¨è¨€ã‚ã‚ŒãŸã‚‰ã€Œ${response}ã€ã¨ç­”ãˆã¾ã™ã€‚`;
        }
      }
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³4: è‹±èªã§ã®å­¦ç¿’
      if (!commandLearned && (message.includes('if someone says') || message.includes('when someone says'))) {
        const commandMatch = message.match(/(?:if someone says|when someone says)\s*["']([^"']+)["']\s*(?:please reply|reply|respond)\s*["']([^"']+)["']/i);
        if (commandMatch) {
          const trigger = commandMatch[1];
          const response = commandMatch[2];
          userPreferences.customCommands[trigger] = response;
          saveUserPreferences();
          commandLearned = true;
          return `I learned! When someone says "${trigger}", I will reply "${response}".`;
        }
      }
      
      // å­¦ç¿’ã§ããªã‹ã£ãŸå ´åˆã®æ¡ˆå†…
      if (!commandLearned && (message.includes('ã¨è¨€ã£ãŸã‚‰') || message.includes('ã¨è¨€ã‚ã‚ŒãŸã‚‰') || message.includes('if someone says'))) {
        return 'ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã‚’å­¦ç¿’ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢å¼ã§æ•™ãˆã¦ãã ã•ã„ï¼š\n' +
               'â€¢ ã€Œã€‡ã€‡ã¨è¨€ã£ãŸã‚‰â–³â–³ã¨ç­”ãˆã¦ã€\n' +
               'â€¢ ã€‡ã€‡ã¨è¨€ã‚ã‚ŒãŸã‚‰â–³â–³ã¨è¿”ã—ã¦ãã ã•ã„\n' +
               'â€¢ If someone says "hello", please reply "hi"\n' +
               'â€¢ ã€Œæ°—æ¸©æ•™ãˆã¦ã€ã¨è¨€ã‚ã‚ŒãŸã‚‰æ°—æ¸©æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹';
      }
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ
      if (userPreferences.customCommands[message]) {
        return userPreferences.customCommands[message];
      }
      
      // éƒ¨åˆ†ä¸€è‡´ã§ã®ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆã‚ˆã‚ŠæŸ”è»Ÿãªæ¤œç´¢ï¼‰
      for (const [trigger, response] of Object.entries(userPreferences.customCommands)) {
        if (message.includes(trigger) || trigger.includes(message)) {
          return response;
        }
      }
      
      // è¨­å®šã®ç¢ºèª
      if (command.includes('è¨­å®š') && (command.includes('ç¢ºèª') || command.includes('è¦‹ã›ã¦') || command.includes('æ•™ãˆã¦'))) {
        return `ç¾åœ¨ã®è¨­å®š:\n` +
               `â€¢ AIã®åå‰: ${userPreferences.aiName}\n` +
               `â€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‘¼ã³æ–¹: ${userPreferences.userName || 'è¨­å®šãªã—'}\n` +
               `â€¢ æ€§æ ¼: ${getPersonalityName(userPreferences.personality)}\n` +
               `â€¢ å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«: ${getResponseStyleName(userPreferences.responseStyle)}\n` +
               `â€¢ è¨€èª: ${getLanguageName(userPreferences.language)}\n` +
               `â€¢ é¸æŠéƒ½å¸‚: ${cityData[userPreferences.selectedCity].name}\n` +
               `â€¢ ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰: ${Object.keys(userPreferences.customCommands).length}å€‹`;
      }
      
      // éƒ½å¸‚å¤‰æ›´
      if (command.includes('éƒ½å¸‚') && (command.includes('å¤‰æ›´') || command.includes('å¤‰ãˆã¦') || command.includes('åˆ‡ã‚Šæ›¿ãˆ'))) {
        if (command.includes('å¤§é˜ª') || command.includes('osaka')) {
          userPreferences.selectedCity = 'Osaka';
          saveUserPreferences();
          updateCitySelector();
          return 'éƒ½å¸‚ã‚’å¤§é˜ªã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else if (command.includes('æ±äº¬') || command.includes('tokyo')) {
          userPreferences.selectedCity = 'Tokyo';
          saveUserPreferences();
          updateCitySelector();
          return 'éƒ½å¸‚ã‚’æ±äº¬ã«å¤‰æ›´ã—ã¾ã—ãŸï¼';
        } else {
          return 'åˆ©ç”¨å¯èƒ½ãªéƒ½å¸‚: æ±äº¬ã€å¤§é˜ªã€‚ã©ã®éƒ½å¸‚ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ';
        }
      }
      
      // è¨­å®šã®ãƒªã‚»ãƒƒãƒˆ
      if (command.includes('è¨­å®š') && (command.includes('ãƒªã‚»ãƒƒãƒˆ') || command.includes('åˆæœŸåŒ–') || command.includes('å…ƒã«æˆ»ã™'))) {
        userPreferences = {
          aiName: 'AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
          userName: '',
          customCommands: {},
          personality: 'friendly',
          language: 'ja',
          responseStyle: 'normal',
          selectedCity: 'Tokyo'
        };
        saveUserPreferences();
        updateAITitle();
        updateCitySelector();
        return 'è¨­å®šã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼';
      }
      
      return null; // å‘½ä»¤ã§ãªã„å ´åˆã¯nullã‚’è¿”ã™
    }
    
    // æ€§æ ¼åã‚’æ—¥æœ¬èªã§å–å¾—
    function getPersonalityName(personality) {
      const names = {
        'friendly': 'è¦ªã—ã¿ã‚„ã™ã„',
        'formal': 'ä¸å¯§',
        'humorous': 'é¢ç™½ã„',
        'professional': 'å°‚é–€çš„'
      };
      return names[personality] || personality;
    }
    
    // å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«åã‚’æ—¥æœ¬èªã§å–å¾—
    function getResponseStyleName(style) {
      const names = {
        'concise': 'ç°¡æ½”',
        'detailed': 'è©³ã—ã',
        'cute': 'çµµæ–‡å­—',
        'normal': 'é€šå¸¸'
      };
      return names[style] || style;
    }
    
    // è¨€èªåã‚’æ—¥æœ¬èªã§å–å¾—
    function getLanguageName(language) {
      const names = {
        'ja': 'æ—¥æœ¬èª',
        'en': 'è‹±èª'
      };
      return names[language] || language;
    }
    
    // AIã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
    function updateAITitle() {
      const titleElement = document.querySelector('.header h1');
      if (titleElement) {
        titleElement.textContent = userPreferences.aiName;
      }
    }
    
    // éƒ½å¸‚é¸æŠã®åˆæœŸåŒ–
    function initializeCitySelector() {
      const citySelect = document.getElementById('city-select');
      if (citySelect) {
        // ä¿å­˜ã•ã‚ŒãŸéƒ½å¸‚ã‚’é¸æŠ
        citySelect.value = userPreferences.selectedCity;
        
        // éƒ½å¸‚å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        citySelect.addEventListener('change', function() {
          const selectedCity = this.value;
          userPreferences.selectedCity = selectedCity;
          saveUserPreferences();
          console.log(`éƒ½å¸‚ã‚’${cityData[selectedCity].name}ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
        });
      }
    }
    
    // éƒ½å¸‚é¸æŠã®æ›´æ–°
    function updateCitySelector() {
      const citySelect = document.getElementById('city-select');
      if (citySelect) {
        citySelect.value = userPreferences.selectedCity;
      }
    }

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°
    function updateConversationContext(analysis) {
      conversationContext.conversationLength++;
      conversationContext.lastUserMessage = analysis.keywords.join(', ');
      
      if (analysis.topic) {
        conversationContext.currentTopic = analysis.topic;
      }
      
      if (analysis.sentiment !== 'neutral') {
        conversationContext.userMood = analysis.sentiment;
      }
      
      // æ™‚é–“ã¨å­£ç¯€ã®æ›´æ–°
      const now = new Date();
      const hour = now.getHours();
      const month = now.getMonth() + 1;
      
      if (hour < 12) conversationContext.timeOfDay = 'morning';
      else if (hour < 18) conversationContext.timeOfDay = 'afternoon';
      else conversationContext.timeOfDay = 'evening';
      
      if (month >= 3 && month <= 5) conversationContext.season = 'spring';
      else if (month >= 6 && month <= 8) conversationContext.season = 'summer';
      else if (month >= 9 && month <= 11) conversationContext.season = 'autumn';
      else conversationContext.season = 'winter';
      
      // èˆˆå‘³ã®å­¦ç¿’
      if (analysis.topic && !conversationContext.interests.includes(analysis.topic)) {
        conversationContext.interests.push(analysis.topic);
      }
    }

        // é«˜åº¦ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ãå¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ
    function selectResponsePattern(analysis) {
      try {
        console.log('åˆ†æçµæœ:', analysis);
        
        // ç›¸è«‡ã«å¯¾ã™ã‚‹ç‰¹åˆ¥ãªå¿œç­”
        if (analysis.intent === 'consultation') {
          return getConsultationResponse(analysis);
        }
        
        // æƒ…å ±æä¾›ã«å¯¾ã™ã‚‹å¿œç­”
        if (analysis.intent === 'information') {
          return getInformationResponse(analysis);
        }
        
        // æ„Ÿæƒ…ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ãå¿œç­”
        if (analysis.emotionLevel >= 3) {
          return getHighPositiveResponse(analysis);
        } else if (analysis.emotionLevel <= -3) {
          return getHighNegativeResponse(analysis);
        } else if (analysis.sentiment === 'positive') {
          return getPositiveResponse();
        } else if (analysis.sentiment === 'negative') {
          return getSupportiveResponse();
        }
        
        // è³ªå•ã‚¿ã‚¤ãƒ—ã«åŸºã¥ãè©³ç´°å¿œç­”
        if (analysis.intent === 'question') {
          return getQuestionResponseByType(analysis);
        }
        
        // ç¾åœ¨ã®ãƒˆãƒ”ãƒƒã‚¯ã¨ã®ç¶™ç¶šæ€§
        if (conversationContext.currentTopic && analysis.topic === conversationContext.currentTopic) {
          return getTopicContinuationResponse(analysis);
        }
        
        // æ–°ã—ã„ãƒˆãƒ”ãƒƒã‚¯ã¸ã®å¿œç­”
        if (analysis.topic) {
          return getTopicSpecificResponse(analysis.topic);
        }
        
        // æ„å›³ã«åŸºã¥ãå¿œç­”
        if (analysis.intent === 'request') {
          return getRequestResponse();
        } else if (analysis.intent === 'gratitude') {
          return getGratitudeResponse();
        } else if (analysis.intent === 'greeting') {
          return getGreetingResponse();
        } else if (analysis.intent === 'farewell') {
          return getFarewellResponse();
        }
        
        // å€‹äººçš„ãªæƒ…å ±ã‚’å«ã‚€å ´åˆã®å¿œç­”
        if (analysis.personalInfo) {
          return getPersonalResponse(analysis);
        }
        
        // æ™‚é–“ãƒ»å­£ç¯€ã«åŸºã¥ãå¿œç­”
        return getTimeBasedResponse();
      } catch (error) {
        console.error('å¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã‚¨ãƒ©ãƒ¼:', error);
        return 'ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ';
      }
    }

    // ãƒˆãƒ”ãƒƒã‚¯åˆ¥ã®å¿œç­”
    function getTopicSpecificResponse(topic) {
      const topicResponses = {
        'work': [
          'ä»•äº‹ã«ã¤ã„ã¦ãŠèã‹ã›ãã ã•ã„ã€‚ã©ã‚“ãªã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ',
          'ãŠä»•äº‹ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã§ã—ãŸã‹ï¼Ÿ',
          'ä»•äº‹ã®è©±ã€ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„ã§ã™ã­ã€‚è©³ã—ãæ•™ãˆã¦ãã ã•ã„ã€‚'
        ],
        'hobby': [
          'è¶£å‘³ã®è©±ã€ã¨ã¦ã‚‚æ¥½ã—ã„ã§ã™ã­ï¼ã©ã‚“ãªã“ã¨ãŒå¥½ãã§ã™ã‹ï¼Ÿ',
          'è¶£å‘³ãŒã‚ã‚‹ã¨äººç”ŸãŒè±Šã‹ã«ãªã‚Šã¾ã™ã‚ˆã­ã€‚ä½•ã‹æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ',
          'è¶£å‘³ã®è©±ã‚’èãã®ãŒå¤§å¥½ãã§ã™ã€‚ã‚‚ã£ã¨æ•™ãˆã¦ãã ã•ã„ï¼'
        ],
        'family': [
          'å®¶æ—ã®è©±ã€ã¨ã¦ã‚‚æ¸©ã‹ã¿ãŒã‚ã‚Šã¾ã™ã­ã€‚å¤§åˆ‡ãªå­˜åœ¨ã§ã™ã‚ˆã­ã€‚',
          'å®¶æ—ã¨ã®æ™‚é–“ã€ã¨ã¦ã‚‚è²´é‡ã§ã™ã­ã€‚ã©ã‚“ãªã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ',
          'å®¶æ—ã®ã“ã¨ã‚’å¤§åˆ‡ã«æ€ã†æ°—æŒã¡ã€ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚'
        ],
        'health': [
          'å¥åº·ã¯ä½•ã‚ˆã‚Šå¤§åˆ‡ã§ã™ã­ã€‚ä½“èª¿ç®¡ç†ã¯ã—ã£ã‹ã‚Šã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ',
          'å¥åº·ã«ã¤ã„ã¦è€ƒãˆã‚‹ã®ã¯ã¨ã¦ã‚‚é‡è¦ã§ã™ã€‚ä½•ã‹æ°—ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'å¥åº·ãªä½“ã§ã„ã‚‹ã“ã¨ãŒã€å¹¸ã›ã®åŸºæœ¬ã§ã™ã­ã€‚'
        ]
      };
      
      const responses = topicResponses[topic] || ['ãã®è©±é¡Œã€ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„ã§ã™ã­ã€‚'];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    // ä¸»è¦ãªæ„Ÿæƒ…ã‚’å–å¾—
    function getDominantEmotion(emotions) {
      let maxEmotion = 'neutral';
      let maxValue = 0;
      
      for (const [emotion, value] of Object.entries(emotions)) {
        if (value > maxValue) {
          maxValue = value;
          maxEmotion = emotion;
        }
      }
      
      return maxEmotion;
    }
    
    // æ„Ÿæƒ…åˆ¥ã®å¿œç­”
    function getPositiveResponse() {
      const responses = [
        'ã¨ã¦ã‚‚è‰¯ã„ã§ã™ã­ï¼ãã®æ°—æŒã¡ã€å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚',
        'ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼ç§ã‚‚å¬‰ã—ããªã‚Šã¾ã™ã€‚',
        'ã¨ã¦ã‚‚è‰¯ã„ã“ã¨ãŒã‚ã£ãŸã‚ˆã†ã§ã™ã­ã€‚è©³ã—ãèã‹ã›ã¦ãã ã•ã„ã€‚',
        'ãã®å‰å‘ããªæ°—æŒã¡ã€ã¨ã¦ã‚‚ç´ æ•µã§ã™ï¼',
        'ç´ æ™´ã‚‰ã—ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™ã­ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼',
        'ãã®å–œã³ã®æ°—æŒã¡ã€ã¨ã¦ã‚‚ä¼ã‚ã£ã¦ãã¾ã™ã€‚',
        'è‰¯ã„ã“ã¨ãŒã‚ã£ãŸã‚ˆã†ã§ã€ç§ã‚‚å¬‰ã—ã„ã§ã™ã€‚',
        'ãã®å‰å‘ããªã‚¨ãƒãƒ«ã‚®ãƒ¼ã€ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ã€‚',
        'ã¨ã¦ã‚‚è‰¯ã„ä¸€æ—¥ã«ãªã‚Šãã†ã§ã™ã­ï¼',
        'ãã®æ°—æŒã¡ã€å‘¨ã‚Šã®äººã«ã‚‚ä¼æŸ“ã—ãã†ã§ã™ã­ã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    function getSupportiveResponse() {
      const responses = [
        'å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚',
        'è¾›ã„ã“ã¨ãŒã‚ã£ãŸã‚ˆã†ã§ã™ã­ã€‚è©±ã‚’èã‹ã›ã¦ãã ã•ã„ã€‚',
        'ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã€‚ã„ã¤ã§ã‚‚è©±ã‚’èãã¾ã™ã‚ˆã€‚',
        'ãã®æ°—æŒã¡ã€ã‚ˆãåˆ†ã‹ã‚Šã¾ã™ã€‚ä¸€ç·’ã«è€ƒãˆã¾ã—ã‚‡ã†ã€‚',
        'å¤§å¤‰ã§ã—ãŸã­ã€‚ã‚†ã£ãã‚Šä¼‘ã‚“ã§ãã ã•ã„ã€‚',
        'è¾›ã„æ™‚ã¯ç„¡ç†ã‚’ã—ãªã„ã§ãã ã•ã„ã€‚',
        'ãã®æ°—æŒã¡ã€ã¨ã¦ã‚‚åˆ†ã‹ã‚Šã¾ã™ã€‚',
        'ä¸€äººã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“ã‚ˆã€‚ã„ã¤ã§ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚',
        'å¤§ä¸ˆå¤«ã€ãã£ã¨ä¹—ã‚Šè¶Šãˆã‚‰ã‚Œã¾ã™ã€‚',
        'è¾›ã„æ™‚ã“ãã€è‡ªåˆ†ã‚’å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã­ã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    // æ™‚é–“ãƒ»å­£ç¯€ã«åŸºã¥ãå¿œç­”
    function getTimeBasedResponse() {
      const timeResponses = {
        'morning': [
          'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ä»Šæ—¥ã‚‚ä¸€æ—¥é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚',
          'ãŠã¯ã‚ˆã†ï¼ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã«ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ',
          'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚ä»Šæ—¥ã‚‚ç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚',
          'ãŠã¯ã‚ˆã†ï¼æœã‹ã‚‰å…ƒæ°—ã„ã£ã±ã„ã§ã™ã­ã€‚',
          'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚ä»Šæ—¥ã‚‚æ–°ã—ã„ç™ºè¦‹ãŒã‚ã‚Šã¾ã™ã‚ˆã†ã«ã€‚'
        ],
        'afternoon': [
          'åˆå¾Œã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼',
          'åˆå¾Œã®æ™‚é–“ã€ã„ã‹ãŒãŠéã”ã—ã§ã™ã‹ï¼Ÿ',
          'åˆå¾Œã‚‚å……å®Ÿã—ãŸæ™‚é–“ã«ã—ã¾ã—ã‚‡ã†ã€‚',
          'åˆå¾Œã®æ™‚é–“ã€ä½•ã‹æ¥½ã—ã„ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'åˆå¾Œã‚‚å…ƒæ°—ã«éã”ã—ã¾ã—ã‚‡ã†ï¼'
        ],
        'evening': [
          'ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ä»Šæ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚',
          'ä¸€æ—¥ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ã‚†ã£ãã‚Šä¼‘ã‚“ã§ãã ã•ã„ã­ã€‚',
          'ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã§ã—ãŸã‹ï¼Ÿ',
          'ä¸€æ—¥ã®çµ‚ã‚ã‚Šã€ã‚†ã£ãã‚Šãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚',
          'ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚æ˜æ—¥ã‚‚è‰¯ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚'
        ]
      };
      
      const seasonResponses = {
        'spring': [
          'æ˜¥ã‚‰ã—ã„æ°—æŒã¡ã®è‰¯ã„ä¸€æ—¥ã§ã™ã­ã€‚',
          'æ˜¥ã®é¢¨ãŒå¿ƒåœ°ã‚ˆã„å­£ç¯€ã§ã™ã­ã€‚',
          'æ¡œã®å­£ç¯€ã€ã¨ã¦ã‚‚ç¾ã—ã„ã§ã™ã­ã€‚',
          'æ˜¥ã®é™½æ°—ã€éã”ã—ã‚„ã™ã„ã§ã™ã­ã€‚',
          'æ˜¥ã®è¨ªã‚Œã‚’æ„Ÿã˜ã‚‹å­£ç¯€ã§ã™ã­ã€‚'
        ],
        'summer': [
          'å¤ã®æš‘ã•ã€ä½“èª¿ç®¡ç†ã«æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚',
          'å¤ã®æ—¥å·®ã—ã€ã¨ã¦ã‚‚å¼·ã„ã§ã™ã­ã€‚',
          'å¤ã®é¢¨ç‰©è©©ã€æ¥½ã—ã‚“ã§ã„ã¾ã™ã‹ï¼Ÿ',
          'å¤ã®æš‘ã•ã€æ°´åˆ†è£œçµ¦ã‚’å¿˜ã‚Œãšã«ã€‚',
          'å¤ã®å­£ç¯€ã€ä½•ã‹æ¥½ã—ã„äºˆå®šã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ'
        ],
        'autumn': [
          'ç§‹ã®æ¶¼ã—ã•ã€éã”ã—ã‚„ã™ã„å­£ç¯€ã§ã™ã­ã€‚',
          'ç§‹ã®ç´…è‘‰ã€ã¨ã¦ã‚‚ç¾ã—ã„ã§ã™ã­ã€‚',
          'ç§‹ã®é¢¨ã€å¿ƒåœ°ã‚ˆã„ã§ã™ã­ã€‚',
          'ç§‹ã®å­£ç¯€ã€ä½•ã‹æ¥½ã—ã¿ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ç§‹ã®å¤œé•·ã€ã‚†ã£ãã‚Šéã”ã—ã¾ã—ã‚‡ã†ã€‚'
        ],
        'winter': [
          'å†¬ã®å¯’ã•ã€æ¸©ã‹ãã—ã¦ãŠéã”ã—ãã ã•ã„ã€‚',
          'å†¬ã®å­£ç¯€ã€æ¸©ã‹ã„é£²ã¿ç‰©ãŒç¾å‘³ã—ã„ã§ã™ã­ã€‚',
          'å†¬ã®å¯’ã•ã€ä½“èª¿ç®¡ç†ã«æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚',
          'å†¬ã®å­£ç¯€ã€ä½•ã‹æ¥½ã—ã¿ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'å†¬ã®å¯’ã•ã€æ˜¥ãŒå¾…ã¡é ã—ã„ã§ã™ã­ã€‚'
        ]
      };
      
      // ãƒ©ãƒ³ãƒ€ãƒ ã«æ™‚é–“ã¨å­£ç¯€ã®å¿œç­”ã‚’é¸æŠ
      const timeResponse = timeResponses[conversationContext.timeOfDay] || timeResponses['afternoon'];
      const seasonResponse = seasonResponses[conversationContext.season] || seasonResponses['summer'];
      
      return timeResponse[Math.floor(Math.random() * timeResponse.length)] + ' ' + 
             seasonResponse[Math.floor(Math.random() * seasonResponse.length)];
    }

    function generateConversationPatterns() {
      const greetings = [
        // åŸºæœ¬æŒ¨æ‹¶
        "ã“ã‚“ã«ã¡ã¯", "ã‚„ã‚", "ãŠå…ƒæ°—ã§ã™ã‹", "ã“ã‚“ã°ã‚“ã¯", "ãŠã¯ã‚ˆã†", "ã¯ã˜ã‚ã¾ã—ã¦",
        "ä¹…ã—ã¶ã‚Š", "ãŠç–²ã‚Œæ§˜", "ã‚ˆã‚ã—ã", "ã©ã†ã‚‚", "ã‚„ã£ã»ãƒ¼", "ãŠã£ã™",
        "ã“ã‚“ã«ã¡ã¯ï¼", "ã‚„ã‚ï¼", "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿ", "ã“ã‚“ã°ã‚“ã¯ï¼", "ãŠã¯ã‚ˆã†ï¼", "ã¯ã˜ã‚ã¾ã—ã¦ï¼",
        "ä¹…ã—ã¶ã‚Šï¼", "ãŠç–²ã‚Œæ§˜ï¼", "ã‚ˆã‚ã—ãï¼", "ã©ã†ã‚‚ï¼", "ã‚„ã£ã»ãƒ¼ï¼", "ãŠã£ã™ï¼",
        "ã“ã‚“ã«ã¡ã¯ã€œ", "ã‚„ã‚ã€œ", "ãŠå…ƒæ°—ã§ã™ã‹ã€œ", "ã“ã‚“ã°ã‚“ã¯ã€œ", "ãŠã¯ã‚ˆã†ã€œ", "ã¯ã˜ã‚ã¾ã—ã¦ã€œ",
        "ä¹…ã—ã¶ã‚Šã€œ", "ãŠç–²ã‚Œæ§˜ã€œ", "ã‚ˆã‚ã—ãã€œ", "ã©ã†ã‚‚ã€œ", "ã‚„ã£ã»ãƒ¼ã€œ", "ãŠã£ã™ã€œ",
        
        // æ™‚é–“å¸¯åˆ¥æŒ¨æ‹¶
        "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™", "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼", "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€œ",
        "ã“ã‚“ã«ã¡ã¯ã”ã–ã„ã¾ã™", "ã“ã‚“ã«ã¡ã¯ã”ã–ã„ã¾ã™ï¼", "ã“ã‚“ã«ã¡ã¯ã”ã–ã„ã¾ã™ã€œ",
        "ã“ã‚“ã°ã‚“ã¯ã”ã–ã„ã¾ã™", "ã“ã‚“ã°ã‚“ã¯ã”ã–ã„ã¾ã™ï¼", "ã“ã‚“ã°ã‚“ã¯ã”ã–ã„ã¾ã™ã€œ",
        "ãŠã‚„ã™ã¿ãªã•ã„", "ãŠã‚„ã™ã¿ãªã•ã„ï¼", "ãŠã‚„ã™ã¿ãªã•ã„ã€œ",
        
        // ä¸å¯§ãªæŒ¨æ‹¶
        "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›", "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ï¼", "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€œ",
        "ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™", "ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ï¼", "ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€œ",
        "ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™", "ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ï¼", "ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€œ",
        
        // ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªæŒ¨æ‹¶
        "ã‚ˆã£", "ã‚ˆã£ï¼", "ã‚ˆã£ã€œ", "ã‚„ã£ã»ãƒ¼", "ã‚„ã£ã»ãƒ¼ï¼", "ã‚„ã£ã»ãƒ¼ã€œ",
        "ãŠã£ã™", "ãŠã£ã™ï¼", "ãŠã£ã™ã€œ", "ã‚ˆã‚ã—ã", "ã‚ˆã‚ã—ãï¼", "ã‚ˆã‚ã—ãã€œ",
        
        // å­£ç¯€ã®æŒ¨æ‹¶
        "æ˜¥ã§ã™ã­", "æ˜¥ã§ã™ã­ï¼", "æ˜¥ã§ã™ã­ã€œ", "å¤ã§ã™ã­", "å¤ã§ã™ã­ï¼", "å¤ã§ã™ã­ã€œ",
        "ç§‹ã§ã™ã­", "ç§‹ã§ã™ã­ï¼", "ç§‹ã§ã™ã­ã€œ", "å†¬ã§ã™ã­", "å†¬ã§ã™ã­ï¼", "å†¬ã§ã™ã­ã€œ",
        
        // å¤©æ°—ã®æŒ¨æ‹¶
        "ã„ã„å¤©æ°—ã§ã™ã­", "ã„ã„å¤©æ°—ã§ã™ã­ï¼", "ã„ã„å¤©æ°—ã§ã™ã­ã€œ",
        "é›¨ã§ã™ã­", "é›¨ã§ã™ã­ï¼", "é›¨ã§ã™ã­ã€œ", "é›ªã§ã™ã­", "é›ªã§ã™ã­ï¼", "é›ªã§ã™ã­ã€œ",
        
        // æ™‚é–“ã®æŒ¨æ‹¶
        "æ—©ã„ã§ã™ã­", "æ—©ã„ã§ã™ã­ï¼", "æ—©ã„ã§ã™ã­ã€œ", "é…ã„ã§ã™ã­", "é…ã„ã§ã™ã­ï¼", "é…ã„ã§ã™ã­ã€œ",
        "ãŠç–²ã‚Œæ§˜ã§ã™", "ãŠç–²ã‚Œæ§˜ã§ã™ï¼", "ãŠç–²ã‚Œæ§˜ã§ã™ã€œ", "ãŠç–²ã‚Œæ§˜ã§ã—ãŸ", "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼", "ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€œ"
      ];

      const topics = [
        // æ—¥å¸¸ç”Ÿæ´»
        "ä»Šæ—¥ã®å¤©æ°—", "æœ€è¿‘ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹", "ãŠæ°—ã«å…¥ã‚Šã®æ˜ ç”»", "å¥½ããªéŸ³æ¥½", "è¶£å‘³", "ä»•äº‹",
        "å­¦æ ¡", "å®¶æ—", "å‹é”", "æ—…è¡Œ", "é£Ÿã¹ç‰©", "ã‚¹ãƒãƒ¼ãƒ„", "èª­æ›¸", "ã‚²ãƒ¼ãƒ ",
        "æ˜ ç”»", "ãƒ†ãƒ¬ãƒ“", "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ", "SNS", "è²·ã„ç‰©", "æ–™ç†", "æƒé™¤", "æ´—æ¿¯",
        "æ•£æ­©", "ãƒ‰ãƒ©ã‚¤ãƒ–", "ã‚«ãƒ•ã‚§", "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³", "å…¬åœ’", "æµ·", "å±±", "è¡—",
        "å­£ç¯€", "èŠ±", "å‹•ç‰©", "è»Š", "é›»è»Š", "ãƒã‚¹", "é£›è¡Œæ©Ÿ", "èˆ¹", "è‡ªè»¢è»Š",
        "ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³", "ãƒ‘ã‚½ã‚³ãƒ³", "ãƒ†ãƒ¬ãƒ“", "ã‚¨ã‚¢ã‚³ãƒ³", "æ´—æ¿¯æ©Ÿ", "å†·è”µåº«",
        
        // ä»•äº‹ãƒ»å­¦ç¿’
        "ä¼šè­°", "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "ãƒ¬ãƒãƒ¼ãƒˆ", "ãƒ†ã‚¹ãƒˆ", "è©¦é¨“", "å®¿é¡Œ", "èª²é¡Œ",
        "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", "ä¼ç”»", "ã‚¢ã‚¤ãƒ‡ã‚¢", "è¨ˆç”»", "ç›®æ¨™", "å¤¢", "å°†æ¥", "ã‚­ãƒ£ãƒªã‚¢",
        "ã‚¹ã‚­ãƒ«", "è³‡æ ¼", "å‹‰å¼·", "å­¦ç¿’", "ç ”ç©¶", "èª¿æŸ»", "åˆ†æ", "ãƒ‡ãƒ¼ã‚¿",
        "å ±å‘Šæ›¸", "ææ¡ˆæ›¸", "å¥‘ç´„æ›¸", "ãƒãƒ‹ãƒ¥ã‚¢ãƒ«", "ã‚¬ã‚¤ãƒ‰", "èª¬æ˜æ›¸", "æ‰‹é †æ›¸",
        
        // è¶£å‘³ãƒ»å¨¯æ¥½
        "ã‚¢ãƒ‹ãƒ¡", "æ¼«ç”»", "å°èª¬", "è©©", "çµµç”»", "å†™çœŸ", "ã‚«ãƒ¡ãƒ©", "æ¥½å™¨", "æ­Œ",
        "ãƒ€ãƒ³ã‚¹", "ãƒ¨ã‚¬", "ãƒ”ãƒ©ãƒ†ã‚£ã‚¹", "ã‚¸ãƒ ", "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°", "ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°", "æ°´æ³³",
        "ãƒ†ãƒ‹ã‚¹", "ã‚µãƒƒã‚«ãƒ¼", "é‡çƒ", "ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«", "ã‚´ãƒ«ãƒ•", "ã‚¹ã‚­ãƒ¼", "ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰",
        "é‡£ã‚Š", "ã‚­ãƒ£ãƒ³ãƒ—", "ç™»å±±", "ãƒã‚¤ã‚­ãƒ³ã‚°", "ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°", "ã‚¹ã‚±ãƒ¼ãƒˆ", "ãƒœã‚¦ãƒªãƒ³ã‚°",
        
        // é£Ÿã¹ç‰©ãƒ»é£²ã¿ç‰©
        "æ—¥æœ¬æ–™ç†", "ä¸­è¯æ–™ç†", "ã‚¤ã‚¿ãƒªã‚¢ãƒ³", "ãƒ•ãƒ¬ãƒ³ãƒ", "ã‚¨ã‚¹ãƒ‹ãƒƒã‚¯", "å’Œè“å­", "æ´‹è“å­",
        "ãƒ‘ãƒ³", "ãƒ‘ã‚¹ã‚¿", "ãƒ”ã‚¶", "å¯¿å¸", "ãƒ©ãƒ¼ãƒ¡ãƒ³", "ã†ã©ã‚“", "ãã°", "ã‚«ãƒ¬ãƒ¼",
        "ã‚³ãƒ¼ãƒ’ãƒ¼", "ç´…èŒ¶", "ç·‘èŒ¶", "ã‚¸ãƒ¥ãƒ¼ã‚¹", "ãƒ¯ã‚¤ãƒ³", "ãƒ“ãƒ¼ãƒ«", "æ—¥æœ¬é…’",
        "ç„¼è‚‰", "ã—ã‚ƒã¶ã—ã‚ƒã¶", "å¤©ã·ã‚‰", "ã¨ã‚“ã‹ã¤", "ã‚ªãƒ ãƒ©ã‚¤ã‚¹", "ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼",
        
        // å ´æ‰€ãƒ»è¦³å…‰
        "æ±äº¬", "å¤§é˜ª", "äº¬éƒ½", "æ¨ªæµœ", "åå¤å±‹", "æœ­å¹Œ", "ç¦å²¡", "ç¥æˆ¸", "ä»™å°",
        "æ²–ç¸„", "åŒ—æµ·é“", "æ±åŒ—", "é–¢æ±", "ä¸­éƒ¨", "é–¢è¥¿", "ä¸­å›½", "å››å›½", "ä¹å·",
        "æµ…è‰å¯º", "æ¸…æ°´å¯º", "é‡‘é–£å¯º", "éŠ€é–£å¯º", "æ±å¤§å¯º", "æ³•éš†å¯º", "å³å³¶ç¥ç¤¾",
        "å¯Œå£«å±±", "ç®±æ ¹", "æ—¥å…‰", "è»½äº•æ²¢", "ä¼Šè±†", "ç†±æµ·", "æ¹¯æ²³åŸ", "ç”±å¸ƒé™¢",
        
        // å­£ç¯€ãƒ»è‡ªç„¶
        "æ¡œ", "æ¢…", "æ¡ƒ", "è—¤", "ã‚¢ã‚¸ã‚µã‚¤", "ã²ã¾ã‚ã‚Š", "ã‚³ã‚¹ãƒ¢ã‚¹", "èŠ", "ç´…è‘‰",
        "æ˜¥é¢¨", "å¤ç©º", "ç§‹ç©º", "å†¬ç©º", "æœæ—¥", "å¤•æ—¥", "æ˜Ÿç©º", "æœˆ", "é›²",
        "é›¨", "é›ª", "é›·", "è™¹", "éœ§", "éœœ", "éœ²", "é¢¨", "æ³¢", "æ½®",
        
        // æ„Ÿæƒ…ãƒ»å¿ƒç†
        "å–œã³", "æ‚²ã—ã¿", "æ€’ã‚Š", "é©šã", "æã‚Œ", "æœŸå¾…", "å¸Œæœ›", "ä¸å®‰", "ç·Šå¼µ",
        "ãƒªãƒ©ãƒƒã‚¯ã‚¹", "èˆˆå¥®", "è½ã¡è¾¼ã¿", "ã‚„ã‚‹æ°—", "ã‚„ã‚‹æ°—å–ªå¤±", "è‡ªä¿¡", "è‡ªä¿¡å–ªå¤±",
        "æ„Ÿè¬", "å¾Œæ‚”", "åçœ", "æˆé•·", "å¤‰åŒ–", "é€²æ­©", "åœæ»", "é€€æ­©",
        
        // äººé–“é–¢ä¿‚
        "æ‹æ„›", "å‹æƒ…", "æ„›æƒ…", "ä¿¡é ¼", "å°Šæ•¬", "æ†§ã‚Œ", "å«‰å¦¬", "ç¾¨æœ›", "åŒæƒ…",
        "å…±æ„Ÿ", "ç†è§£", "èª¤è§£", "å’Œè§£", "ä»²ç›´ã‚Š", "åˆ¥ã‚Œ", "å‡ºä¼šã„", "å†ä¼š",
        "çµå©š", "é›¢å©š", "å‡ºç”£", "è‚²å…", "å­è‚²ã¦", "ä»‹è­·", "çœ‹è­·", "çœ‹è­·",
        
        // ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼
        "AI", "æ©Ÿæ¢°å­¦ç¿’", "ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°", "ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³", "IoT", "5G", "6G",
        "VR", "AR", "MR", "ãƒ¡ã‚¿ãƒãƒ¼ã‚¹", "NFT", "æš—å·é€šè²¨", "ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³", "ã‚¤ãƒ¼ã‚µãƒªã‚¢ãƒ ",
        "ã‚¯ãƒ©ã‚¦ãƒ‰", "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£", "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼", "ãƒ‡ãƒ¼ã‚¿ä¿è­·", "ã‚µã‚¤ãƒãƒ¼æ”»æ’ƒ",
        
        // ç¤¾ä¼šãƒ»æ–‡åŒ–
        "æ”¿æ²»", "çµŒæ¸ˆ", "ç¤¾ä¼š", "æ–‡åŒ–", "æ­´å²", "ä¼çµ±", "ç¾ä»£", "æœªæ¥", "éå»",
        "ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–", "å¤šæ§˜æ€§", "ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³", "ã‚µã‚¹ãƒ†ãƒŠãƒ“ãƒªãƒ†ã‚£", "ç’°å¢ƒå•é¡Œ",
        "è²§å›°", "æ ¼å·®", "å·®åˆ¥", "äººæ¨©", "è‡ªç”±", "å¹³ç­‰", "æ­£ç¾©", "å¹³å’Œ"
      ];

      const responses = [
        // è‚¯å®šçš„ãƒ»å…±æ„Ÿçš„
        "ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„ã§ã™ã­", "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„ã§ã™", "ãªã‚‹ã»ã©ã€é¢ç™½ã„ã§ã™", "ç¢ºã‹ã«ãã†ã§ã™ã­",
        "ç§ã‚‚åŒã˜ã‚ˆã†ã«æ€ã„ã¾ã™", "ãã‚Œã¯è‰¯ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã­", "å‹‰å¼·ã«ãªã‚Šã¾ã™", "å‚è€ƒã«ãªã‚Šã¾ã™",
        "ç´ æ•µã§ã™ã­", "æ¥½ã—ã„ã§ã™ã­", "é¢ç™½ãã†ã§ã™ã­", "ã‚„ã£ã¦ã¿ãŸã„ã§ã™ã­", "é ‘å¼µã£ã¦ãã ã•ã„",
        "å¿œæ´ã—ã¦ã„ã¾ã™", "æœŸå¾…ã—ã¦ã„ã¾ã™", "æ¥½ã—ã¿ã§ã™ã­", "è‰¯ã‹ã£ãŸã§ã™ã­", "ãŠç–²ã‚Œæ§˜ã§ã—ãŸ",
        "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™", "ãŠæ°—ã®æ¯’ã§ã™", "å¤§å¤‰ã§ã—ãŸã­", "å¿ƒé…ã§ã™ã­", "å®‰å¿ƒã—ã¾ã—ãŸ",
        "é©šãã¾ã—ãŸ", "ã³ã£ãã‚Šã—ã¾ã—ãŸ", "æ„Ÿå‹•ã—ã¾ã—ãŸ", "å¬‰ã—ã„ã§ã™", "æ‚²ã—ã„ã§ã™", "æ€’ã£ã¦ã„ã¾ã™",
        "å›°ã£ã¦ã„ã¾ã™", "æ‚©ã‚“ã§ã„ã¾ã™", "è¿·ã£ã¦ã„ã¾ã™", "æ±ºã‚ã¾ã—ãŸ", "å¤‰ã‚ã‚Šã¾ã—ãŸ", "é€²æ­©ã—ã¾ã—ãŸ",
        
        // ã‚ˆã‚Šè©³ç´°ãªåå¿œ
        "æœ¬å½“ã«ç´ æ™´ã‚‰ã—ã„ã§ã™ã­", "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™", "ã¨ã¦ã‚‚è‰¯ã„è€ƒãˆã§ã™ã­",
        "ç§ã‚‚åŒã˜ã‚ˆã†ãªçµŒé¨“ãŒã‚ã‚Šã¾ã™", "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„é¸æŠã§ã™ã­", "ã¨ã¦ã‚‚è‰¯ã„åˆ¤æ–­ã ã¨æ€ã„ã¾ã™",
        "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„æˆæœã§ã™ã­", "ã¨ã¦ã‚‚è‰¯ã„çµæœã ã¨æ€ã„ã¾ã™", "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„ç™ºè¦‹ã§ã™ã­",
        "ã¨ã¦ã‚‚è‰¯ã„æ©Ÿä¼šã§ã™ã­", "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„ãƒãƒ£ãƒ³ã‚¹ã§ã™ã­", "ã¨ã¦ã‚‚è‰¯ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã­",
        "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„åŠªåŠ›ã§ã™ã­", "ã¨ã¦ã‚‚è‰¯ã„é ‘å¼µã‚Šã§ã™ã­", "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„æˆé•·ã§ã™ã­",
        "ã¨ã¦ã‚‚è‰¯ã„å¤‰åŒ–ã§ã™ã­", "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„é€²æ­©ã§ã™ã­", "ã¨ã¦ã‚‚è‰¯ã„ç™ºå±•ã§ã™ã­",
        
        // è³ªå•ãƒ»èˆˆå‘³
        "è©³ã—ãæ•™ãˆã¦ãã ã•ã„", "ã‚‚ã£ã¨è©³ã—ãèã‹ã›ã¦ãã ã•ã„", "ãã‚Œã¯ã©ã†ã„ã†ã“ã¨ã§ã™ã‹",
        "ã©ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã—ãŸã‹", "ã©ã‚“ãªé¢¨ã«æ€ã„ã¾ã—ãŸã‹", "ã©ã®ã‚ˆã†ãªå°è±¡ã§ã—ãŸã‹",
        "ãã‚Œã¯ã„ã¤é ƒã®ã“ã¨ã§ã™ã‹", "ã©ã“ã§ä½“é¨“ã•ã‚ŒãŸã®ã§ã™ã‹", "èª°ã¨ä¸€ç·’ã§ã—ãŸã‹",
        "ã©ã®ã‚ˆã†ãªçŠ¶æ³ã§ã—ãŸã‹", "ã©ã‚“ãªæ°—æŒã¡ã§ã—ãŸã‹", "ã©ã®ã‚ˆã†ãªå½±éŸ¿ãŒã‚ã‚Šã¾ã—ãŸã‹",
        
        // åŠ±ã¾ã—ãƒ»å¿œæ´
        "ãã£ã¨å¤§ä¸ˆå¤«ã§ã™", "å¿…ãšã†ã¾ãã„ãã¾ã™", "ã‚ãªãŸãªã‚‰ã§ãã¾ã™",
        "é ‘å¼µã£ã¦ãã ã•ã„", "å¿œæ´ã—ã¦ã„ã¾ã™", "æœŸå¾…ã—ã¦ã„ã¾ã™", "ä¿¡ã˜ã¦ã„ã¾ã™",
        "ä¸€æ­©ãšã¤é€²ã¿ã¾ã—ã‚‡ã†", "ç„¦ã‚‰ãšã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†", "ç„¡ç†ã‚’ã—ãªã„ã§ãã ã•ã„",
        "ä¼‘æ†©ã‚‚å¤§åˆ‡ã§ã™", "ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„", "ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ãã ã•ã„",
        
        // å…±æ„Ÿãƒ»ç†è§£
        "ãã‚Œã¯å¤§å¤‰ã§ã—ãŸã­", "ãŠç–²ã‚Œæ§˜ã§ã—ãŸ", "ã‚ˆãé ‘å¼µã‚Šã¾ã—ãŸã­",
        "ãã‚Œã¯è¾›ã‹ã£ãŸã§ã—ã‚‡ã†", "ãã‚Œã¯è‹¦ã—ã‹ã£ãŸã§ã—ã‚‡ã†", "ãã‚Œã¯æ‚²ã—ã‹ã£ãŸã§ã—ã‚‡ã†",
        "ãã‚Œã¯å¬‰ã—ã‹ã£ãŸã§ã—ã‚‡ã†", "ãã‚Œã¯æ¥½ã—ã‹ã£ãŸã§ã—ã‚‡ã†", "ãã‚Œã¯é¢ç™½ã‹ã£ãŸã§ã—ã‚‡ã†",
        "ãã‚Œã¯é©šãã§ã—ãŸã­", "ãã‚Œã¯ã³ã£ãã‚Šã§ã—ãŸã­", "ãã‚Œã¯æ„Ÿå‹•çš„ã§ã—ãŸã­",
        
        // ææ¡ˆãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
        "è©¦ã—ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã™ã‹", "ã‚„ã£ã¦ã¿ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™", "ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã¦ãã ã•ã„",
        "æ™‚é–“ã‚’ã‹ã‘ã¦è€ƒãˆã¦ã¿ã¦ãã ã•ã„", "ã‚†ã£ãã‚Šé€²ã‚ã¦ã¿ã¦ãã ã•ã„", "ç„¦ã‚‰ãšã«å–ã‚Šçµ„ã‚“ã§ãã ã•ã„",
        "ä»–ã®æ–¹æ³•ã‚‚è€ƒãˆã¦ã¿ã¦ãã ã•ã„", "åˆ¥ã®è§’åº¦ã‹ã‚‰è¦‹ã¦ã¿ã¦ãã ã•ã„", "æ–°ã—ã„è¦–ç‚¹ã§è€ƒãˆã¦ã¿ã¦ãã ã•ã„",
        
        // è©•ä¾¡ãƒ»æ„Ÿæƒ³
        "ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ã­", "ã¨ã¦ã‚‚è‰¯ã„ã¨æ€ã„ã¾ã™", "ç´ æ•µã ã¨æ€ã„ã¾ã™",
        "ãã‚Œã¯èˆˆå‘³æ·±ã„ã§ã™ã­", "é¢ç™½ãã†ã§ã™ã­", "ã‚„ã£ã¦ã¿ãŸã„ã§ã™ã­",
        "ãã‚Œã¯è‰¯ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã­", "ã¨ã¦ã‚‚è‰¯ã„è€ƒãˆã ã¨æ€ã„ã¾ã™", "ç´ æ™´ã‚‰ã—ã„ç™ºæƒ³ã§ã™ã­",
        "ãã‚Œã¯è‰¯ã„çµŒé¨“ã§ã™ã­", "ã¨ã¦ã‚‚è‰¯ã„æ€ã„å‡ºã«ãªã‚Šãã†ã§ã™ã­", "ç´ æ•µãªæ™‚é–“ã«ãªã‚Šãã†ã§ã™ã­"
      ];

      const emotions = [
        // ç¬‘é¡”ãƒ»å–œã³
        "ğŸ˜Š", "ğŸ˜„", "ğŸ˜ƒ", "ğŸ˜€", "ğŸ˜", "ğŸ˜†", "ğŸ˜…", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜‡",
        "ğŸ™‚", "ğŸ™ƒ", "ğŸ˜‰", "ğŸ˜Œ", "ğŸ˜", "ğŸ¥°", "ğŸ˜˜", "ğŸ˜—", "ğŸ˜™", "ğŸ˜š",
        "ğŸ˜‹", "ğŸ˜›", "ğŸ˜", "ğŸ˜œ", "ğŸ¤ª", "ğŸ¤¨", "ğŸ§", "ğŸ¤“", "ğŸ˜", "ğŸ¤©",
        "ğŸ¥³", "ğŸ˜", "ğŸ˜’", "ğŸ˜", "ğŸ˜”", "ğŸ˜Ÿ", "ğŸ˜•", "ğŸ™", "â˜¹ï¸", "ğŸ˜£",
        "ğŸ˜–", "ğŸ˜«", "ğŸ˜©", "ğŸ¥º", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜¤", "ğŸ˜ ", "ğŸ˜¡", "ğŸ¤¬",
        "ğŸ¤¯", "ğŸ˜³", "ğŸ¥µ", "ğŸ¥¶", "ğŸ˜±", "ğŸ˜¨", "ğŸ˜°", "ğŸ˜¥", "ğŸ˜“", "ğŸ¤—",
        "ğŸ¤”", "ğŸ¤­", "ğŸ¤«", "ğŸ¤¥", "ğŸ˜¶", "ğŸ˜", "ğŸ˜‘", "ğŸ˜¯", "ğŸ˜¦", "ğŸ˜§",
        
        // ç¥ç¦ãƒ»æˆåŠŸ
        "âœ¨", "ğŸ‰", "ğŸ’ª", "ğŸŒŸ", "ğŸ’–", "ğŸµ", "ğŸŒˆ", "ğŸ€", "ğŸŠ", "ğŸˆ",
        "ğŸ", "ğŸ‚", "ğŸƒ", "ğŸ„", "ğŸ‹", "ğŸ", "ğŸ", "ğŸ", "ğŸ", "ğŸ‘",
        "ğŸ€", "ğŸ", "ğŸ‚", "ğŸƒ", "ğŸ„", "ğŸ‹", "ğŸ", "ğŸ", "ğŸ", "ğŸ",
        
        // å‹•ç‰©ãƒ»è‡ªç„¶
        "ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯",
        "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ”", "ğŸ§", "ğŸ¦", "ğŸ¤", "ğŸ£",
        "ğŸ¦†", "ğŸ¦…", "ğŸ¦‰", "ğŸ¦‡", "ğŸº", "ğŸ—", "ğŸ´", "ğŸ¦„", "ğŸ", "ğŸ›",
        "ğŸ¦‹", "ğŸŒ", "ğŸ", "ğŸœ", "ğŸ¦Ÿ", "ğŸ¦—", "ğŸ•·ï¸", "ğŸ•¸ï¸", "ğŸ¦‚", "ğŸ¢",
        "ğŸ", "ğŸ¦", "ğŸ¦–", "ğŸ¦•", "ğŸ™", "ğŸ¦‘", "ğŸ¦", "ğŸ¦", "ğŸ¦€", "ğŸ¡",
        "ğŸ ", "ğŸŸ", "ğŸ¬", "ğŸ³", "ğŸ‹", "ğŸ¦ˆ", "ğŸŠ", "ğŸ…", "ğŸ†", "ğŸ¦“",
        
        // é£Ÿã¹ç‰©ãƒ»é£²ã¿ç‰©
        "ğŸ", "ğŸ", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ‰", "ğŸ‡", "ğŸ“", "ğŸ«", "ğŸˆ",
        "ğŸ’", "ğŸ‘", "ğŸ¥­", "ğŸ", "ğŸ¥¥", "ğŸ¥", "ğŸ…", "ğŸ¥‘", "ğŸ¥¦", "ğŸ¥¬",
        "ğŸ¥’", "ğŸŒ¶ï¸", "ğŸ«‘", "ğŸŒ½", "ğŸ¥•", "ğŸ«’", "ğŸ§„", "ğŸ§…", "ğŸ¥”", "ğŸ ",
        "ğŸ¥", "ğŸ¥¯", "ğŸ", "ğŸ¥–", "ğŸ¥¨", "ğŸ§€", "ğŸ¥š", "ğŸ³", "ğŸ§ˆ", "ğŸ¥",
        "ğŸ§‡", "ğŸ¥“", "ğŸ¥©", "ğŸ—", "ğŸ–", "ğŸ¦´", "ğŸŒ­", "ğŸ”", "ğŸŸ", "ğŸ•",
        
        // æ´»å‹•ãƒ»ã‚¹ãƒãƒ¼ãƒ„
        "âš½", "ğŸ€", "ğŸˆ", "âš¾", "ğŸ¥", "ğŸ¾", "ğŸ", "ğŸ‰", "ğŸ¥", "ğŸ±",
        "ğŸª€", "ğŸ“", "ğŸ¸", "ğŸ’", "ğŸ‘", "ğŸ¥", "ğŸ", "ğŸ¥…", "â›³", "ğŸª",
        "ğŸ¹", "ğŸ£", "ğŸ¤¿", "ğŸ¥Š", "ğŸ¥‹", "ğŸ½", "ğŸ›¹", "ğŸ›·ï¸", "â›¸ï¸", "ğŸ¥Œ",
        "ğŸ¿", "â›·ï¸", "ğŸ‚", "ğŸª‚", "ğŸ‹ï¸â€â™€ï¸", "ğŸ‹ï¸â€â™‚ï¸", "ğŸ¤¼â€â™€ï¸", "ğŸ¤¼â€â™‚ï¸", "ğŸ¤¸â€â™€ï¸", "ğŸ¤¸â€â™‚ï¸",
        "â›¹ï¸â€â™€ï¸", "â›¹ï¸â€â™‚ï¸", "ğŸ¤º", "ğŸ¤¾â€â™€ï¸", "ğŸ¤¾â€â™‚ï¸", "ğŸŠâ€â™€ï¸", "ğŸŠâ€â™‚ï¸", "ğŸš£â€â™€ï¸", "ğŸš£â€â™‚ï¸", "ğŸ§˜â€â™€ï¸",
        
        // ä¹—ã‚Šç‰©ãƒ»äº¤é€š
        "ğŸš—", "ğŸš•", "ğŸš™", "ğŸšŒ", "ğŸš", "ğŸï¸", "ğŸš“", "ğŸš‘", "ğŸš’", "ğŸš",
        "ğŸšš", "ğŸš›", "ğŸšœ", "ğŸ›´ï¸", "ğŸš²", "ğŸ›µ", "ğŸï¸", "ğŸš¨", "ğŸš”", "ğŸš",
        "ğŸš˜", "ğŸš–", "ğŸš¡", "ğŸš ", "ğŸšŸ", "ğŸšƒ", "ğŸš‹", "ğŸš", "ğŸš", "ğŸš„",
        "ğŸš…", "ğŸšˆ", "ğŸš‚", "ğŸš†", "ğŸš‡", "ğŸšŠ", "ğŸš‰", "âœˆï¸", "ğŸ›«", "ğŸ›¬",
        "ğŸ›©ï¸", "ğŸ’º", "ğŸ›°ï¸", "ğŸš€", "ğŸ›¸ï¸", "ğŸš", "ğŸ›»", "ğŸšœ", "ğŸï¸", "ğŸï¸",
        
        // å ´æ‰€ãƒ»å»ºç‰©
        "ğŸ ", "ğŸ¡", "ğŸ˜ï¸", "ğŸšï¸", "ğŸ—ï¸", "ğŸ­", "ğŸ¢", "ğŸ¬", "ğŸ£", "ğŸ¤",
        "ğŸ¥", "ğŸ¦", "ğŸ¨", "ğŸª", "ğŸ«", "ğŸ©", "ğŸ’’", "â›ª", "ğŸ•Œ", "ğŸ•",
        "ğŸ›•", "â›©ï¸", "ğŸ•‹", "â›²", "â›º", "ğŸ•ï¸", "ğŸ–ï¸", "ğŸœï¸", "ğŸï¸", "ğŸ”ï¸",
        "â›°ï¸", "ğŸŒ‹", "ğŸ—»", "ğŸ•ï¸", "ğŸ–ï¸", "ğŸœï¸", "ğŸï¸", "ğŸ”ï¸", "â›°ï¸", "ğŸŒ‹",
        
        // å¤©æ°—ãƒ»è‡ªç„¶ç¾è±¡
        "â˜€ï¸", "ğŸŒ¤ï¸", "â›…", "ğŸŒ¥ï¸", "â˜ï¸", "ğŸŒ¦ï¸", "ğŸŒ§ï¸", "â›ˆï¸", "ğŸŒ©ï¸", "ğŸŒ¨ï¸",
        "ğŸ’§", "ğŸ’¦", "ğŸ’¨", "ğŸŒªï¸", "ğŸŒˆ", "â˜‚ï¸", "â˜”", "âš¡", "â„ï¸", "ğŸ”¥",
        "ğŸ’¥", "ğŸ’«", "â­", "ğŸŒŸ", "âœ¨", "âš¡", "ğŸ’¥", "ğŸ’«", "â­", "ğŸŒŸ",
        
        // æ™‚é–“ãƒ»æ™‚è¨ˆ
        "ğŸ•", "ğŸ•‘", "ğŸ•’", "ğŸ•“", "ğŸ•”", "ğŸ••", "ğŸ•–", "ğŸ•—", "ğŸ•˜", "ğŸ•™",
        "ğŸ•š", "ğŸ•›", "ğŸ•œ", "ğŸ•", "ğŸ•", "ğŸ•Ÿ", "ğŸ• ", "ğŸ•¡", "ğŸ•¢", "ğŸ•£",
        "ğŸ•¤", "ğŸ•¥", "ğŸ•¦", "ğŸ•§", "âŒš", "â°", "â±ï¸", "â²ï¸", "ğŸ•°ï¸", "âŒ›",
        
        // è¨˜å·ãƒ»è£…é£¾
        "ğŸ’¯", "ğŸ’¢", "ğŸ’®", "ğŸ’­", "ğŸ’¬", "ğŸ’¤", "ğŸ’«", "ğŸ’¥", "ğŸ’¦", "ğŸ’¨",
        "ğŸ’§", "ğŸ’©", "ğŸ’ª", "ğŸ’‹", "ğŸ’Œ", "ğŸ’˜", "ğŸ’", "ğŸ’–", "ğŸ’—", "ğŸ’“",
        "ğŸ’•", "ğŸ’", "ğŸ’Ÿ", "â£ï¸", "ğŸ’”", "â¤ï¸", "ğŸ©·", "ğŸ§¡", "ğŸ’›", "ğŸ’š",
        "ğŸ’™", "ğŸ©µ", "ğŸ’œ", "ğŸ–¤", "ğŸ©¶", "ğŸ¤", "ğŸ¤", "ğŸ’”", "â£ï¸", "ğŸ’•"
      ];

      const connectors = [
        // é †æ¥ãƒ»è¿½åŠ 
        "ãã—ã¦", "ã¾ãŸ", "ã•ã‚‰ã«", "ãã‚Œã«", "åŠ ãˆã¦", "ãã®ä¸Š", "ãªãŠ", "ã¡ãªã¿ã«",
        "ã¨ã“ã‚ã§", "ã•ã¦", "ã§ã¯", "ãã‚Œã§ã¯", "ãã‚Œãªã‚‰", "ãã†ã™ã‚‹ã¨", "ãã®çµæœ",
        "ãã®ãŸã‚", "ãã®ç†ç”±ã§", "ãªãœãªã‚‰", "ã¨ã„ã†ã®ã¯", "ã¤ã¾ã‚Š", "è¦ã™ã‚‹ã«",
        "ç°¡å˜ã«è¨€ãˆã°", "è¨€ã„æ›ãˆã‚Œã°", "ä¾‹ãˆã°", "ç‰¹ã«", "ç‰¹ã«", "ç‰¹ã«", "ç‰¹ã«",
        "ä¸€æ–¹ã§", "åå¯¾ã«", "é€†ã«", "ã—ã‹ã—", "ã§ã‚‚", "ã‘ã‚Œã©ã‚‚", "ãŸã ã—", "ã‚‚ã£ã¨ã‚‚",
        "ç¢ºã‹ã«", "ç¢ºã‹ã«", "ç¢ºã‹ã«", "ç¢ºã‹ã«", "ç¢ºã‹ã«", "ç¢ºã‹ã«", "ç¢ºã‹ã«", "ç¢ºã‹ã«",
        
        // ã‚ˆã‚Šè©³ç´°ãªæ¥ç¶šè©
        "ã•ã‚‰ã«è©³ã—ãè¨€ãˆã°", "ã‚ˆã‚Šå…·ä½“çš„ã«ã¯", "å…·ä½“çš„ã«ã¯", "è©³ç´°ã«ã¯", "è©³ã—ãã¯",
        "è¨€ã„æ›ãˆã‚‹ã¨", "åˆ¥ã®è¨€ã„æ–¹ã‚’ã™ã‚Œã°", "ã¤ã¾ã‚Š", "ã™ãªã‚ã¡", "è¦ã™ã‚‹ã«",
        "ç°¡å˜ã«è¨€ã†ã¨", "ä¸€è¨€ã§è¨€ãˆã°", "ç«¯çš„ã«è¨€ãˆã°", "ç‡ç›´ã«è¨€ãˆã°", "æ­£ç›´ã«è¨€ãˆã°",
        "å®Ÿã¯", "å®Ÿéš›ã«ã¯", "æœ¬å½“ã¯", "å®Ÿéš›ã®ã¨ã“ã‚", "ç¾å®Ÿã«ã¯", "å®Ÿéš›å•é¡Œã¨ã—ã¦",
        "ç†è«–çš„ã«ã¯", "ç†æƒ³çš„ã«ã¯", "ç¾å®Ÿçš„ã«ã¯", "å®Ÿéš›çš„ã«ã¯", "å®Ÿç”¨çš„ã«ã¯",
        "å€‹äººçš„ã«ã¯", "å€‹äººçš„ãªæ„è¦‹ã§ã™ãŒ", "ç§è¦‹ã§ã™ãŒ", "ç§ã®è€ƒãˆã§ã¯", "ç§ã¨ã—ã¦ã¯",
        "ä¸€èˆ¬çš„ã«ã¯", "é€šå¸¸ã¯", "æ™®é€šã¯", "å¤§æŠµã¯", "å¤§æ¦‚ã¯", "å¤§æ–¹ã¯", "æ¦‚ã­",
        "æ¯”è¼ƒçš„", "æ¯”è¼ƒçš„ã«", "ç›¸å¯¾çš„ã«", "ç›¸å¯¾çš„ã«ã¯", "çµ¶å¯¾çš„ã«ã¯", "çµ¶å¯¾çš„ã«",
        "åŸºæœ¬çš„ã«ã¯", "åŸºæœ¬çš„ã«", "æ ¹æœ¬çš„ã«ã¯", "æ ¹æœ¬çš„ã«", "æœ¬è³ªçš„ã«ã¯", "æœ¬è³ªçš„ã«",
        "è¡¨é¢çš„ã«ã¯", "è¡¨é¢çš„ã«", "å½¢å¼çš„ã«ã¯", "å½¢å¼çš„ã«", "å®Ÿè³ªçš„ã«ã¯", "å®Ÿè³ªçš„ã«",
        "ç†è«–çš„ã«ã¯", "ç†è«–çš„ã«", "å®Ÿè·µçš„ã«ã¯", "å®Ÿè·µçš„ã«", "å®Ÿéš›çš„ã«ã¯", "å®Ÿéš›çš„ã«",
        "ç†æƒ³çš„ã«ã¯", "ç†æƒ³çš„ã«", "ç¾å®Ÿçš„ã«ã¯", "ç¾å®Ÿçš„ã«", "å®Ÿç”¨çš„ã«ã¯", "å®Ÿç”¨çš„ã«",
        "å€‹äººçš„ã«ã¯", "å€‹äººçš„ã«", "ä¸€èˆ¬çš„ã«ã¯", "ä¸€èˆ¬çš„ã«", "é€šå¸¸ã¯", "é€šå¸¸ã«",
        "æ¯”è¼ƒçš„ã«ã¯", "æ¯”è¼ƒçš„ã«", "ç›¸å¯¾çš„ã«ã¯", "ç›¸å¯¾çš„ã«", "çµ¶å¯¾çš„ã«ã¯", "çµ¶å¯¾çš„ã«",
        "åŸºæœ¬çš„ã«ã¯", "åŸºæœ¬çš„ã«", "æ ¹æœ¬çš„ã«ã¯", "æ ¹æœ¬çš„ã«", "æœ¬è³ªçš„ã«ã¯", "æœ¬è³ªçš„ã«",
        "è¡¨é¢çš„ã«ã¯", "è¡¨é¢çš„ã«", "å½¢å¼çš„ã«ã¯", "å½¢å¼çš„ã«", "å®Ÿè³ªçš„ã«ã¯", "å®Ÿè³ªçš„ã«"
      ];

      const endings = [
        // åŸºæœ¬çµ‚äº†èª
        "ã§ã™", "ã§ã™ã­", "ã§ã™ã‚ˆ", "ã§ã—ã‚‡ã†", "ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“", "ã¨æ€ã„ã¾ã™", "æ„Ÿã˜ã§ã™",
        "ã§ã™ï¼", "ã§ã™ã­ï¼", "ã§ã™ã‚ˆï¼", "ã§ã—ã‚‡ã†ï¼", "ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼", "ã¨æ€ã„ã¾ã™ï¼", "æ„Ÿã˜ã§ã™ï¼",
        "ã§ã™ã€œ", "ã§ã™ã­ã€œ", "ã§ã™ã‚ˆã€œ", "ã§ã—ã‚‡ã†ã€œ", "ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€œ", "ã¨æ€ã„ã¾ã™ã€œ", "æ„Ÿã˜ã§ã™ã€œ",
        "ã§ã™ã€‚", "ã§ã™ã­ã€‚", "ã§ã™ã‚ˆã€‚", "ã§ã—ã‚‡ã†ã€‚", "ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚", "ã¨æ€ã„ã¾ã™ã€‚", "æ„Ÿã˜ã§ã™ã€‚",
        "ã§ã™...", "ã§ã™ã­...", "ã§ã™ã‚ˆ...", "ã§ã—ã‚‡ã†...", "ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“...", "ã¨æ€ã„ã¾ã™...", "æ„Ÿã˜ã§ã™...",
        
        // ã‚ˆã‚Šè©³ç´°ãªçµ‚äº†èª
        "ãã†æ€ã„ã¾ã™", "ãã†æ„Ÿã˜ã¾ã™", "ãã†è€ƒãˆã¾ã™", "ãã†æ€ã‚ã‚Œã¾ã™", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¾ã™",
        "ãã†è€ƒãˆã‚‰ã‚Œã¾ã™", "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹",
        "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™",
        "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“",
        "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹ã§ã—ã‚‡ã†", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹ã§ã—ã‚‡ã†", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹ã§ã—ã‚‡ã†",
        "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™",
        "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹æ„Ÿã˜ã§ã™", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹æ„Ÿã˜ã§ã™", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹æ„Ÿã˜ã§ã™",
        "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¾ã™", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¾ã™", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¾ã™",
        "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªæ„Ÿã˜ãŒã—ã¾ã™", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªæ„Ÿã˜ãŒã—ã¾ã™", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªæ„Ÿã˜ãŒã—ã¾ã™",
        "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªå°è±¡ã‚’å—ã‘ã¾ã™", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªå°è±¡ã‚’å—ã‘ã¾ã™", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªå°è±¡ã‚’å—ã‘ã¾ã™",
        "ãã†æ€ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªå°è±¡ãŒã‚ã‚Šã¾ã™", "ãã†æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªå°è±¡ãŒã‚ã‚Šã¾ã™", "ãã†è€ƒãˆã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªå°è±¡ãŒã‚ã‚Šã¾ã™"
      ];

      const patterns = [];
      let patternCount = 0;

      // åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç´„10,000ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      for (let g = 0; g < greetings.length && patternCount < 10000; g++) {
        for (let t = 0; t < topics.length && patternCount < 10000; t++) {
          for (let r = 0; r < responses.length && patternCount < 10000; r++) {
            for (let e = 0; e < emotions.length && patternCount < 10000; e++) {
              patterns.push({
                greeting: greetings[g],
                topic: topics[t],
                response: responses[r],
                emotion: emotions[e],
                type: 'basic'
              });
              patternCount++;
            }
          }
        }
      }

      // æ¥ç¶šè©ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç´„25,000ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      for (let g = 0; g < greetings.length && patternCount < 35000; g++) {
        for (let t = 0; t < topics.length && patternCount < 35000; t++) {
          for (let c = 0; c < connectors.length && patternCount < 35000; c++) {
            for (let r = 0; r < responses.length && patternCount < 35000; r++) {
              for (let e = 0; e < emotions.length && patternCount < 35000; e++) {
                patterns.push({
                  greeting: greetings[g],
                  topic: topics[t],
                  connector: connectors[c],
                  response: responses[r],
                  emotion: emotions[e],
                  type: 'connector'
                });
                patternCount++;
              }
            }
          }
        }
      }

      // çµ‚äº†èªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç´„35,000ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      for (let g = 0; g < greetings.length && patternCount < 70000; g++) {
        for (let t = 0; t < topics.length && patternCount < 70000; t++) {
          for (let r = 0; r < responses.length && patternCount < 70000; r++) {
            for (let end = 0; end < endings.length && patternCount < 70000; end++) {
              for (let e = 0; e < emotions.length && patternCount < 70000; e++) {
                patterns.push({
                  greeting: greetings[g],
                  topic: topics[t],
                  response: responses[r],
                  ending: endings[end],
                  emotion: emotions[e],
                  type: 'ending'
                });
                patternCount++;
              }
            }
          }
        }
      }

      // è¤‡åˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç´„30,000ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      for (let g = 0; g < greetings.length && patternCount < 100000; g++) {
        for (let t = 0; t < topics.length && patternCount < 100000; t++) {
          for (let c = 0; c < connectors.length && patternCount < 100000; c++) {
            for (let r = 0; r < responses.length && patternCount < 100000; r++) {
              for (let end = 0; end < endings.length && patternCount < 100000; end++) {
                for (let e = 0; e < emotions.length && patternCount < 100000; e++) {
                  patterns.push({
                    greeting: greetings[g],
                    topic: topics[t],
                    connector: connectors[c],
                    response: responses[r],
                    ending: endings[end],
                    emotion: emotions[e],
                    type: 'complex'
                  });
                  patternCount++;
                }
              }
            }
          }
        }
      }

      console.log(`ç”Ÿæˆã•ã‚ŒãŸä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°: ${patterns.length}`);
      return patterns;
    }

    function getTime() {
      const now = new Date();
      return `ä»Šã®æ™‚åˆ»ã¯ ${now.getHours()}æ™‚${now.getMinutes()}åˆ† ã§ã™ã€‚`;
    }

    function getDate() {
      const now = new Date();
      return `ä»Šæ—¥ã¯ ${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ã§ã™ã€‚`;
    }

    // å¤©æ°—ãƒ»æ°—æ¸©æƒ…å ±ã‚’å–å¾—
    async function getWeather() {
      try {
        const selectedCity = userPreferences.selectedCity;
        const cityInfo = cityData[selectedCity];
        console.log(`${cityInfo.name}ã®æ°—æ¸©æƒ…å ±ã‚’å–å¾—ä¸­...`);
        
        // é¸æŠã•ã‚ŒãŸéƒ½å¸‚ã®æ°—æ¸©ã‚’å–å¾—
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${cityInfo.latitude}&longitude=${cityInfo.longitude}&current=temperature_2m,relative_humidity_2m,weather_code&timezone=${cityInfo.timezone}`);
        
        if (response.ok) {
          const data = await response.json();
          console.log(`${cityInfo.name}ã®æ°—æ¸©ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:`, data);
          
          const temp = Math.round(data.current.temperature_2m);
          const humidity = data.current.relative_humidity_2m;
          const weatherCode = data.current.weather_code;
          
          // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‚’æ—¥æœ¬èªã«å¤‰æ›
          const weatherText = getWeatherText(weatherCode);
          
          // æ°—æ¸©ã«åŸºã¥ãã‚³ãƒ¡ãƒ³ãƒˆ
          let tempComment = '';
          if (temp >= 30) {
            tempComment = 'ã¨ã¦ã‚‚æš‘ã„ã§ã™ã­ï¼æ°´åˆ†è£œçµ¦ã‚’å¿˜ã‚Œãšã«ã€‚';
          } else if (temp >= 25) {
            tempComment = 'æš‘ã„ã§ã™ã­ã€‚é©åº¦ã«å†·æˆ¿ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚';
          } else if (temp >= 20) {
            tempComment = 'éã”ã—ã‚„ã™ã„æ°—æ¸©ã§ã™ã­ã€‚';
          } else if (temp >= 15) {
            tempComment = 'å°‘ã—è‚Œå¯’ã„ã§ã™ã­ã€‚ä¸Šç€ãŒã‚ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚';
          } else if (temp >= 10) {
            tempComment = 'å¯’ã„ã§ã™ã­ã€‚æ¸©ã‹ã„æ ¼å¥½ã‚’ã—ã¾ã—ã‚‡ã†ã€‚';
          } else {
            tempComment = 'ã¨ã¦ã‚‚å¯’ã„ã§ã™ã­ï¼é˜²å¯’å¯¾ç­–ã‚’ã—ã£ã‹ã‚Šã¨ã€‚';
          }
          
          const result = `ğŸŒ¤ï¸ ç¾åœ¨ã®å¤©æ°—æƒ…å ±ï¼ˆ${cityInfo.name}ï¼‰:\n` +
                 `ğŸŒ¡ï¸ æ°—æ¸©: ${temp}Â°C\n` +
                 `â˜ï¸ å¤©æ°—: ${weatherText}\n` +
                 `ğŸ’§ æ¹¿åº¦: ${humidity}%\n` +
                 `ğŸ’¬ ${tempComment}`;
          
          console.log('æ°—æ¸©æƒ…å ±ç”Ÿæˆå®Œäº†:', result);
          return result;
        } else {
          console.log('APIå¿œç­”ã‚¨ãƒ©ãƒ¼ã€ä»£æ›¿æƒ…å ±ã‚’ä½¿ç”¨');
          // APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ä»£æ›¿æ¡ˆ
          return getWeatherFallback();
        }
      } catch (error) {
        console.error('å¤©æ°—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        console.log('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã€ä»£æ›¿æƒ…å ±ã‚’ä½¿ç”¨');
        return getWeatherFallback();
      }
    }
    
    // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‚’æ—¥æœ¬èªã«å¤‰æ›
    function getWeatherText(code) {
      const weatherMap = {
        0: 'å¿«æ™´',
        1: 'æ™´ã‚Œ',
        2: 'æ™´ã‚Œæ™‚ã€…æ›‡ã‚Š',
        3: 'æ›‡ã‚Š',
        45: 'éœ§',
        48: 'éœ§',
        51: 'å°é›¨',
        53: 'é›¨',
        55: 'é›¨',
        56: 'å°é›¨',
        57: 'é›¨',
        61: 'é›¨',
        63: 'é›¨',
        65: 'å¤§é›¨',
        66: 'å°é›¨',
        67: 'é›¨',
        71: 'å°é›ª',
        73: 'é›ª',
        75: 'å¤§é›ª',
        77: 'é›ª',
        80: 'å°é›¨',
        81: 'é›¨',
        82: 'å¤§é›¨',
        85: 'å°é›ª',
        86: 'å¤§é›ª',
        95: 'é›·é›¨',
        96: 'é›·é›¨',
        99: 'é›·é›¨'
      };
      return weatherMap[code] || 'ä¸æ˜';
    }
    
    // å¤©æ°—æƒ…å ±ãŒå–å¾—ã§ããªã„å ´åˆã®ä»£æ›¿æ¡ˆ
    function getWeatherFallback() {
      const selectedCity = userPreferences.selectedCity;
      const cityInfo = cityData[selectedCity];
      const now = new Date();
      const month = now.getMonth() + 1;
      const hour = now.getHours();
      
      // å­£ç¯€ã¨æ™‚é–“å¸¯ã«åŸºã¥ãæ¨å®šæ°—æ¸©
      let estimatedTemp = 20;
      let season = '';
      
      if (month >= 3 && month <= 5) {
        season = 'æ˜¥';
        estimatedTemp = 15 + Math.floor(Math.random() * 10);
      } else if (month >= 6 && month <= 8) {
        season = 'å¤';
        estimatedTemp = 25 + Math.floor(Math.random() * 10);
      } else if (month >= 9 && month <= 11) {
        season = 'ç§‹';
        estimatedTemp = 15 + Math.floor(Math.random() * 10);
      } else {
        season = 'å†¬';
        estimatedTemp = 5 + Math.floor(Math.random() * 10);
      }
      
      // éƒ½å¸‚ã«ã‚ˆã‚‹æ°—æ¸©èª¿æ•´
      if (selectedCity === 'Osaka') {
        // å¤§é˜ªã¯æ±äº¬ã‚ˆã‚Šå°‘ã—æš–ã‹ã„å‚¾å‘
        estimatedTemp += 1;
      }
      
      // æ™‚é–“å¸¯ã«ã‚ˆã‚‹èª¿æ•´
      if (hour >= 6 && hour <= 10) {
        estimatedTemp -= 2; // æœã¯æ¶¼ã—ã„
      } else if (hour >= 14 && hour <= 16) {
        estimatedTemp += 3; // åˆå¾Œã¯æš‘ã„
      } else if (hour >= 22 || hour <= 4) {
        estimatedTemp -= 3; // å¤œã¯æ¶¼ã—ã„
      }
      
      const tempComment = getTempComment(estimatedTemp);
      
      return `ğŸŒ¤ï¸ æ¨å®šå¤©æ°—æƒ…å ±ï¼ˆ${cityInfo.name}ãƒ»${season}ï¼‰:\n` +
             `ğŸŒ¡ï¸ æ¨å®šæ°—æ¸©: ${estimatedTemp}Â°C\n` +
             `â˜ï¸ å¤©æ°—: æ™´ã‚Œæ™‚ã€…æ›‡ã‚Š\n` +
             `ğŸ’¬ ${tempComment}\n` +
             `â„¹ï¸ æ³¨: ã“ã‚Œã¯æ¨å®šå€¤ã§ã™ã€‚æ­£ç¢ºãªæƒ…å ±ã¯å¤©æ°—äºˆå ±ã‚µã‚¤ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚`;
    }
    
    // æ°—æ¸©ã«åŸºã¥ãã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
    function getTempComment(temp) {
      if (temp >= 30) {
        return 'ã¨ã¦ã‚‚æš‘ã„ã§ã™ã­ï¼æ°´åˆ†è£œçµ¦ã‚’å¿˜ã‚Œãšã«ã€‚';
      } else if (temp >= 25) {
        return 'æš‘ã„ã§ã™ã­ã€‚é©åº¦ã«å†·æˆ¿ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚';
      } else if (temp >= 20) {
        return 'éã”ã—ã‚„ã™ã„æ°—æ¸©ã§ã™ã­ã€‚';
      } else if (temp >= 15) {
        return 'å°‘ã—è‚Œå¯’ã„ã§ã™ã­ã€‚ä¸Šç€ãŒã‚ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚';
      } else if (temp >= 10) {
        return 'å¯’ã„ã§ã™ã­ã€‚æ¸©ã‹ã„æ ¼å¥½ã‚’ã—ã¾ã—ã‚‡ã†ã€‚';
      } else {
        return 'ã¨ã¦ã‚‚å¯’ã„ã§ã™ã­ï¼é˜²å¯’å¯¾ç­–ã‚’ã—ã£ã‹ã‚Šã¨ã€‚';
      }
    }

    // ãƒãƒƒãƒˆæ¤œç´¢æ©Ÿèƒ½ï¼ˆæ¤œç´¢çµæœã®URLã‚’æä¾›ï¼‰
    function searchWeb(query) {
      const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
      const japaneseSearchUrl = `https://www.google.co.jp/search?q=${encodeURIComponent(query)}`;
      const youtubeSearchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
      const wikipediaSearchUrl = `https://ja.wikipedia.org/wiki/${encodeURIComponent(query)}`;
      const bingSearchUrl = `https://www.bing.com/search?q=${encodeURIComponent(query)}`;
      const yahooSearchUrl = `https://search.yahoo.co.jp/search?p=${encodeURIComponent(query)}`;
      const amazonSearchUrl = `https://www.amazon.co.jp/s?k=${encodeURIComponent(query)}`;
      const rakutenSearchUrl = `https://search.rakuten.co.jp/search/insight/?sitem=${encodeURIComponent(query)}`;
      
      return `ğŸ” ã€Œ${query}ã€ã«ã¤ã„ã¦æ¤œç´¢çµæœã‚’æä¾›ã—ã¾ã™ï¼š

ğŸ” <a href="${japaneseSearchUrl}" target="_blank" style="color: #1f6feb; text-decoration: underline;">Googleæ¤œç´¢ï¼ˆæ—¥æœ¬èªï¼‰</a>
ğŸŒ <a href="${searchUrl}" target="_blank" style="color: #1f6feb; text-decoration: underline;">Googleæ¤œç´¢ï¼ˆè‹±èªï¼‰</a>
ğŸ“º <a href="${youtubeSearchUrl}" target="_blank" style="color: #1f6feb; text-decoration: underline;">YouTubeæ¤œç´¢</a>
ğŸ“š <a href="${wikipediaSearchUrl}" target="_blank" style="color: #1f6feb; text-decoration: underline;">Wikipediaæ¤œç´¢</a>
ğŸ” <a href="${bingSearchUrl}" target="_blank" style="color: #1f6feb; text-decoration: underline;">Bingæ¤œç´¢</a>
ğŸ“± <a href="${yahooSearchUrl}" target="_blank" style="color: #1f6feb; text-decoration: underline;">Yahoo!æ¤œç´¢</a>
ğŸ›’ <a href="${amazonSearchUrl}" target="_blank" style="color: #1f6feb; text-decoration: underline;">Amazonæ¤œç´¢</a>
ğŸ <a href="${rakutenSearchUrl}" target="_blank" style="color: #1f6feb; text-decoration: underline;">æ¥½å¤©æ¤œç´¢</a>

ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€è©³ç´°ãªæƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
    }

    function getRandomConversation() {
      const randomIndex = Math.floor(Math.random() * conversationPatterns.length);
      const pattern = conversationPatterns[randomIndex];
      
      let response = "";
      
      switch (pattern.type) {
        case 'basic':
          response = `${pattern.greeting}ï¼${pattern.topic}ã«ã¤ã„ã¦${pattern.response}${pattern.emotion}`;
          break;
        case 'connector':
          response = `${pattern.greeting}ï¼${pattern.topic}ã«ã¤ã„ã¦${pattern.connector}${pattern.response}${pattern.emotion}`;
          break;
        case 'ending':
          response = `${pattern.greeting}ï¼${pattern.topic}ã«ã¤ã„ã¦${pattern.response}${pattern.ending}${pattern.emotion}`;
          break;
        case 'complex':
          response = `${pattern.greeting}ï¼${pattern.topic}ã«ã¤ã„ã¦${pattern.connector}${pattern.response}${pattern.ending}${pattern.emotion}`;
          break;
      }
      
      return response;
    }

    // è³ªå•ã¸ã®å¿œç­”
    function getQuestionResponse() {
      const responses = [
        'è‰¯ã„è³ªå•ã§ã™ã­ï¼ç§ã«ã§ãã‚‹é™ã‚Šè©³ã—ããŠç­”ãˆã—ã¾ã™ã€‚',
        'ãã®è³ªå•ã€ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„ã§ã™ã€‚ä¸€ç·’ã«è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
        'è³ªå•ã—ã¦ã„ãŸã ã„ã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚',
        'ãã®ç–‘å•ã€è§£æ±ºã§ãã‚‹ã¨ã„ã„ã§ã™ã­ã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    // ä¾é ¼ã¸ã®å¿œç­”
    function getRequestResponse() {
      const responses = [
        'ã‚‚ã¡ã‚ã‚“ã§ã™ï¼ãŠæ‰‹ä¼ã„ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚',
        'å–œã‚“ã§ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚ã©ã‚“ãªã“ã¨ã§ã—ã‚‡ã†ã‹ï¼Ÿ',
        'ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚è¨€ã£ã¦ãã ã•ã„ã€‚',
        'ç§ã«ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€å…¨åŠ›ã§ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    // æ„Ÿè¬ã¸ã®å¿œç­”
    function getGratitudeResponse() {
      const responses = [
        'ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ãŠå½¹ã«ç«‹ã¦ã¦å¬‰ã—ã„ã§ã™ã€‚',
        'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãŸä½•ã‹ã‚ã‚Œã°ã„ã¤ã§ã‚‚ãŠå£°ãŒã‘ãã ã•ã„ã€‚',
        'ãŠç¤¼ã‚’è¨€ã£ã¦ã„ãŸã ã„ã¦ã€ã¨ã¦ã‚‚å¬‰ã—ã„ã§ã™ã€‚',
        'ã“ã¡ã‚‰ã“ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚',
        'ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ã¾ãŸä½•ã‹ã‚ã‚Œã°ã„ã¤ã§ã‚‚ã€‚',
        'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠå½¹ã«ç«‹ã¦ã¦å…‰æ „ã§ã™ã€‚',
        'ã©ã†ã„ãŸã—ã¾ã—ã¦ã€‚æ¥½ã—ã„ä¼šè©±ã§ã—ãŸã€‚',
        'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãŸãŠè©±ã—ã—ã¾ã—ã‚‡ã†ã­ã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    function getGreetingResponse() {
      const responses = [
        'ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚',
        'ã‚„ã‚ï¼å…ƒæ°—ã§ã™ã‹ï¼Ÿ',
        'ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
        'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ä»Šæ—¥ã‚‚ä¸€æ—¥é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚',
        'ã“ã‚“ã°ã‚“ã¯ï¼ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã§ã—ãŸã‹ï¼Ÿ',
        'ã¯ã˜ã‚ã¾ã—ã¦ï¼ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚',
        'ã‚„ã‚ï¼ä¹…ã—ã¶ã‚Šã§ã™ã­ã€‚',
        'ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã‚‚ç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã«ã—ã¾ã—ã‚‡ã†ã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    function getFarewellResponse() {
      const responses = [
        'ã•ã‚ˆã†ãªã‚‰ï¼ã¾ãŸãŠè©±ã—ã—ã¾ã—ã‚‡ã†ã­ã€‚',
        'ãƒã‚¤ãƒã‚¤ï¼ã¾ãŸã­ã€‚',
        'ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ã¾ãŸãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚',
        'ã•ã‚ˆã†ãªã‚‰ï¼è‰¯ã„ä¸€æ—¥ã‚’ãŠéã”ã—ãã ã•ã„ã€‚',
        'ã¾ãŸã­ï¼å…ƒæ°—ã§ã­ã€‚',
        'ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ã‚†ã£ãã‚Šä¼‘ã‚“ã§ãã ã•ã„ã­ã€‚',
        'ã•ã‚ˆã†ãªã‚‰ï¼æ˜æ—¥ã‚‚è‰¯ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚',
        'ã¾ãŸãŠè©±ã—ã—ã¾ã—ã‚‡ã†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }
    
    // æ–°ã—ã„å¿œç­”é–¢æ•°ç¾¤
    function getConsultationResponse(analysis) {
      const responses = [
        'ãŠæ‚©ã¿ã‚’èã‹ã›ã¦ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä¸€ç·’ã«è€ƒãˆã•ã›ã¦ã„ãŸã ãã¾ã™ã­ã€‚',
        'ã¨ã¦ã‚‚å¤§åˆ‡ãªã”ç›¸è«‡ã§ã™ã­ã€‚ã©ã‚“ãªå°ã•ãªã“ã¨ã§ã‚‚ã€é æ…®ãªããŠè©±ã—ãã ã•ã„ã€‚',
        'ãŠå›°ã‚Šã®ã“ã¨ã€ã‚ˆãåˆ†ã‹ã‚Šã¾ã™ã€‚ç§ã«ã§ãã‚‹é™ã‚Šã®ã‚µãƒãƒ¼ãƒˆã‚’ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚',
        'ã”ç›¸è«‡ã„ãŸã ã‘ã¦å¬‰ã—ã„ã§ã™ã€‚ã‚ãªãŸã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã„ãŸã„ã¨æ€ã„ã¾ã™ã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }
    
    function getInformationResponse(analysis) {
      const responses = [
        'ãŠçŸ¥ã‚‰ã›ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„æƒ…å ±ã§ã™ã­ã€‚',
        'ãã†ãªã‚“ã§ã™ã­ï¼æ•™ãˆã¦ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚',
        'è²´é‡ãªæƒ…å ±ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã™ã€‚',
        'ãã®ã‚ˆã†ãªå‡ºæ¥äº‹ãŒã‚ã£ãŸã®ã§ã™ã­ã€‚è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }
    
    function getHighPositiveResponse(analysis) {
      const responses = [
        'ã‚ã‚ï¼ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™ã­ï¼ç§ã‚‚ä¸€ç·’ã«å–œã°ã›ã¦ãã ã•ã„ï¼',
        'ãªã‚“ã¦ç´ æ•µãªã“ã¨ã§ã—ã‚‡ã†ï¼ã‚ãªãŸã®å–œã³ãŒç§ã«ã‚‚ä¼ã‚ã£ã¦ãã¾ã™ï¼',
        'æœ¬å½“ã«è‰¯ã‹ã£ãŸã§ã™ã­ï¼å¿ƒã‹ã‚‰ç¥ç¦ã•ã›ã¦ã„ãŸã ãã¾ã™ï¼',
        'ãã‚Œã¯æœ€é«˜ã§ã™ã­ï¼ã‚ãªãŸã®å¹¸ã›ãã†ãªæ§˜å­ãŒç›®ã«æµ®ã‹ã³ã¾ã™ï¼'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }
    
    function getHighNegativeResponse(analysis) {
      const responses = [
        'ã¨ã¦ã‚‚è¾›ã„çŠ¶æ³ã§ã™ã­ã€‚ã‚ãªãŸã®æ°—æŒã¡ã€ã¨ã¦ã‚‚ã‚ˆãåˆ†ã‹ã‚Šã¾ã™ã€‚',
        'ãã‚“ãªã«å¤§å¤‰ãªæ€ã„ã‚’ã•ã‚Œã¦ã„ã‚‹ã®ã§ã™ã­ã€‚ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã€‚',
        'æœ¬å½“ã«è‹¦ã—ã„çŠ¶æ³ã§ã™ã­ã€‚ç§ã¯ã‚ãªãŸã®å‘³æ–¹ã§ã™ã€‚',
        'ã¨ã¦ã‚‚æ·±åˆ»ãªå•é¡Œã§ã™ã­ã€‚ä¸€ç·’ã«è§£æ±ºç­–ã‚’è€ƒãˆã•ã›ã¦ãã ã•ã„ã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }
    
    function getQuestionResponseByType(analysis) {
      switch(analysis.questionType) {
        case 'opinion':
          return 'ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„è³ªå•ã§ã™ã­ã€‚ç§ã®è€ƒãˆã‚’ãŠè©±ã—ã•ã›ã¦ã„ãŸã ãã¾ã™ã­ã€‚';
        case 'specific':
          return 'å…·ä½“çš„ãªè³ªå•ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è©³ã—ããŠç­”ãˆã§ãã‚‹ã‚ˆã†åŠªã‚ã¾ã™ã€‚';
        case 'explanation':
          return 'ãªã‚‹ã»ã©ã€ç†ç”±ã‚„èƒŒæ™¯ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã®ã§ã™ã­ã€‚åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚';
        default:
          return 'è‰¯ã„è³ªå•ã§ã™ã­ï¼ä¸€ç·’ã«è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
      }
    }
    
    function getTopicContinuationResponse(analysis) {
      const responses = [
        'ãã®è©±ã®ç¶šãã€ã¨ã¦ã‚‚æ°—ã«ãªã‚Šã¾ã™ã€‚ã‚‚ã£ã¨è©³ã—ãèã‹ã›ã¦ãã ã•ã„ã€‚',
        'ã•ã£ãã®è©±é¡Œã®ç¶šãã§ã™ã­ã€‚ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„ã§ã™ã€‚',
        'ãã®ä»¶ã«ã¤ã„ã¦ã€ã‚‚ã†å°‘ã—æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
        'ãã®è©±ã€ç¶šããŒæ°—ã«ãªã‚Šã¾ã™ã€‚ã©ã†ãªã£ãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }
    
    function getPersonalResponse(analysis) {
      const responses = [
        'ã‚ãªãŸã®ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã£ã¦ã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚',
        'ãã†ãªã‚“ã§ã™ã­ã€‚ã‚ãªãŸã®ãŠè©±ã€ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„ã§ã™ã€‚',
        'ã”è‡ªèº«ã®ã“ã¨ã‚’ãŠè©±ã—ãã ã•ã‚Šã€å¬‰ã—ã„ã§ã™ã€‚',
        'ã‚ãªãŸã®ã“ã¨ãŒã‚ˆãåˆ†ã‹ã‚Šã¾ã—ãŸã€‚ã‚‚ã£ã¨èã‹ã›ã¦ãã ã•ã„ã€‚'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è€ƒæ…®ã—ãŸå¿œç­”ç”Ÿæˆ
    function generateContextualResponse(analysis) {
      try {
        // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
        conversationHistory.push({
          user: analysis.keywords.join(', '),
          timestamp: new Date(),
          sentiment: analysis.sentiment,
          topic: analysis.topic
        });
        
        // æœ€æ–°ã®5ä»¶ã®ã¿ä¿æŒ
        if (conversationHistory.length > 5) {
          conversationHistory.shift();
        }
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        updateConversationContext(analysis);
        
        // é©åˆ‡ãªå¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ
        const responsePattern = selectResponsePattern(analysis);
        
        // å¿œç­”ã‚’ç”Ÿæˆ
        let response = responsePattern;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã«åŸºã¥ãå¿œç­”ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
        response = customizeResponseByPreferences(response);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èˆˆå‘³ã«é–¢é€£ã™ã‚‹è©±é¡Œã‚’è¿½åŠ ï¼ˆ30%ã®ç¢ºç‡ï¼‰
        if (conversationContext.interests.length > 0 && Math.random() < 0.3) {
          const randomInterest = conversationContext.interests[Math.floor(Math.random() * conversationContext.interests.length)];
          const interestResponses = {
            'work': [
              ' ä»•äº‹ã®è©±ã€ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„ã§ã™ã­ã€‚',
              ' ãŠä»•äº‹ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ä»–ã«ã‚‚ä½•ã‹ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
              ' ä»•äº‹ã®è©±ã€èãã®ãŒå¤§å¥½ãã§ã™ã€‚',
              ' ãŠä»•äº‹ã«ã¤ã„ã¦ã€ã‚‚ã£ã¨è©³ã—ãèã‹ã›ã¦ãã ã•ã„ã€‚'
            ],
            'hobby': [
              ' è¶£å‘³ã®è©±ã€èãã®ãŒå¤§å¥½ãã§ã™ã€‚',
              ' è¶£å‘³ãŒã‚ã‚‹ã¨äººç”ŸãŒè±Šã‹ã«ãªã‚Šã¾ã™ã‚ˆã­ã€‚',
              ' ãã®è¶£å‘³ã€ã¨ã¦ã‚‚ç´ æ•µã§ã™ã­ã€‚',
              ' è¶£å‘³ã®è©±ã€ç¶šãã‚’èã‹ã›ã¦ãã ã•ã„ã€‚'
            ],
            'family': [
              ' å®¶æ—ã®è©±ã€æ¸©ã‹ã¿ãŒã‚ã£ã¦ç´ æ•µã§ã™ã­ã€‚',
              ' å®¶æ—ã¨ã®æ™‚é–“ã€ã¨ã¦ã‚‚è²´é‡ã§ã™ã­ã€‚',
              ' å®¶æ—ã®è©±ã€èãã®ãŒå¤§å¥½ãã§ã™ã€‚',
              ' å®¶æ—ã«ã¤ã„ã¦ã€ã‚‚ã£ã¨æ•™ãˆã¦ãã ã•ã„ã€‚'
            ],
            'health': [
              ' å¥åº·ã«ã¤ã„ã¦è€ƒãˆã‚‹ã®ã¯å¤§åˆ‡ã§ã™ã­ã€‚',
              ' å¥åº·ã¯ä½•ã‚ˆã‚Šå¤§åˆ‡ã§ã™ã‚ˆã­ã€‚',
              ' ä½“èª¿ç®¡ç†ã€ã—ã£ã‹ã‚Šã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ',
              ' å¥åº·ã«ã¤ã„ã¦ã€ä½•ã‹æ°—ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ'
            ],
            'technology': [
              ' ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã®è©±ã€ã¨ã¦ã‚‚é¢ç™½ã„ã§ã™ã€‚',
              ' æŠ€è¡“ã®é€²æ­©ã€ã™ã”ã„ã§ã™ã­ã€‚',
              ' ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã«ã¤ã„ã¦ã€ã‚‚ã£ã¨è©³ã—ãèã‹ã›ã¦ãã ã•ã„ã€‚',
              ' ãã®æŠ€è¡“ã€ã¨ã¦ã‚‚èˆˆå‘³æ·±ã„ã§ã™ã€‚'
            ],
            'food': [
              ' é£Ÿã¹ç‰©ã®è©±ã€æ¥½ã—ã„ã§ã™ã­ã€‚',
              ' é£Ÿã¹ç‰©ã®è©±ã€èãã®ãŒå¤§å¥½ãã§ã™ã€‚',
              ' ãã®é£Ÿã¹ç‰©ã€ã¨ã¦ã‚‚ç¾å‘³ã—ãã†ã§ã™ã­ã€‚',
              ' é£Ÿã¹ç‰©ã«ã¤ã„ã¦ã€ã‚‚ã£ã¨æ•™ãˆã¦ãã ã•ã„ã€‚'
            ],
            'weather': [
              ' å¤©æ°—ã®è©±ã€æ—¥å¸¸çš„ã§è¦ªã—ã¿ã‚„ã™ã„ã§ã™ã­ã€‚',
              ' å¤©æ°—ã«ã¤ã„ã¦ã€ä½•ã‹æ°—ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
              ' å¤©æ°—ã®è©±ã€ã¨ã¦ã‚‚èº«è¿‘ã§è‰¯ã„ã§ã™ã­ã€‚',
              ' ä»Šæ—¥ã®å¤©æ°—ã€ã„ã‹ãŒã§ã™ã‹ï¼Ÿ'
            ]
          };
          
          if (interestResponses[randomInterest]) {
            const responses = interestResponses[randomInterest];
            response += responses[Math.floor(Math.random() * responses.length)];
          }
        }
        
        // ä¼šè©±ã®ç¶™ç¶šæ€§ã‚’ä¿ã¤ï¼ˆ20%ã®ç¢ºç‡ï¼‰
        if (conversationContext.conversationLength > 2 && Math.random() < 0.2) {
          const continuations = [
            ' ä»–ã«ã‚‚ä½•ã‹ãŠè©±ã—ãŸã„ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            ' ä»–ã«ä½•ã‹æ¥½ã—ã„è©±ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            ' ä»–ã«ã‚‚ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            ' ä»–ã«ä½•ã‹æ°—ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            ' ä»–ã«ã‚‚ä½•ã‹èã‹ã›ã¦ãã ã•ã„ã€‚'
          ];
          response += continuations[Math.floor(Math.random() * continuations.length)];
        }
        
        // æ™‚ã€…ã€å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªå¿œç­”ã‚’æ··ãœã‚‹ï¼ˆ10%ã®ç¢ºç‡ï¼‰
        if (Math.random() < 0.1) {
          const randomResponses = [
            ' ä»Šæ—¥ã¯ä½•ã‹ç‰¹åˆ¥ãªã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ',
            ' æœ€è¿‘ã€ä½•ã‹æ–°ã—ã„ç™ºè¦‹ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ',
            ' ä»Šæ—¥ã¯ã©ã‚“ãªæ°—åˆ†ã§ã™ã‹ï¼Ÿ',
            ' ä½•ã‹æ¥½ã—ã„äºˆå®šã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            ' æœ€è¿‘ã€ä½•ã‹èˆˆå‘³æ·±ã„ã“ã¨ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ',
            ' ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã§ã—ãŸã‹ï¼Ÿ',
            ' ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ'
          ];
          response += randomResponses[Math.floor(Math.random() * randomResponses.length)];
        }
        
        return response;
      } catch (error) {
        console.error('ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        return 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      }
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã«åŸºã¥ãå¿œç­”ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
    function customizeResponseByPreferences(response) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ç½®æ›
      if (userPreferences.userName) {
        response = response.replace(/ãƒ¦ãƒ¼ã‚¶ãƒ¼/g, `${userPreferences.userName}ã•ã‚“`);
        response = response.replace(/ã‚ãªãŸ/g, `${userPreferences.userName}ã•ã‚“`);
      }
      
      // æ€§æ ¼ã«åŸºã¥ãå¿œç­”ã®èª¿æ•´
      switch (userPreferences.personality) {
        case 'formal':
          response = response.replace(/ã§ã™ã€‚/g, 'ã§ã”ã–ã„ã¾ã™ã€‚');
          response = response.replace(/ã¾ã™ã€‚/g, 'ã¾ã™ã€‚');
          break;
        case 'humorous':
          if (Math.random() < 0.3) {
            response += ' ğŸ˜Š';
          }
          break;
        case 'professional':
          response = response.replace(/ã­ã€‚/g, 'ã€‚');
          response = response.replace(/ã­ã€‚/g, 'ã€‚');
          break;
      }
      
      // å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã®èª¿æ•´
      switch (userPreferences.responseStyle) {
        case 'concise':
          if (response.length > 100) {
            response = response.split('ã€‚')[0] + 'ã€‚';
          }
          break;
        case 'cute':
          if (Math.random() < 0.5) {
            response += ' âœ¨';
          }
          break;
      }
      
      return response;
    }

    async function aiReply(text) {
      try {
        // ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘½ä»¤ã®å‡¦ç†ã‚’å„ªå…ˆ
        const commandResponse = processUserCommand(text);
        if (commandResponse) {
          return commandResponse;
        }
        
        // æ¤œç´¢æ„å›³ã®æ¤œå‡ºã¨å‡¦ç†
        if (text.includes("æ¤œç´¢") || text.includes("èª¿ã¹ã¦") || text.includes("æ•™ãˆã¦") || text.includes("æ¢ã—ã¦")) {
          const searchQuery = extractSearchQuery(text);
          if (searchQuery) {
            return searchWeb(searchQuery);
          }
        }
        
        // çŸ­ã„å˜èªã®æ¤œç´¢å‡¦ç†
        const shortWordPattern = /^[ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾¯]{1,3}$/;
        if (shortWordPattern.test(text.trim())) {
          const shortWords = [
            'çŒ«', 'çŠ¬', 'äºº', 'è»Š', 'å®¶', 'æœ¬', 'èŠ±', 'æœ¨', 'å±±', 'æµ·', 'ç©º', 'æœˆ', 'æ˜Ÿ', 'é¢¨', 'é›¨',
            'é³¥', 'é­š', 'è™«', 'è‰', 'çŸ³', 'æ°´', 'ç«', 'åœŸ', 'é‡‘', 'éŠ€', 'éŠ…', 'é‰„', 'ç´™', 'å¸ƒ', 'ç³¸',
            'ç±³', 'éº¦', 'è±†', 'è‚‰', 'é­š', 'åµ', 'ç‰›', 'é¦¬', 'ç¾Š', 'è±š', 'é¶', 'é´¨', 'é¯‰', 'é®­', 'é°»',
            'æ¡œ', 'æ¢…', 'æ¾', 'ç«¹', 'èŠ', 'è˜­', 'è–”è–‡', 'ç™¾åˆ', 'è“®', 'ç‰¡ä¸¹', 'æ¤¿', 'ç´«é™½èŠ±', 'æœé¡”',
            'æ±äº¬', 'å¤§é˜ª', 'äº¬éƒ½', 'æ¨ªæµœ', 'åå¤å±‹', 'ç¥æˆ¸', 'ç¦å²¡', 'æœ­å¹Œ', 'ä»™å°', 'åºƒå³¶', 'é‡‘æ²¢',
            'å¯Œå£«', 'ç®±æ ¹', 'æ—¥å…‰', 'éŒå€‰', 'å¥ˆè‰¯', 'å§«è·¯', 'å§«è·¯åŸ', 'å¤©å®ˆé–£', 'ç¥ç¤¾', 'å¯º', 'æ•™ä¼š',
            'å­¦æ ¡', 'ä¼šç¤¾', 'ç—…é™¢', 'éŠ€è¡Œ', 'éƒµä¾¿å±€', 'è­¦å¯Ÿç½²', 'æ¶ˆé˜²ç½²', 'å›³æ›¸é¤¨', 'ç¾è¡“é¤¨', 'åšç‰©é¤¨',
            'é§…', 'ç©ºæ¸¯', 'æ¸¯', 'æ©‹', 'ãƒˆãƒ³ãƒãƒ«', 'é“è·¯', 'å…¬åœ’', 'åºƒå ´', 'å¸‚å ´', 'å•†åº—è¡—', 'ãƒ‡ãƒ‘ãƒ¼ãƒˆ',
            'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', 'ã‚«ãƒ•ã‚§', 'å±…é…’å±‹', 'ãƒãƒ¼', 'ãƒ‘ãƒ–', 'ã‚¯ãƒ©ãƒ–', 'ãƒ›ãƒ†ãƒ«', 'æ—…é¤¨', 'æ°‘å®¿', 'ã‚­ãƒ£ãƒ³ãƒ—å ´',
            'ãƒ†ãƒ¬ãƒ“', 'ãƒ©ã‚¸ã‚ª', 'æ–°è', 'é›‘èªŒ', 'æœ¬', 'æ¼«ç”»', 'å°èª¬', 'è©©', 'æ­Œ', 'éŸ³æ¥½', 'æ˜ ç”»', 'ãƒ‰ãƒ©ãƒ',
            'ã‚²ãƒ¼ãƒ ', 'ã‚¹ãƒãƒ¼ãƒ„', 'é‡çƒ', 'ã‚µãƒƒã‚«ãƒ¼', 'ãƒ†ãƒ‹ã‚¹', 'ã‚´ãƒ«ãƒ•', 'ã‚¹ã‚­ãƒ¼', 'ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰', 'ã‚µãƒ¼ãƒ•ã‚£ãƒ³',
            'æ–™ç†', 'å’Œé£Ÿ', 'æ´‹é£Ÿ', 'ä¸­è¯', 'ã‚¤ã‚¿ãƒªã‚¢ãƒ³', 'ãƒ•ãƒ¬ãƒ³ãƒ', 'ã‚¨ã‚¹ãƒ‹ãƒƒã‚¯', 'ã‚¹ã‚¤ãƒ¼ãƒ„', 'ã‚±ãƒ¼ã‚­', 'ãƒ‘ãƒ³',
            'ãŠé…’', 'ãƒ“ãƒ¼ãƒ«', 'ãƒ¯ã‚¤ãƒ³', 'æ—¥æœ¬é…’', 'ç„¼é…', 'ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼', 'ãƒ–ãƒ©ãƒ³ãƒ‡ãƒ¼', 'ã‚«ã‚¯ãƒ†ãƒ«', 'ã‚¸ãƒ¥ãƒ¼ã‚¹', 'ãŠèŒ¶',
            'ã‚³ãƒ¼ãƒ’ãƒ¼', 'ç´…èŒ¶', 'ç·‘èŒ¶', 'æŠ¹èŒ¶', 'éº¦èŒ¶', 'ç„ç±³èŒ¶', 'ã»ã†ã˜èŒ¶', 'çƒé¾èŒ¶', 'ãƒ—ãƒ¼ã‚¢ãƒ¼ãƒ«èŒ¶', 'ã‚¸ãƒ£ã‚¹ãƒŸãƒ³èŒ¶',
            'æ„›', 'æ‹', 'å¤¢', 'å¸Œæœ›', 'æœªæ¥', 'éå»', 'ç¾åœ¨', 'æ™‚é–“', 'ç©ºé–“', 'ä¸–ç•Œ', 'åœ°çƒ', 'å®‡å®™',
            'å¤ªé™½', 'åœ°çƒ', 'ç«æ˜Ÿ', 'é‡‘æ˜Ÿ', 'æœ¨æ˜Ÿ', 'åœŸæ˜Ÿ', 'å¤©ç‹æ˜Ÿ', 'æµ·ç‹æ˜Ÿ', 'å†¥ç‹æ˜Ÿ', 'å½—æ˜Ÿ', 'æµæ˜Ÿ',
            'æ˜¥', 'å¤', 'ç§‹', 'å†¬', 'æœ', 'æ˜¼', 'å¤œ', 'å¤•æ–¹', 'æ·±å¤œ', 'åˆå‰', 'åˆå¾Œ', 'æ­£åˆ', 'çœŸå¤œä¸­',
            'å‹é”', 'å®¶æ—', 'æ‹äºº', 'å…ˆç”Ÿ', 'ç”Ÿå¾’', 'å­¦ç”Ÿ', 'å¤§äºº', 'å­ä¾›', 'èµ¤ã¡ã‚ƒã‚“', 'ãŠå¹´å¯„ã‚Š',
            'ç”·', 'å¥³', 'ç”·æ€§', 'å¥³æ€§', 'å°‘å¹´', 'å°‘å¥³', 'é’å¹´', 'ä¸­å¹´', 'é«˜é½¢è€…', 'è‹¥è€…',
            'æ‰‹', 'è¶³', 'ç›®', 'è€³', 'é¼»', 'å£', 'é ­', 'é«ª', 'è‚Œ', 'å¿ƒ', 'ä½“', 'é­‚', 'ç²¾ç¥',
            'è‰²', 'éŸ³', 'åŒ‚ã„', 'å‘³', 'è§¦æ„Ÿ', 'æ¸©åº¦', 'æ¹¿åº¦', 'åœ§åŠ›', 'é‡åŠ›', 'é›»æ°—', 'ç£æ°—',
            'è¨€è‘‰', 'æ–‡å­—', 'æ•°å­—', 'è¨˜å·', 'çµµ', 'å†™çœŸ', 'æ˜ åƒ', 'å‹•ç”»', 'éŸ³å£°', 'ãƒ‡ãƒ¼ã‚¿',
            'æƒ…å ±', 'çŸ¥è­˜', 'çŸ¥æµ', 'çµŒé¨“', 'è¨˜æ†¶', 'æ„Ÿæƒ…', 'æ€è€ƒ', 'æƒ³åƒ', 'å‰µé€ ', 'ç™ºæ˜',
            'ç™ºè¦‹', 'ç ”ç©¶', 'å®Ÿé¨“', 'è¦³å¯Ÿ', 'åˆ†æ', 'è¨ˆç®—', 'æ¸¬å®š', 'æ¯”è¼ƒ', 'åˆ†é¡', 'æ•´ç†'
          ];
          
          if (shortWords.includes(text.trim())) {
            const searchIntent = confirm(`${text.trim()}ã«ã¤ã„ã¦æ¤œç´¢ã—ã¾ã™ã‹ï¼Ÿ`);
            if (searchIntent) {
              return searchWeb(text.trim());
            }
          }
        }
        
        // ä¸€èˆ¬çš„ãªæ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‡¦ç†
        const searchPatterns = [
          /^(.{1,10})(ã«ã¤ã„ã¦|ã¨ã¯|ã£ã¦|ã®æƒ…å ±|ã‚’æ•™ãˆã¦|ã‚’èª¿ã¹ã¦|ã‚’æ¤œç´¢ã—ã¦|ã‚’æ¢ã—ã¦)$/,
          /^(.{1,10})(ã£ã¦ä½•|ã¨ã¯ä½•|ã«ã¤ã„ã¦æ•™ãˆã¦|ã«ã¤ã„ã¦èª¿ã¹ã¦|ã«ã¤ã„ã¦æ¤œç´¢ã—ã¦)$/,
          /^(.{1,10})(ã®è©³ç´°|ã®èª¬æ˜|ã®æ„å‘³|ã®å®šç¾©|ã®æ­´å²|ã®ç‰¹å¾´|ã®ç¨®é¡|ã®ä½œã‚Šæ–¹|ã®é£Ÿã¹æ–¹|ã®ä½¿ã„æ–¹)$/
        ];
        
        for (let pattern of searchPatterns) {
          const match = text.match(pattern);
          if (match && match[1] && match[1].length >= 1) {
            return searchWeb(match[1].trim());
          }
        }
        
        // æ™‚é–“ãƒ»æ—¥ä»˜ãƒ»å¤©æ°—ã®å‡¦ç†
        if (text.includes("æ™‚é–“") || text.includes("æ™‚åˆ»")) return getTime();
        if (text.includes("æ—¥ä»˜") || text.includes("ä»Šæ—¥ã¯")) return getDate();
        if (text.includes("å¤©æ°—")) return getWeather();

        // æ°—æ¸©ã«é–¢ã™ã‚‹è³ªå•
        if (text.includes("æ°—æ¸©") || text.includes("æ¸©åº¦") || text.includes("æš‘ã„") || text.includes("å¯’ã„") || text.includes("ä½•åº¦")) {
          const weatherInfo = await getWeather();
          return weatherInfo;
        }
        
        // æ„Ÿæƒ…ãƒ»æ„å›³ãƒ»ãƒˆãƒ”ãƒƒã‚¯ã®åˆ†æ
        const analysis = analyzeUserMessage(text);
        
        // å­¦ç¿’ãƒ™ãƒ¼ã‚¹ã®å¿œç­”ç”Ÿæˆ
        let reply = await generateLearningBasedResponse(text, analysis);
        
        // å¿œç­”ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º
        reply = customizeResponseByPreferences(reply);
        
        // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«è¨˜éŒ²
        learnConversationPattern(text, reply, analysis);
        
        // ä¼šè©±å±¥æ­´ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        conversationHistory.push({ role: 'user', content: text });
        conversationHistory.push({ role: 'assistant', content: reply });
        updateConversationContext(analysis);
        
        return reply;
      } catch (error) {
        console.error('AI Reply Error:', error);
        return 'ã™ã¿ã¾ã›ã‚“ã€å¿œç­”ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      }
    }

    async function addMessage(who, text) {
      const div = document.createElement("div");
      div.className = `msg ${who}`;
      div.innerHTML = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      
      // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
      try {
        const response = await fetch('save_chat.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: text,
            message_type: who
          })
        });
        
        const data = await response.json();
        if (!data.success) {
          console.error('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', data.message);
        }
      } catch (error) {
        console.error('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function showTypingIndicator() {
      const indicator = document.createElement("div");
      indicator.className = "typing-indicator";
      indicator.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      `;
      indicator.id = "typing-indicator";
      chat.appendChild(indicator);
      chat.scrollTop = chat.scrollHeight;
      return indicator;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById("typing-indicator");
      if (indicator) {
        indicator.remove();
      }
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      
      console.log('ğŸ“¤ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–‹å§‹:', text);
      
      addMessage("user", text);
      input.value = "";
      
      // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
      const typingIndicator = showTypingIndicator();
      
      setTimeout(async () => {
        removeTypingIndicator();
        try {
          console.log(' AIå¿œç­”ç”Ÿæˆé–‹å§‹...');
          const reply = await aiReply(text);
          console.log('âœ… AIå¿œç­”ç”Ÿæˆå®Œäº†:', reply);
          addMessage("ai", reply);
        } catch (error) {
          console.error('âŒ AIå¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
          addMessage("ai", "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        }
      }, 1000 + Math.random() * 1000); // 1-2ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ é…å»¶
    }

    send.addEventListener("click", sendMessage);
    
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    document.getElementById('logout-btn').addEventListener('click', async function() {
      try {
        const response = await fetch('logout.php');
        const data = await response.json();
        
        if (data.success) {
          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
          localStorage.removeItem('user_id');
          localStorage.removeItem('user_name');
          localStorage.removeItem('is_logged_in');
          
          // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
          window.location.href = 'login.html';
        }
      } catch (error) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        localStorage.clear();
        window.location.href = 'login.html';
      }
    });

    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¨­å®š
    input.focus();
    
    // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
    let learningData = {
      conversationPatterns: [],
      userBehavior: {},
      topicPreferences: {},
      responseQuality: {},
      contextMemory: [],
      apiUsageCount: 0
    };
    
    // é«˜åº¦ãªæ„Ÿæƒ…åˆ†æã‚¯ãƒ©ã‚¹
    class AdvancedEmotionAnalyzer {
      constructor() {
        this.emotionLexicon = this.buildEmotionLexicon();
        this.contextRules = this.buildContextRules();
        this.emphasisPatterns = this.buildEmphasisPatterns();
        this.politenessLevels = this.buildPolitenessLevels();
      }
      
      analyze(message) {
        const emotions = this.detectEmotions(message);
        const primarySentiment = this.determinePrimarySentiment(emotions);
        const intensity = this.calculateIntensity(emotions);
        const confidence = this.calculateConfidence(emotions);
        const complexity = this.analyzeComplexity(message);
        const politeness = this.analyzePoliteness(message);
        const sarcasm = this.detectSarcasm(message, emotions);
        const emphasis = this.detectEmphasis(message);
        
        return {
          emotions,
          primarySentiment,
          intensity,
          confidence,
          complexity,
          politeness,
          sarcasm,
          emphasis
        };
      }
      
      detectEmotions(message) {
        const emotions = {
          joy: 0, sadness: 0, anger: 0, fear: 0, surprise: 0, disgust: 0,
          trust: 0, anticipation: 0, love: 0, contempt: 0, confusion: 0, excitement: 0
        };
        
        // æ„Ÿæƒ…ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ¤œå‡º
        for (const [emotion, keywords] of Object.entries(this.emotionLexicon)) {
          for (const keyword of keywords) {
            if (message.includes(keyword.text)) {
              emotions[emotion] += keyword.weight;
              
              // æ–‡è„ˆãƒ«ãƒ¼ãƒ«ã®é©ç”¨
              const contextMultiplier = this.applyContextRules(keyword, message);
              emotions[emotion] *= contextMultiplier;
            }
          }
        }
        
        // æ„Ÿæƒ…ã®æ­£è¦åŒ–
        for (const emotion in emotions) {
          emotions[emotion] = Math.max(0, Math.min(10, emotions[emotion]));
        }
        
        return emotions;
      }
      
      determinePrimarySentiment(emotions) {
        let maxEmotion = 'neutral';
        let maxValue = 0;
        
        for (const [emotion, value] of Object.entries(emotions)) {
          if (value > maxValue) {
            maxValue = value;
            maxEmotion = emotion;
          }
        }
        
        // æ„Ÿæƒ…ã®åˆ†é¡
        if (maxValue < 2) return 'neutral';
        
        const positiveEmotions = ['joy', 'love', 'trust', 'anticipation', 'excitement'];
        const negativeEmotions = ['sadness', 'anger', 'fear', 'disgust', 'contempt', 'confusion'];
        
        if (positiveEmotions.includes(maxEmotion)) return 'positive';
        if (negativeEmotions.includes(maxEmotion)) return 'negative';
        
        return 'neutral';
      }
      
      calculateIntensity(emotions) {
        const totalIntensity = Object.values(emotions).reduce((sum, value) => sum + value, 0);
        const averageIntensity = totalIntensity / Object.keys(emotions).length;
        
        // -5ã‹ã‚‰+5ã®ã‚¹ã‚±ãƒ¼ãƒ«ã«å¤‰æ›
        if (averageIntensity < 2) return 0;
        if (averageIntensity < 4) return averageIntensity - 2;
        if (averageIntensity < 6) return averageIntensity - 3;
        if (averageIntensity < 8) return averageIntensity - 2;
        return 5;
      }
      
      calculateConfidence(emotions) {
        const maxEmotion = Math.max(...Object.values(emotions));
        const totalEmotions = Object.values(emotions).reduce((sum, value) => sum + value, 0);
        
        // æ„Ÿæƒ…ã®å¼·åº¦ã¨ä¸€è²«æ€§ã‹ã‚‰ä¿¡é ¼åº¦ã‚’è¨ˆç®—
        const intensityScore = maxEmotion / 10;
        const consistencyScore = maxEmotion / (totalEmotions / Object.keys(emotions).length);
        
        return Math.min(1, (intensityScore + consistencyScore) / 2);
      }
      
      analyzeComplexity(message) {
        const wordCount = message.split(/\s+/).length;
        const hasComplexStructures = /[ã€ã€‚ï¼ï¼Ÿ]/.test(message);
        const hasEmojis = /[\u{1F600}-\u{1F64F}]/u.test(message);
        
        if (wordCount > 20 || hasComplexStructures) return 'complex';
        if (wordCount > 10) return 'medium';
        return 'simple';
      }
      
      analyzePoliteness(message) {
        const formalPatterns = [/ã§ã™/, /ã¾ã™/, /ã”ã–ã„ã¾ã™/, /ã„ãŸã—ã¾ã™/];
        const casualPatterns = [/ã /, /ã§ã‚ã‚‹/, /ã ã‚ˆ/, /ã ã­/];
        
        let formalCount = 0;
        let casualCount = 0;
        
        formalPatterns.forEach(pattern => {
          if (pattern.test(message)) formalCount++;
        });
        
        casualPatterns.forEach(pattern => {
          if (pattern.test(message)) casualCount++;
        });
        
        if (formalCount > casualCount) return 'formal';
        if (casualCount > formalCount) return 'casual';
        return 'neutral';
      }
      
      detectSarcasm(message, emotions) {
        // çš®è‚‰ã®æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
        const sarcasmPatterns = [
          /æœ¬å½“ã«/, /ã¾ã‚/, /ãã†ã§ã™ã­/, /ç¢ºã‹ã«/, /ãªã‚‹ã»ã©/
        ];
        
        const hasSarcasmPattern = sarcasmPatterns.some(pattern => pattern.test(message));
        const emotionMismatch = this.detectEmotionMismatch(message, emotions);
        
        return hasSarcasmPattern && emotionMismatch;
      }
      
      detectEmphasis(message) {
        const emphasis = [];
        
        // å¼·èª¿è¡¨ç¾ã®æ¤œå‡º
        if (/ï¼+/.test(message)) emphasis.push('exclamation');
        if (/ï¼Ÿ+/.test(message)) emphasis.push('question');
        if (/\.{3,}/.test(message)) emphasis.push('ellipsis');
        if (/[ã€Œã€ã€ã€]/.test(message)) emphasis.push('quotes');
        if (/[ã€ã€‘]/.test(message)) emphasis.push('brackets');
        
        return emphasis;
      }
      
      buildEmotionLexicon() {
        return {
          joy: [
            { text: 'å¬‰ã—ã„', weight: 3 },
            { text: 'æ¥½ã—ã„', weight: 3 },
            { text: 'å¹¸ã›', weight: 4 },
            { text: 'å–œã³', weight: 4 },
            { text: 'ç¬‘é¡”', weight: 2 },
            { text: 'æ¥½ã—ã¿', weight: 3 },
            { text: 'æœ€é«˜', weight: 5 },
            { text: 'ç´ æ™´ã‚‰ã—ã„', weight: 4 }
          ],
          sadness: [
            { text: 'æ‚²ã—ã„', weight: 3 },
            { text: 'å¯‚ã—ã„', weight: 3 },
            { text: 'è½ã¡è¾¼ã¿', weight: 4 },
            { text: 'æ¶™', weight: 3 },
            { text: 'å˜†ã', weight: 4 },
            { text: 'æ†‚é¬±', weight: 4 }
          ],
          anger: [
            { text: 'æ€’ã‚Š', weight: 4 },
            { text: 'è…¹ç«‹ã¤', weight: 4 },
            { text: 'ã‚¤ãƒ©ã‚¤ãƒ©', weight: 3 },
            { text: 'æ†¤ã‚Š', weight: 4 },
            { text: 'æ¿€æ€’', weight: 5 },
            { text: 'æ†¤æ…¨', weight: 4 }
          ],
          fear: [
            { text: 'æ€–ã„', weight: 3 },
            { text: 'æã‚Œ', weight: 4 },
            { text: 'ä¸å®‰', weight: 3 },
            { text: 'å¿ƒé…', weight: 3 },
            { text: 'ææ€–', weight: 4 },
            { text: 'æ€¯ãˆ', weight: 3 }
          ],
          surprise: [
            { text: 'é©šã', weight: 3 },
            { text: 'ã³ã£ãã‚Š', weight: 3 },
            { text: 'æ„å¤–', weight: 2 },
            { text: 'äºˆæƒ³å¤–', weight: 3 },
            { text: 'è¡æ’ƒ', weight: 4 },
            { text: 'æ„•ç„¶', weight: 4 }
          ],
          love: [
            { text: 'æ„›ã—ã¦ã‚‹', weight: 5 },
            { text: 'å¤§å¥½ã', weight: 4 },
            { text: 'æ„›', weight: 4 },
            { text: 'æ‹', weight: 3 },
            { text: 'æ„›æƒ…', weight: 4 }
          ],
          trust: [
            { text: 'ä¿¡é ¼', weight: 4 },
            { text: 'å®‰å¿ƒ', weight: 3 },
            { text: 'é ¼ã‚‚ã—ã„', weight: 3 },
            { text: 'å¿ƒå¼·ã„', weight: 3 }
          ],
          confusion: [
            { text: 'æ··ä¹±', weight: 3 },
            { text: 'åˆ†ã‹ã‚‰ãªã„', weight: 2 },
            { text: 'è¿·ã†', weight: 2 },
            { text: 'å›°ã‚‹', weight: 2 }
          ],
          excitement: [
            { text: 'èˆˆå¥®', weight: 4 },
            { text: 'ãƒ¯ã‚¯ãƒ¯ã‚¯', weight: 3 },
            { text: 'æœŸå¾…', weight: 3 },
            { text: 'å¸Œæœ›', weight: 3 }
          ]
        };
      }
      
      buildContextRules() {
        return {
          negation: (keyword, message) => {
            // å¦å®šèªã®å‰å¾Œã®æ„Ÿæƒ…ã‚’åè»¢
            const negations = ['ãªã„', 'ã¾ã›ã‚“', 'ã˜ã‚ƒãªã„', 'ã§ã¯ãªã„'];
            const hasNegation = negations.some(neg => message.includes(neg));
            return hasNegation ? 0.5 : 1;
          },
          intensifier: (keyword, message) => {
            // å¼·èª¿èªã®å‰å¾Œã®æ„Ÿæƒ…ã‚’å¢—å¼·
            const intensifiers = ['ã¨ã¦ã‚‚', 'ã™ã”ã', 'ã‚ã¡ã‚ƒãã¡ã‚ƒ', 'è¶…'];
            const hasIntensifier = intensifiers.some(int => message.includes(int));
            return hasIntensifier ? 1.5 : 1;
          }
        };
      }
      
      buildEmphasisPatterns() {
        return {
          exclamation: /ï¼+/,
          question: /ï¼Ÿ+/,
          ellipsis: /\.{3,}/,
          quotes: /[ã€Œã€ã€ã€]/,
          brackets: /[ã€ã€‘]/
        };
      }
      
      buildPolitenessLevels() {
        return {
          veryFormal: [/ã”ã–ã„ã¾ã™/, /ã„ãŸã—ã¾ã™/, /ç”³ã—ä¸Šã’ã¾ã™/],
          formal: [/ã§ã™/, /ã¾ã™/],
          neutral: [/ã /, /ã§ã‚ã‚‹/],
          casual: [/ã ã‚ˆ/, /ã ã­/, /ã ã‚/]
        };
      }
      
      applyContextRules(keyword, message) {
        let multiplier = 1;
        
        for (const rule of Object.values(this.contextRules)) {
          multiplier *= rule(keyword, message);
        }
        
        return multiplier;
      }
      
      detectEmotionMismatch(message, emotions) {
        // æ„Ÿæƒ…ã¨æ–‡è„ˆã®ä¸ä¸€è‡´ã‚’æ¤œå‡º
        const positiveWords = ['è‰¯ã„', 'ç´ æ™´ã‚‰ã—ã„', 'æœ€é«˜'];
        const hasPositiveWords = positiveWords.some(word => message.includes(word));
        
        if (hasPositiveWords && emotions.sadness > emotions.joy) {
          return true;
        }
        
        return false;
      }
    }
    
    // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    loadLearningData();
    
    // æ¤œç´¢ã‚¯ã‚¨ãƒªã®æŠ½å‡ºé–¢æ•°
    function extractSearchQuery(text) {
      const patterns = [
        /(.*?)(ã«ã¤ã„ã¦|ã«é–¢ã—ã¦|ã®æƒ…å ±|ã®è©³ç´°|ã®èª¬æ˜)/,
        /(.*?)(ã¨ã¯|ã£ã¦ä½•|ã£ã¦|ã¨ã¯ä½•)/,
        /(.*?)(ã‚’æ¤œç´¢|ã‚’èª¿ã¹|ã‚’æ•™ãˆ|ã‚’æ¢ã—|ã‚’è¦‹ã¤ã‘)/
      ];
      
      for (let pattern of patterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
          return match[1].trim();
        }
      }
      return null;
    }
    
    // é«˜åº¦AIæ©Ÿèƒ½
    async function useAdvancedAI(message, analysis) {
      if (!userPreferences.useAdvancedAI || !userPreferences.openaiApiKey) {
        return null;
      }
      
      try {
        const response = await fetch('ai_api.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'advanced_chat',
            message: message,
            analysis: analysis,
            history: conversationHistory.slice(-10) // æœ€æ–°10ä»¶ã®ä¼šè©±å±¥æ­´
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          learningData.apiUsageCount++;
          saveLearningData();
          return data.data.response;
        }
      } catch (error) {
        console.error('Advanced AI Error:', error);
      }
      
      return null;
    }
    
    // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
    function saveLearningData() {
      localStorage.setItem('learningData', JSON.stringify(learningData));
    }
    
    // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    function loadLearningData() {
      try {
        const saved = localStorage.getItem('learningData');
        if (saved) {
          learningData = { ...learningData, ...JSON.parse(saved) };
        }
      } catch (error) {
        console.error('Learning data load error:', error);
      }
    }
    
    // ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å­¦ç¿’
    function learnConversationPattern(userMessage, aiResponse, analysis) {
      if (!userPreferences.autoLearn) return;
      
      const pattern = {
        userMessage: userMessage,
        aiResponse: aiResponse,
        analysis: analysis,
        timestamp: new Date().toISOString(),
        quality: 0 // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§æ›´æ–°
      };
      
      learningData.conversationPatterns.push(pattern);
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°ã‚’åˆ¶é™ï¼ˆæœ€æ–°1000ä»¶ã®ã¿ä¿æŒï¼‰
      if (learningData.conversationPatterns.length > 1000) {
        learningData.conversationPatterns = learningData.conversationPatterns.slice(-1000);
      }
      
      saveLearningData();
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã®å­¦ç¿’
    function learnUserBehavior(action, context) {
      const userId = localStorage.getItem('user_id') || 'anonymous';
      
      if (!learningData.userBehavior[userId]) {
        learningData.userBehavior[userId] = {
          messageCount: 0,
          averageMessageLength: 0,
          preferredTopics: {},
          responseTime: [],
          satisfactionRating: []
        };
      }
      
      const behavior = learningData.userBehavior[userId];
      
      switch (action) {
        case 'message_sent':
          behavior.messageCount++;
          behavior.averageMessageLength = (behavior.averageMessageLength + context.messageLength) / 2;
          break;
        case 'topic_engaged':
          if (!behavior.preferredTopics[context.topic]) {
            behavior.preferredTopics[context.topic] = 0;
          }
          behavior.preferredTopics[context.topic]++;
          break;
        case 'response_time':
          behavior.responseTime.push(context.time);
          if (behavior.responseTime.length > 100) {
            behavior.responseTime = behavior.responseTime.slice(-100);
          }
          break;
      }
      
      saveLearningData();
    }
    
    // æ”¹å–„ã•ã‚ŒãŸå¿œç­”ç”Ÿæˆï¼ˆå­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ï¼‰
    async function generateLearningBasedResponse(text, analysis) {
      try {
        // çŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ¤œç´¢
        const knowledgeResults = await externalAPI.searchKnowledgeBase(text);
        if (knowledgeResults.length > 0) {
          const enhancedResponse = await enhanceResponseWithKnowledge(text, analysis, knowledgeResults);
          if (enhancedResponse) {
            return enhancedResponse;
          }
        }
        
        // å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰é¡ä¼¼å¿œç­”ã‚’æ¤œç´¢
        const similarPattern = findSimilarPattern(text, analysis);
        if (similarPattern && similarPattern.quality > 3) {
          return adaptResponseFromPattern(similarPattern, analysis);
        }
        
        // å¾“æ¥ã®å¿œç­”ç”Ÿæˆ
        return selectResponsePattern(analysis);
      } catch (error) {
        console.error('Enhanced response generation error:', error);
        return selectResponsePattern(analysis);
      }
    }
    
    // çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã«ã‚ˆã‚‹å¿œç­”å¼·åŒ–
    async function enhanceResponseWithKnowledge(text, analysis, knowledgeResults) {
      try {
        let enhancedResponse = '';
        
        // Wikipediaæƒ…å ±ã®çµ±åˆ
        const wikiResult = knowledgeResults.find(result => result.type === 'wikipedia');
        if (wikiResult) {
          const wiki = wikiResult.data;
          enhancedResponse += `ğŸ“š **${wiki.title}**ã«ã¤ã„ã¦\n\n`;
          enhancedResponse += `${wiki.extract}\n\n`;
          enhancedResponse += `è©³ç´°ã¯[Wikipedia](${wiki.url})ã§ç¢ºèªã§ãã¾ã™ã€‚\n\n`;
        }
        
        // ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±ã®çµ±åˆ
        const newsResult = knowledgeResults.find(result => result.type === 'news');
        if (newsResult && newsResult.data.length > 0) {
          enhancedResponse += `ğŸ“° **æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹**\n\n`;
          newsResult.data.slice(0, 3).forEach(news => {
            enhancedResponse += `â€¢ [${news.title}](${news.url})\n`;
          });
          enhancedResponse += `\n`;
        }
        
        // åˆ†æçµæœã«åŸºã¥ãå¿œç­”ã®ç”Ÿæˆ
        const contextualResponse = generateContextualResponse(analysis);
        enhancedResponse += contextualResponse;
        
        return enhancedResponse;
      } catch (error) {
        console.error('Response enhancement error:', error);
        return null;
      }
    }
    
    // é«˜åº¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
    class AdvancedPatternMatcher {
      constructor() {
        this.semanticIndex = new Map();
        this.patternCache = new Map();
        this.similarityThreshold = 0.75;
        this.maxCacheSize = 1000;
      }
      
      findSimilarPattern(userMessage, analysis, learningData) {
        try {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰é«˜é€Ÿæ¤œç´¢
          const cacheKey = this.generateCacheKey(userMessage, analysis);
          if (this.patternCache.has(cacheKey)) {
            return this.patternCache.get(cacheKey);
          }
          
          // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢
          const semanticResults = this.semanticSearch(userMessage, analysis);
          
          // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹æ¤œç´¢
          const patternResults = this.patternBasedSearch(userMessage, analysis, learningData);
          
          // çµæœã®çµ±åˆã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°
          const combinedResults = this.combineAndRankResults(semanticResults, patternResults);
          
          // æœ€é©ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ
          const bestPattern = this.selectBestPattern(combinedResults, analysis);
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
          this.cacheResult(cacheKey, bestPattern);
          
          return bestPattern;
        } catch (error) {
          console.error('Advanced Pattern Matching Error:', error);
          return null;
        }
      }
      
      semanticSearch(userMessage, analysis) {
        const results = [];
        const userEmbeddings = this.generateEmbeddings(userMessage);
        
        // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰æ¤œç´¢
        for (const [patternId, patternData] of this.semanticIndex) {
          const similarity = this.calculateSemanticSimilarity(userEmbeddings, patternData.embeddings);
          
          if (similarity > this.similarityThreshold) {
            results.push({
              pattern: patternData.pattern,
              similarity: similarity,
              type: 'semantic',
              confidence: this.calculateConfidence(similarity, patternData.quality)
            });
          }
        }
        
        return results.sort((a, b) => b.similarity - a.similarity);
      }
      
      patternBasedSearch(userMessage, analysis, learningData) {
        const results = [];
        
        for (const pattern of learningData.conversationPatterns) {
          const score = this.calculateAdvancedSimilarity(userMessage, pattern.userMessage, analysis, pattern.analysis);
          
          if (score > this.similarityThreshold) {
            results.push({
              pattern: pattern,
              similarity: score,
              type: 'pattern',
              confidence: this.calculateConfidence(score, pattern.quality || 0)
            });
          }
        }
        
        return results.sort((a, b) => b.similarity - a.similarity);
      }
      
      calculateAdvancedSimilarity(msg1, msg2, analysis1, analysis2) {
        let totalScore = 0;
        let weights = 0;
        
        // 1. ãƒ†ã‚­ã‚¹ãƒˆã®é¡ä¼¼åº¦ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        const textSimilarity = this.calculateTextSimilarity(msg1, msg2);
        totalScore += textSimilarity * 0.3;
        weights += 0.3;
        
        // 2. æ„Ÿæƒ…ã®é¡ä¼¼åº¦ï¼ˆè©³ç´°ç‰ˆï¼‰
        const emotionSimilarity = this.calculateEmotionSimilarity(analysis1, analysis2);
        totalScore += emotionSimilarity * 0.25;
        weights += 0.25;
        
        // 3. ãƒˆãƒ”ãƒƒã‚¯ã®é¡ä¼¼åº¦
        const topicSimilarity = this.calculateTopicSimilarity(analysis1, analysis2);
        totalScore += topicSimilarity * 0.2;
        weights += 0.2;
        
        // 4. æ„å›³ã®é¡ä¼¼åº¦
        const intentSimilarity = this.calculateIntentSimilarity(analysis1, analysis2);
        totalScore += intentSimilarity * 0.15;
        weights += 0.15;
        
        // 5. æ–‡è„ˆã®é¡ä¼¼åº¦
        const contextSimilarity = this.calculateContextSimilarity(analysis1, analysis2);
        totalScore += contextSimilarity * 0.1;
        weights += 0.1;
        
        return weights > 0 ? totalScore / weights : 0;
      }
      
      calculateTextSimilarity(msg1, msg2) {
        // æ–‡å­—ãƒ¬ãƒ™ãƒ«ã®é¡ä¼¼åº¦
        const chars1 = msg1.toLowerCase().split('');
        const chars2 = msg2.toLowerCase().split('');
        const commonChars = chars1.filter(char => chars2.includes(char));
        const charSimilarity = commonChars.length / Math.max(chars1.length, chars2.length);
        
        // å˜èªãƒ¬ãƒ™ãƒ«ã®é¡ä¼¼åº¦
        const words1 = msg1.toLowerCase().split(/\s+/);
        const words2 = msg2.toLowerCase().split(/\s+/);
        const commonWords = words1.filter(word => words2.includes(word));
        const wordSimilarity = commonWords.length / Math.max(words1.length, words2.length);
        
        // æ–‡å­—ã¨å˜èªã®é¡ä¼¼åº¦ã‚’çµ„ã¿åˆã‚ã›
        return (charSimilarity * 0.4) + (wordSimilarity * 0.6);
      }
      
      calculateEmotionSimilarity(analysis1, analysis2) {
        if (!analysis1.emotions || !analysis2.emotions) {
          return analysis1.sentiment === analysis2.sentiment ? 1 : 0;
        }
        
        let totalSimilarity = 0;
        let emotionCount = 0;
        
        for (const emotion in analysis1.emotions) {
          if (analysis2.emotions[emotion] !== undefined) {
            const emotion1 = analysis1.emotions[emotion];
            const emotion2 = analysis2.emotions[emotion];
            
            // æ„Ÿæƒ…ã®å¼·åº¦ã®é¡ä¼¼åº¦
            const intensitySimilarity = 1 - Math.abs(emotion1 - emotion2) / 10;
            totalSimilarity += intensitySimilarity;
            emotionCount++;
          }
        }
        
        return emotionCount > 0 ? totalSimilarity / emotionCount : 0;
      }
      
      calculateTopicSimilarity(analysis1, analysis2) {
        if (analysis1.topic === analysis2.topic) return 1;
        
        // ãƒˆãƒ”ãƒƒã‚¯ã®éšå±¤çš„é¡ä¼¼åº¦
        const topicHierarchy = {
          'work': ['business', 'career', 'office'],
          'hobby': ['entertainment', 'leisure', 'recreation'],
          'family': ['personal', 'relationship', 'home'],
          'health': ['wellness', 'medical', 'fitness'],
          'technology': ['digital', 'computer', 'innovation']
        };
        
        for (const [mainTopic, relatedTopics] of Object.entries(topicHierarchy)) {
          if (analysis1.topic === mainTopic && relatedTopics.includes(analysis2.topic)) {
            return 0.7;
          }
          if (analysis2.topic === mainTopic && relatedTopics.includes(analysis1.topic)) {
            return 0.7;
          }
        }
        
        return 0;
      }
      
      calculateIntentSimilarity(analysis1, analysis2) {
        if (analysis1.intent === analysis2.intent) return 1;
        
        // æ„å›³ã®é¡ä¼¼æ€§ãƒãƒˆãƒªãƒƒã‚¯ã‚¹
        const intentSimilarityMatrix = {
          'question': { 'request': 0.8, 'consultation': 0.7 },
          'request': { 'question': 0.8, 'consultation': 0.6 },
          'consultation': { 'question': 0.7, 'request': 0.6 },
          'greeting': { 'farewell': 0.5 },
          'farewell': { 'greeting': 0.5 }
        };
        
        const similarity = intentSimilarityMatrix[analysis1.intent]?.[analysis2.intent] || 0;
        return similarity;
      }
      
      calculateContextSimilarity(analysis1, analysis2) {
        let similarity = 0;
        let factors = 0;
        
        // æ•¬èªãƒ¬ãƒ™ãƒ«ã®é¡ä¼¼åº¦
        if (analysis1.formality && analysis2.formality) {
          similarity += analysis1.formality === analysis2.formality ? 1 : 0.5;
          factors++;
        }
        
        // è¤‡é›‘ã•ã®é¡ä¼¼åº¦
        if (analysis1.complexity && analysis2.complexity) {
          similarity += analysis1.complexity === analysis2.complexity ? 1 : 0.5;
          factors++;
        }
        
        // å€‹äººæƒ…å ±ã®é¡ä¼¼åº¦
        if (analysis1.personalInfo !== undefined && analysis2.personalInfo !== undefined) {
          similarity += analysis1.personalInfo === analysis2.personalInfo ? 1 : 0.5;
          factors++;
        }
        
        return factors > 0 ? similarity / factors : 0;
      }
      
      combineAndRankResults(semanticResults, patternResults) {
        const allResults = [...semanticResults, ...patternResults];
        
        // é‡è¤‡ã‚’é™¤å»ã—ã€æœ€é«˜ã‚¹ã‚³ã‚¢ã‚’ä¿æŒ
        const uniqueResults = new Map();
        
        for (const result of allResults) {
          const key = result.pattern.userMessage || result.pattern.id;
          
          if (!uniqueResults.has(key) || uniqueResults.get(key).similarity < result.similarity) {
            uniqueResults.set(key, result);
          }
        }
        
        // ä¿¡é ¼åº¦ã§ã‚½ãƒ¼ãƒˆ
        return Array.from(uniqueResults.values()).sort((a, b) => b.confidence - a.confidence);
      }
      
      selectBestPattern(results, analysis) {
        if (results.length === 0) return null;
        
        // æœ€é«˜ä¿¡é ¼åº¦ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ
        const bestResult = results[0];
        
        // ä¿¡é ¼åº¦ãŒä½ã„å ´åˆã¯nullã‚’è¿”ã™
        if (bestResult.confidence < 0.6) return null;
        
        return bestResult.pattern;
      }
      
      calculateConfidence(similarity, quality) {
        // é¡ä¼¼åº¦ã¨å“è³ªã‹ã‚‰ä¿¡é ¼åº¦ã‚’è¨ˆç®—
        const similarityWeight = 0.7;
        const qualityWeight = 0.3;
        
        const normalizedQuality = Math.min(quality / 5, 1); // å“è³ªã‚’0-1ã«æ­£è¦åŒ–
        
        return (similarity * similarityWeight) + (normalizedQuality * qualityWeight);
      }
      
      generateEmbeddings(text) {
        // ç°¡æ˜“çš„ãªãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿ç”Ÿæˆ
        const embeddings = new Array(128).fill(0);
        const chars = text.toLowerCase().split('');
        
        for (let i = 0; i < chars.length && i < 128; i++) {
          embeddings[i] = chars[i].charCodeAt(0) / 255;
        }
        
        return embeddings;
      }
      
      calculateSemanticSimilarity(emb1, emb2) {
        // ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã®è¨ˆç®—
        let dotProduct = 0;
        let norm1 = 0;
        let norm2 = 0;
        
        for (let i = 0; i < emb1.length; i++) {
          dotProduct += emb1[i] * emb2[i];
          norm1 += emb1[i] * emb1[i];
          norm2 += emb2[i] * emb2[i];
        }
        
        const similarity = dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
        return Math.max(0, similarity); // è² ã®å€¤ã‚’0ã«
      }
      
      generateCacheKey(userMessage, analysis) {
        return `${userMessage.substring(0, 50)}_${analysis.topic}_${analysis.intent}_${analysis.sentiment}`;
      }
      
      cacheResult(key, result) {
        if (this.patternCache.size >= this.maxCacheSize) {
          // æœ€ã‚‚å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
          const firstKey = this.patternCache.keys().next().value;
          this.patternCache.delete(firstKey);
        }
        
        this.patternCache.set(key, result);
      }
      
      // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ›´æ–°
      updateSemanticIndex(pattern) {
        const embeddings = this.generateEmbeddings(pattern.userMessage);
        this.semanticIndex.set(pattern.id || Date.now(), {
          pattern: pattern,
          embeddings: embeddings,
          quality: pattern.quality || 0
        });
      }
    }
    
    // é«˜åº¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    const advancedPatternMatcher = new AdvancedPatternMatcher();
    
    // å¾“æ¥ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°é–¢æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
    function findSimilarPattern(userMessage, analysis) {
      return advancedPatternMatcher.findSimilarPattern(userMessage, analysis, learningData);
    }
    
    function calculateSimilarity(msg1, msg2, analysis1, analysis2) {
      return advancedPatternMatcher.calculateAdvancedSimilarity(msg1, msg2, analysis1, analysis2);
    }
    
    // å¤–éƒ¨APIçµ±åˆã‚·ã‚¹ãƒ†ãƒ 
    class ExternalAPIIntegration {
      constructor() {
        this.wikipediaCache = new Map();
        this.newsCache = new Map();
        this.translationCache = new Map();
        this.cacheExpiry = 30 * 60 * 1000; // 30åˆ†
      }
      
      // Wikipedia APIçµ±åˆ
      async getWikipediaInfo(query) {
        try {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
          const cacheKey = `wiki_${query}`;
          const cached = this.wikipediaCache.get(cacheKey);
          if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
            return cached.data;
          }
          
          // æ—¥æœ¬èªWikipediaã‹ã‚‰æ¤œç´¢
          const jaResponse = await fetch(
            `https://ja.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`
          );
          
          if (jaResponse.ok) {
            const data = await jaResponse.json();
            const result = {
              title: data.title,
              extract: data.extract,
              url: data.content_urls.desktop.page,
              language: 'ja',
              thumbnail: data.thumbnail?.source || null
            };
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            this.wikipediaCache.set(cacheKey, {
              data: result,
              timestamp: Date.now()
            });
            
            return result;
          }
          
          // è‹±èªWikipediaã‹ã‚‰æ¤œç´¢
          const enResponse = await fetch(
            `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`
          );
          
          if (enResponse.ok) {
            const enData = await enResponse.json();
            const result = {
              title: enData.title,
              extract: enData.extract,
              url: enData.content_urls.desktop.page,
              language: 'en',
              thumbnail: enData.thumbnail?.source || null
            };
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            this.wikipediaCache.set(cacheKey, {
              data: result,
              timestamp: Date.now()
            });
            
            return result;
          }
          
          return null;
        } catch (error) {
          console.error('Wikipedia API Error:', error);
          return null;
        }
      }
      
      // ãƒ‹ãƒ¥ãƒ¼ã‚¹APIçµ±åˆï¼ˆç„¡æ–™ç‰ˆï¼‰
      async getLatestNews(topic) {
        try {
          const cacheKey = `news_${topic}`;
          const cached = this.newsCache.get(cacheKey);
          if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
            return cached.data;
          }
          
          // ç°¡æ˜“çš„ãªãƒ‹ãƒ¥ãƒ¼ã‚¹æ¤œç´¢ï¼ˆå®Ÿéš›ã®APIã‚­ãƒ¼ãŒå¿…è¦ï¼‰
          const newsData = await this.searchNewsFromMultipleSources(topic);
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
          this.newsCache.set(cacheKey, {
            data: newsData,
            timestamp: Date.now()
          });
          
          return newsData;
        } catch (error) {
          console.error('News API Error:', error);
          return [];
        }
      }
      
      // è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹æ¤œç´¢
      async searchNewsFromMultipleSources(topic) {
        const news = [];
        
        try {
          // Google Newsæ¤œç´¢ï¼ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãªã—ï¼‰
          const googleNewsUrl = `https://news.google.com/search?q=${encodeURIComponent(topic)}&hl=ja&gl=JP&ceid=JP:ja`;
          news.push({
            title: `${topic}ã«é–¢ã™ã‚‹æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹`,
            description: `Google Newsã§ã€Œ${topic}ã€ã‚’æ¤œç´¢`,
            url: googleNewsUrl,
            source: 'Google News',
            timestamp: new Date().toISOString()
          });
          
          // Yahoo!ãƒ‹ãƒ¥ãƒ¼ã‚¹
          const yahooNewsUrl = `https://news.yahoo.co.jp/search/?p=${encodeURIComponent(topic)}`;
          news.push({
            title: `${topic}ã®Yahoo!ãƒ‹ãƒ¥ãƒ¼ã‚¹`,
            description: `Yahoo!ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã€Œ${topic}ã€ã‚’æ¤œç´¢`,
            url: yahooNewsUrl,
            source: 'Yahoo!ãƒ‹ãƒ¥ãƒ¼ã‚¹',
            timestamp: new Date().toISOString()
          });
          
        } catch (error) {
          console.error('News search error:', error);
        }
        
        return news;
      }
      
      // ç¿»è¨³APIçµ±åˆï¼ˆç„¡æ–™ç‰ˆï¼‰
      async translateText(text, targetLang = 'en') {
        try {
          const cacheKey = `trans_${text}_${targetLang}`;
          const cached = this.translationCache.get(cacheKey);
          if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
            return cached.data;
          }
          
          // Googleç¿»è¨³ã®ç°¡æ˜“ç‰ˆï¼ˆå®Ÿéš›ã®APIã‚­ãƒ¼ãŒå¿…è¦ï¼‰
          const translation = await this.simpleTranslation(text, targetLang);
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
          this.translationCache.set(cacheKey, {
            data: translation,
            timestamp: Date.now()
          });
          
          return translation;
        } catch (error) {
          console.error('Translation API Error:', error);
          return text; // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯åŸæ–‡ã‚’è¿”ã™
        }
      }
      
      // ç°¡æ˜“ç¿»è¨³ï¼ˆå®Ÿéš›ã®APIãªã—ï¼‰
      async simpleTranslation(text, targetLang) {
        // åŸºæœ¬çš„ãªæ—¥æœ¬èªâ†’è‹±èªç¿»è¨³ã®ä¾‹
        const basicTranslations = {
          'ã“ã‚“ã«ã¡ã¯': 'Hello',
          'ã‚ã‚ŠãŒã¨ã†': 'Thank you',
          'ãŠã¯ã‚ˆã†': 'Good morning',
          'ã“ã‚“ã°ã‚“ã¯': 'Good evening',
          'ã•ã‚ˆã†ãªã‚‰': 'Goodbye',
          'ã¯ã„': 'Yes',
          'ã„ã„ãˆ': 'No'
        };
        
        if (targetLang === 'en' && basicTranslations[text]) {
          return basicTranslations[text];
        }
        
        // å®Ÿéš›ã®ç¿»è¨³APIãŒãªã„å ´åˆã¯ã€ç¿»è¨³ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒªãƒ³ã‚¯ã‚’æä¾›
        const googleTranslateUrl = `https://translate.google.com/?sl=ja&tl=${targetLang}&text=${encodeURIComponent(text)}`;
        
        return {
          translated: text,
          url: googleTranslateUrl,
          note: 'Googleç¿»è¨³ã§è©³ç´°ãªç¿»è¨³ã‚’ç¢ºèªã§ãã¾ã™'
        };
      }
      
      // çŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ¤œç´¢
      async searchKnowledgeBase(query) {
        const results = [];
        
        try {
          // Wikipediaæ¤œç´¢
          const wikiResult = await this.getWikipediaInfo(query);
          if (wikiResult) {
            results.push({
              type: 'wikipedia',
              data: wikiResult,
              relevance: 0.9
            });
          }
          
          // ãƒ‹ãƒ¥ãƒ¼ã‚¹æ¤œç´¢
          const newsResults = await this.getLatestNews(query);
          if (newsResults.length > 0) {
            results.push({
              type: 'news',
              data: newsResults,
              relevance: 0.7
            });
          }
          
          // çµæœã‚’é–¢é€£æ€§ã§ã‚½ãƒ¼ãƒˆ
          results.sort((a, b) => b.relevance - a.relevance);
          
          return results;
        } catch (error) {
          console.error('Knowledge base search error:', error);
          return [];
        }
      }
    }
    
    // å¤–éƒ¨APIçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    const externalAPI = new ExternalAPIIntegration();
    
    // ãƒ­ãƒ¼ã‚«ãƒ«AIã‚·ã‚¹ãƒ†ãƒ 
    class LocalAISystem {
      constructor() {
        this.modelLoaded = false;
        this.modelName = 'rinna/japanese-gpt-neox-3.6b';
        this.maxTokens = 100;
        this.temperature = 0.7;
        this.fallbackResponses = this.buildFallbackResponses();
      }
      
      async initialize() {
        try {
          // Hugging Face Transformers.jsã®èª­ã¿è¾¼ã¿ç¢ºèª
          if (typeof window.pipeline !== 'undefined') {
            await this.loadModel();
            this.modelLoaded = true;
            console.log('ãƒ­ãƒ¼ã‚«ãƒ«AIãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
          } else {
            console.log('Transformers.jsãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™ã€‚');
          }
        } catch (error) {
          console.error('ãƒ­ãƒ¼ã‚«ãƒ«AIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        }
      }
      
      async loadModel() {
        try {
          // è»½é‡ãªæ—¥æœ¬èªãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿
          this.model = await window.pipeline('text-generation', this.modelName, {
            quantized: true,
            max_length: this.maxTokens
          });
        } catch (error) {
          console.error('ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          throw error;
        }
      }
      
      async generateResponse(message, analysis, context) {
        try {
          if (this.modelLoaded && this.model) {
            return await this.generateWithModel(message, analysis, context);
          } else {
            return this.generateFallbackResponse(message, analysis, context);
          }
        } catch (error) {
          console.error('ãƒ­ãƒ¼ã‚«ãƒ«AIå¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
          return this.generateFallbackResponse(message, analysis, context);
        }
      }
      
      async generateWithModel(message, analysis, context) {
        const prompt = this.buildPrompt(message, analysis, context);
        
        const result = await this.model(prompt, {
          max_new_tokens: this.maxTokens,
          temperature: this.temperature,
          do_sample: true,
          pad_token_id: this.model.tokenizer.eos_token_id
        });
        
        return this.processModelOutput(result[0].generated_text, prompt);
      }
      
      buildPrompt(message, analysis, context) {
        let prompt = 'ã‚ãªãŸã¯è¦ªåˆ‡ã§è³¢ã„AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚\n\n';
        
        // æ–‡è„ˆæƒ…å ±ã®è¿½åŠ 
        if (context.currentTopic) {
          prompt += `ç¾åœ¨ã®è©±é¡Œ: ${context.currentTopic}\n`;
        }
        
        if (context.userMood !== 'neutral') {
          prompt += `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—åˆ†: ${context.userMood}\n`;
        }
        
        // åˆ†æçµæœã®è¿½åŠ 
        if (analysis.emotions) {
          const dominantEmotion = this.getDominantEmotion(analysis.emotions);
          prompt += `æ„Ÿæƒ…åˆ†æ: ${dominantEmotion}\n`;
        }
        
        prompt += `\nãƒ¦ãƒ¼ã‚¶ãƒ¼: ${message}\nAI: `;
        
        return prompt;
      }
      
      processModelOutput(generatedText, originalPrompt) {
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆéƒ¨åˆ†ã‚’é™¤å»
        let response = generatedText.replace(originalPrompt, '').trim();
        
        // ä¸è¦ãªæ”¹è¡Œã‚„ç©ºç™½ã‚’æ•´ç†
        response = response.replace(/\n+/g, '\n').trim();
        
        // å¿œç­”ãŒçŸ­ã™ãã‚‹å ´åˆã¯æ‹¡å¼µ
        if (response.length < 10) {
          response = this.expandResponse(response);
        }
        
        return response;
      }
      
      getDominantEmotion(emotions) {
        let maxEmotion = 'neutral';
        let maxValue = 0;
        
        for (const [emotion, value] of Object.entries(emotions)) {
          if (value > maxValue) {
            maxValue = value;
            maxEmotion = emotion;
          }
        }
        
        const emotionNames = {
          'joy': 'å–œã³',
          'sadness': 'æ‚²ã—ã¿',
          'anger': 'æ€’ã‚Š',
          'fear': 'æã‚Œ',
          'surprise': 'é©šã',
          'love': 'æ„›æƒ…',
          'trust': 'ä¿¡é ¼',
          'confusion': 'æ··ä¹±',
          'excitement': 'èˆˆå¥®'
        };
        
        return emotionNames[maxEmotion] || maxEmotion;
      }
      
      expandResponse(shortResponse) {
        const expansions = {
          'ã¯ã„': 'ã¯ã„ã€ãŠæ‰‹ä¼ã„ã§ãã¾ã™ã€‚ä½•ã‹ã”è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ã„ã„ãˆ': 'ã„ã„ãˆã€ãã®é€šã‚Šã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è©³ã—ãèª¬æ˜ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚',
          'åˆ†ã‹ã‚Šã¾ã—ãŸ': 'åˆ†ã‹ã‚Šã¾ã—ãŸã€‚ä»–ã«ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ã‚ã‚ŠãŒã¨ã†': 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠå½¹ã«ç«‹ã¦ã¦å¬‰ã—ã„ã§ã™ã€‚'
        };
        
        return expansions[shortResponse] || shortResponse;
      }
      
      generateFallbackResponse(message, analysis, context) {
        // åˆ†æçµæœã«åŸºã¥ãé©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
        if (analysis.intent === 'question') {
          return this.getQuestionFallback(analysis);
        } else if (analysis.intent === 'greeting') {
          return this.getGreetingFallback(context);
        } else if (analysis.sentiment === 'negative') {
          return this.getSupportiveFallback(analysis);
        } else {
          return this.getGeneralFallback(message, analysis);
        }
      }
      
      getQuestionFallback(analysis) {
        const questionResponses = {
          'specific': 'ãã®è³ªå•ã«ã¤ã„ã¦è©³ã—ãèª¿ã¹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
          'general': 'èˆˆå‘³æ·±ã„è³ªå•ã§ã™ã­ã€‚ä¸€ç·’ã«è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
          'opinion': 'ç§ã®è€ƒãˆã‚’ãŠè©±ã—ã•ã›ã¦ã„ãŸã ãã¾ã™ã­ã€‚',
          'explanation': 'åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚'
        };
        
        return questionResponses[analysis.questionType] || 'è‰¯ã„è³ªå•ã§ã™ã­ã€‚è©³ã—ããŠç­”ãˆã—ã¾ã™ã€‚';
      }
      
      getGreetingFallback(context) {
        const timeGreetings = {
          'morning': 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ä»Šæ—¥ã‚‚ä¸€æ—¥é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚',
          'afternoon': 'ã“ã‚“ã«ã¡ã¯ï¼åˆå¾Œã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚',
          'evening': 'ã“ã‚“ã°ã‚“ã¯ï¼ä¸€æ—¥ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚',
          'night': 'å¤œé…ãã¾ã§ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ã‚†ã£ãã‚Šä¼‘ã‚“ã§ãã ã•ã„ã­ã€‚'
        };
        
        return timeGreetings[context.timeOfDay] || 'ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ';
      }
      
      getSupportiveFallback(analysis) {
        if (analysis.emotions.sadness > 5) {
          return 'ãŠæ°—æŒã¡ã€ã‚ˆãåˆ†ã‹ã‚Šã¾ã™ã€‚ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã­ã€‚';
        } else if (analysis.emotions.anger > 5) {
          return 'ãŠæ€’ã‚Šã®æ°—æŒã¡ã€ç†è§£ã§ãã¾ã™ã€‚ä¸€ç·’ã«è§£æ±ºç­–ã‚’è€ƒãˆã¾ã—ã‚‡ã†ã€‚';
        } else if (analysis.emotions.fear > 5) {
          return 'ä¸å®‰ãªæ°—æŒã¡ã§ã™ã­ã€‚å®‰å¿ƒã§ãã‚‹æ–¹æ³•ã‚’ä¸€ç·’ã«è€ƒãˆã¾ã—ã‚‡ã†ã€‚';
        } else {
          return 'å¤§å¤‰ãªçŠ¶æ³ã§ã™ã­ã€‚ç§ã«ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚';
        }
      }
      
      getGeneralFallback(message, analysis) {
        const responses = [
          'ãã†ã§ã™ã­ã€‚ä»–ã«ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'èˆˆå‘³æ·±ã„ãŠè©±ã§ã™ã­ã€‚ã‚‚ã£ã¨è©³ã—ãèã‹ã›ã¦ãã ã•ã„ã€‚',
          'ç†è§£ã—ã¾ã—ãŸã€‚ä»–ã«ã”è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ãªã‚‹ã»ã©ã€ãã†ã§ã™ã­ã€‚ä½•ã‹ä»–ã«ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ'
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
      }
      
      buildFallbackResponses() {
        return {
          greeting: [
            'ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'ã‚„ã‚ï¼ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã§ã—ãŸã‹ï¼Ÿ',
            'ã“ã‚“ã«ã¡ã¯ï¼ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿ'
          ],
          question: [
            'è‰¯ã„è³ªå•ã§ã™ã­ã€‚è©³ã—ããŠç­”ãˆã—ã¾ã™ã€‚',
            'ãã®è³ªå•ã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
            'èˆˆå‘³æ·±ã„è³ªå•ã§ã™ã€‚ä¸€ç·’ã«è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚'
          ],
          support: [
            'ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚è¨€ã£ã¦ãã ã•ã„ã€‚',
            'ç§ã«ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€å…¨åŠ›ã§ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚',
            'å›°ã£ãŸã“ã¨ãŒã‚ã‚Œã°ã€é æ…®ãªããŠå£°ãŒã‘ãã ã•ã„ã€‚'
          ]
        };
      }
    }
    
    // ãƒ­ãƒ¼ã‚«ãƒ«AIã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    const localAI = new LocalAISystem();
    
    // åˆæœŸåŒ–æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«AIã‚’èµ·å‹•
    localAI.initialize();
    
    // çµ±åˆç„¡æ–™AIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
    class IntegratedAILearningSystem {
      constructor() {
        this.emotionAnalyzer = new AdvancedEmotionAnalyzer();
        this.contextManager = advancedContextManager;
        this.patternMatcher = advancedPatternMatcher;
        this.externalAPI = externalAPI;
        this.localAI = localAI;
        this.learningData = learningData;
        this.userPreferences = userPreferences;
      }
      
      async processMessage(message, userId = 'default') {
        try {
          console.log('ğŸ”„ çµ±åˆAIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ : ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†é–‹å§‹');
          
          // 1. é«˜åº¦ãªæ„Ÿæƒ…ãƒ»æ„å›³ãƒ»ãƒˆãƒ”ãƒƒã‚¯åˆ†æ
          const analysis = this.analyzeMessage(message);
          console.log('ğŸ“Š åˆ†æçµæœ:', analysis);
          
          // 2. æ–‡è„ˆã®ç†è§£ã¨æ›´æ–°
          const context = this.contextManager.getContext(userId);
          console.log('ğŸŒ æ–‡è„ˆæƒ…å ±:', context);
          
          // 3. çŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ¤œç´¢
          const knowledgeResults = await this.externalAPI.searchKnowledgeBase(message);
          console.log('ğŸ“š çŸ¥è­˜ãƒ™ãƒ¼ã‚¹çµæœ:', knowledgeResults.length);
          
          // 4. å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®å¿œç­”ç”Ÿæˆ
          const learnedResponse = this.generateLearnedResponse(message, analysis, context);
          console.log('ğŸ§  å­¦ç¿’ãƒ™ãƒ¼ã‚¹å¿œç­”:', learnedResponse ? 'ç”Ÿæˆæ¸ˆã¿' : 'ãªã—');
          
          // 5. ãƒ­ãƒ¼ã‚«ãƒ«AIã«ã‚ˆã‚‹å¿œç­”ç”Ÿæˆ
          const aiResponse = await this.localAI.generateResponse(message, analysis, context);
          console.log('ğŸ¤– ãƒ­ãƒ¼ã‚«ãƒ«AIå¿œç­”:', aiResponse ? 'ç”Ÿæˆæ¸ˆã¿' : 'ãªã—');
          
          // 6. å¿œç­”ã®çµ±åˆã¨æœ€é©åŒ–
          const finalResponse = this.integrateResponses(learnedResponse, aiResponse, knowledgeResults, analysis);
          console.log('âœ¨ æœ€çµ‚å¿œç­”ç”Ÿæˆå®Œäº†');
          
          // 7. å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
          this.updateLearningData(message, finalResponse, analysis, context);
          
          // 8. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°
          this.contextManager.updateContext(userId, message, analysis, finalResponse);
          
          console.log('âœ… çµ±åˆAIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ : ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†å®Œäº†');
          
          return finalResponse;
        } catch (error) {
          console.error('âŒ çµ±åˆAIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ  ã‚¨ãƒ©ãƒ¼:', error);
          return this.getErrorResponse(error);
        }
      }
      
      analyzeMessage(message) {
        // é«˜åº¦ãªæ„Ÿæƒ…åˆ†æ
        const emotionResult = this.emotionAnalyzer.analyze(message);
        
        // åŸºæœ¬çš„ãªåˆ†æ
        const basicAnalysis = analyzeUserMessage(message);
        
        // åˆ†æçµæœã®çµ±åˆ
        return {
          ...basicAnalysis,
          ...emotionResult,
          timestamp: new Date().toISOString(),
          messageLength: message.length,
          complexity: this.analyzeMessageComplexity(message)
        };
      }
      
      analyzeMessageComplexity(message) {
        const wordCount = message.split(/\s+/).length;
        const hasComplexStructures = /[ã€ã€‚ï¼ï¼Ÿ]/.test(message);
        const hasEmojis = /[\u{1F600}-\u{1F64F}]/u.test(message);
        const hasURLs = /https?:\/\/[^\s]+/.test(message);
        
        let complexity = 0;
        if (wordCount > 20) complexity += 3;
        else if (wordCount > 10) complexity += 2;
        else complexity += 1;
        
        if (hasComplexStructures) complexity += 2;
        if (hasEmojis) complexity += 1;
        if (hasURLs) complexity += 2;
        
        if (complexity >= 6) return 'very_complex';
        if (complexity >= 4) return 'complex';
        if (complexity >= 2) return 'medium';
        return 'simple';
      }
      
      generateLearnedResponse(message, analysis, context) {
        try {
          // é«˜åº¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
          const similarPattern = this.patternMatcher.findSimilarPattern(message, analysis, this.learningData);
          
          if (similarPattern && similarPattern.quality > 3) {
            return this.adaptResponseFromPattern(similarPattern, analysis, context);
          }
          
          // å¾“æ¥ã®å¿œç­”ç”Ÿæˆ
          return selectResponsePattern(analysis);
        } catch (error) {
          console.error('å­¦ç¿’ãƒ™ãƒ¼ã‚¹å¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
          return null;
        }
      }
      
      adaptResponseFromPattern(pattern, currentAnalysis, context) {
        let response = pattern.aiResponse;
        
        // ç¾åœ¨ã®æ–‡è„ˆã«åˆã‚ã›ã¦å¿œç­”ã‚’èª¿æ•´
        if (currentAnalysis.formality !== pattern.analysis?.formality) {
          if (currentAnalysis.formality === 'formal') {
            response = response.replace(/ã ã‚ˆ/g, 'ã§ã™').replace(/ã ã­/g, 'ã§ã™ã­');
          } else {
            response = response.replace(/ã§ã™/g, 'ã ã‚ˆ').replace(/ã¾ã™ã­/g, 'ã ã­');
          }
        }
        
        // æ„Ÿæƒ…ãƒ¬ãƒ™ãƒ«ã«åˆã‚ã›ã¦èª¿æ•´
        if (currentAnalysis.emotionLevel > 3) {
          response = response.replace(/ã€‚/g, 'ï¼');
        } else if (currentAnalysis.emotionLevel < -3) {
          response = response.replace(/ï¼/g, 'ã€‚');
        }
        
        return response;
      }
      
      integrateResponses(learned, ai, knowledge, analysis) {
        let finalResponse = '';
        
        // 1. çŸ¥è­˜ãƒ™ãƒ¼ã‚¹æƒ…å ±ã®çµ±åˆ
        if (knowledge && knowledge.length > 0) {
          finalResponse += this.integrateKnowledge(knowledge);
        }
        
        // 2. ãƒ¡ã‚¤ãƒ³å¿œç­”ã®é¸æŠ
        let mainResponse = '';
        if (learned && learned.length > 20) {
          mainResponse = learned;
        } else if (ai && ai.length > 10) {
          mainResponse = ai;
        } else {
          mainResponse = learned || ai || 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚é©åˆ‡ãªå¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
        }
        
        finalResponse += mainResponse;
        
        // 3. å¿œç­”ã®æœ€é©åŒ–
        finalResponse = this.optimizeResponse(finalResponse, analysis);
        
        return finalResponse;
      }
      
      integrateKnowledge(knowledgeResults) {
        let knowledgeSection = '';
        
        // Wikipediaæƒ…å ±
        const wikiResult = knowledgeResults.find(result => result.type === 'wikipedia');
        if (wikiResult) {
          const wiki = wikiResult.data;
          knowledgeSection += `ğŸ“š **${wiki.title}**ã«ã¤ã„ã¦\n\n`;
          knowledgeSection += `${wiki.extract}\n\n`;
          knowledgeSection += `è©³ç´°ã¯[Wikipedia](${wiki.url})ã§ç¢ºèªã§ãã¾ã™ã€‚\n\n`;
        }
        
        // ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±
        const newsResult = knowledgeResults.find(result => result.type === 'news');
        if (newsResult && newsResult.data.length > 0) {
          knowledgeSection += `ğŸ“° **æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹**\n\n`;
          newsResult.data.slice(0, 2).forEach(news => {
            knowledgeSection += `â€¢ [${news.title}](${news.url})\n`;
          });
          knowledgeSection += `\n`;
        }
        
        return knowledgeSection;
      }
      
      optimizeResponse(response, analysis) {
        // æ„Ÿæƒ…ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ãæœ€é©åŒ–
        if (analysis.emotionLevel > 3) {
          response = response.replace(/ã€‚/g, 'ï¼');
        } else if (analysis.emotionLevel < -3) {
          response = response.replace(/ï¼/g, 'ã€‚');
        }
        
        // è¤‡é›‘ã•ã«åŸºã¥ãæœ€é©åŒ–
        if (analysis.complexity === 'simple' && response.length > 100) {
          response = response.substring(0, 100) + '...';
        }
        
        return response;
      }
      
      updateLearningData(message, response, analysis, context) {
        try {
          // ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å­¦ç¿’
          const pattern = {
            userMessage: message,
            aiResponse: response,
            analysis: analysis,
            context: context,
            timestamp: new Date().toISOString(),
            quality: 0,
            id: Date.now()
          };
          
          this.learningData.conversationPatterns.push(pattern);
          
          // ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°ã‚’åˆ¶é™
          if (this.learningData.conversationPatterns.length > 1000) {
            this.learningData.conversationPatterns = this.learningData.conversationPatterns.slice(-1000);
          }
          
          // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ›´æ–°
          this.patternMatcher.updateSemanticIndex(pattern);
          
          // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
          saveLearningData();
          
          console.log('ğŸ’¾ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†');
        } catch (error) {
          console.error('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        }
      }
      
      getErrorResponse(error) {
        const errorResponses = [
          'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
          'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
          'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å¿œç­”ã®ç”Ÿæˆä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'
        ];
        
        return errorResponses[Math.floor(Math.random() * errorResponses.length)];
      }
      
      // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®å–å¾—
      getSystemStatus() {
        return {
          emotionAnalyzer: 'active',
          contextManager: 'active',
          patternMatcher: 'active',
          externalAPI: 'active',
          localAI: this.localAI.modelLoaded ? 'active' : 'fallback',
          learningData: this.learningData.conversationPatterns.length,
          cacheSize: this.patternMatcher.patternCache.size
        };
      }
      
      // å­¦ç¿’é€²æ—ã®å–å¾—
      getLearningProgress() {
        const patterns = this.learningData.conversationPatterns;
        const highQualityPatterns = patterns.filter(p => p.quality > 3).length;
        
        return {
          totalPatterns: patterns.length,
          highQualityPatterns: highQualityPatterns,
          qualityRatio: patterns.length > 0 ? (highQualityPatterns / patterns.length) * 100 : 0,
          recentActivity: patterns.slice(-10).map(p => ({
            timestamp: p.timestamp,
            topic: p.analysis.topic,
            sentiment: p.analysis.sentiment
          }))
        };
      }
    }
    
    // çµ±åˆAIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    const integratedAI = new IntegratedAILearningSystem();
    
    // aiReplyé–¢æ•°ã‚’çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã«ç½®ãæ›ãˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
    async function aiReply(text) {
      try {
        console.log('ğŸ¤– AIå¿œç­”ç”Ÿæˆé–‹å§‹:', text);
        
        // 1. åŸºæœ¬çš„ãªä¼šè©±å¿œç­”ã‚’å„ªå…ˆ
        const basicResponse = generateBasicResponse(text);
        if (basicResponse && basicResponse !== 'æ¤œç´¢æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™') {
          console.log('âœ… åŸºæœ¬å¿œç­”ç”Ÿæˆå®Œäº†');
          return basicResponse;
        }
        
        // 2. æ¤œç´¢ãŒå¿…è¦ãªå ´åˆã®ã¿æ¤œç´¢ã‚’å®Ÿè¡Œ
        if (text.includes('æ¤œç´¢') || text.includes('èª¿ã¹ã¦') || text.includes('æ•™ãˆã¦') || text.includes('ãƒ‹ãƒ¥ãƒ¼ã‚¹')) {
          console.log('ğŸ” æ¤œç´¢æ©Ÿèƒ½ã‚’å®Ÿè¡Œ');
          const searchResponse = await executeSearch(text);
          if (searchResponse) {
            return searchResponse;
          }
        }
        
        // 3. çµ±åˆAIã‚·ã‚¹ãƒ†ãƒ ã‚’è©¦è¡Œï¼ˆè»½é‡ç‰ˆï¼‰
        console.log('ğŸ§  çµ±åˆAIã‚·ã‚¹ãƒ†ãƒ ã‚’è©¦è¡Œ');
        const userId = localStorage.getItem('user_id') || 'default';
        const integratedResponse = await integratedAI.processMessage(text, userId);
        
        if (integratedResponse && integratedResponse.length > 0) {
          console.log('âœ… çµ±åˆAIå¿œç­”ç”Ÿæˆå®Œäº†');
          return integratedResponse;
        }
        
        // 4. æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        console.log('ğŸ”„ æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬å¿œç­”ç”Ÿæˆã‚’ä½¿ç”¨');
        return basicResponse || 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚é©åˆ‡ãªå¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
        
      } catch (error) {
        console.error('âŒ AIå¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        try {
          console.log('ğŸ”„ ã‚¨ãƒ©ãƒ¼æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬å¿œç­”ç”Ÿæˆã‚’ä½¿ç”¨');
          return generateBasicResponse(text);
        } catch (fallbackError) {
          console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å¤±æ•—:', fallbackError);
          return 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
      }
    }
    
    // æ¤œç´¢å®Ÿè¡Œé–¢æ•°
    async function executeSearch(text) {
      try {
        console.log('ğŸ” æ¤œç´¢å®Ÿè¡Œ:', text);
        
        // æ¤œç´¢ã‚¯ã‚¨ãƒªã®æŠ½å‡º
        let searchQuery = text;
        if (text.includes('æ¤œç´¢')) {
          searchQuery = text.replace(/æ¤œç´¢/, '').replace(/ã—ã¦/, '').trim();
        } else if (text.includes('èª¿ã¹ã¦')) {
          searchQuery = text.replace(/èª¿ã¹ã¦/, '').trim();
        } else if (text.includes('æ•™ãˆã¦')) {
          searchQuery = text.replace(/æ•™ãˆã¦/, '').trim();
        }
        
        // çŸ­ã„å˜èªã®æ¤œç´¢
        if (searchQuery.length <= 2) {
          const shortWordSearch = searchWeb(searchQuery);
          if (shortWordSearch) {
            return shortWordSearch;
          }
        }
        
        // ä¸€èˆ¬çš„ãªæ¤œç´¢
        const searchResult = searchWeb(searchQuery);
        if (searchResult) {
          return searchResult;
        }
        
        return null;
      } catch (error) {
        console.error('æ¤œç´¢å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }
    
    // åŸºæœ¬çš„ãªå¿œç­”ç”Ÿæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
    function generateBasicResponse(text) {
      try {
        // åŸºæœ¬çš„ãªåˆ†æ
        const analysis = analyzeUserMessage(text);
        
        // æ¤œç´¢æ„å›³ã®ç¢ºèªï¼ˆåŸºæœ¬å¿œç­”ã§ã¯æ¤œç´¢ã—ãªã„ï¼‰
        if (text.includes('æ¤œç´¢') || text.includes('èª¿ã¹ã¦') || text.includes('æ•™ãˆã¦')) {
          return 'æ¤œç´¢æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™';
        }
        
        // æ™‚é–“ãƒ»æ—¥ä»˜ã®ç¢ºèª
        if (text.includes('æ™‚é–“') || text.includes('ä½•æ™‚') || text.includes('æ—¥ä»˜')) {
          const now = new Date();
          return `ç¾åœ¨ã®æ™‚åˆ»ã¯${now.getHours()}æ™‚${now.getMinutes()}åˆ†ã§ã™ã€‚æ—¥ä»˜ã¯${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ã§ã™ã€‚`;
        }
        
        // å¤©æ°—ãƒ»æ°—æ¸©ã®ç¢ºèª
        if (text.includes('å¤©æ°—') || text.includes('æ°—æ¸©') || text.includes('æš‘ã„') || text.includes('å¯’ã„')) {
          return getWeatherFallback();
        }
        
        // æŒ¨æ‹¶ã¸ã®å¿œç­”
        if (text.includes('ã“ã‚“ã«ã¡ã¯') || text.includes('ãŠã¯ã‚ˆã†') || text.includes('ã“ã‚“ã°ã‚“ã¯')) {
          const hour = new Date().getHours();
          const responses = {
            morning: [
              'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ä»Šæ—¥ã‚‚ä¸€æ—¥é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼',
              'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ï¼',
              'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ä»Šæ—¥ã‚‚å…ƒæ°—ã«éã”ã—ã¾ã—ã‚‡ã†ï¼'
            ],
            afternoon: [
              'ã“ã‚“ã«ã¡ã¯ï¼åˆå¾Œã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼',
              'ã“ã‚“ã«ã¡ã¯ï¼åˆå¾Œã‚‚å……å®Ÿã—ãŸæ™‚é–“ã‚’ãŠéã”ã—ãã ã•ã„ï¼',
              'ã“ã‚“ã«ã¡ã¯ï¼åˆå¾Œã‚‚å…ƒæ°—ã«éã”ã—ã¾ã—ã‚‡ã†ï¼'
            ],
            evening: [
              'ã“ã‚“ã°ã‚“ã¯ï¼ä¸€æ—¥ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼',
              'ã“ã‚“ã°ã‚“ã¯ï¼ä»Šæ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼',
              'ã“ã‚“ã°ã‚“ã¯ï¼ã‚†ã£ãã‚Šä¼‘ã‚“ã§ãã ã•ã„ã­ï¼'
            ],
            night: [
              'å¤œé…ãã¾ã§ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ã‚†ã£ãã‚Šä¼‘ã‚“ã§ãã ã•ã„ã­ã€‚',
              'å¤œé…ãã¾ã§ãŠç–²ã‚Œæ§˜ã§ã™ã€‚æ˜æ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼',
              'å¤œé…ãã¾ã§ãŠç–²ã‚Œæ§˜ã§ã™ã€‚è‰¯ã„å¤¢ã‚’è¦‹ã¦ãã ã•ã„ã­ã€‚'
            ]
          };
          
          let timeCategory;
          if (hour >= 5 && hour < 12) timeCategory = 'morning';
          else if (hour >= 12 && hour < 17) timeCategory = 'afternoon';
          else if (hour >= 17 && hour < 21) timeCategory = 'evening';
          else timeCategory = 'night';
          
          const timeResponses = responses[timeCategory];
          return timeResponses[Math.floor(Math.random() * timeResponses.length)];
        }
        
        // æ„Ÿè¬ã¸ã®å¿œç­”
        if (text.includes('ã‚ã‚ŠãŒã¨ã†') || text.includes('æ„Ÿè¬')) {
          const gratitudeResponses = [
            'ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ãŠå½¹ã«ç«‹ã¦ã¦å¬‰ã—ã„ã§ã™ã€‚ä»–ã«ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ãŠå½¹ã«ç«‹ã¦ã¦è‰¯ã‹ã£ãŸã§ã™ã€‚ä»–ã«ã‚‚ä½•ã‹ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ãŠæ‰‹ä¼ã„ã§ãã¦å¬‰ã—ã„ã§ã™ã€‚ä½•ã‹ä»–ã«ã”è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
            'ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ãŠå½¹ã«ç«‹ã¦ã¦å…‰æ „ã§ã™ã€‚ä»–ã«ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ'
          ];
          return gratitudeResponses[Math.floor(Math.random() * gratitudeResponses.length)];
        }
        
        // æ„Ÿæƒ…ã«åŸºã¥ãå¿œç­”
        if (analysis.emotions) {
          const dominantEmotion = getDominantEmotion(analysis.emotions);
          
          if (dominantEmotion === 'joy' && analysis.emotions.joy > 5) {
            const joyResponses = [
              'ã‚ãªãŸã®å–œã³ãŒä¼ã‚ã£ã¦ãã¾ã™ï¼ä½•ã‹è‰¯ã„ã“ã¨ãŒã‚ã£ãŸã®ã§ã™ã­ã€‚',
              'ãã‚Œã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ï¼ä¸€ç·’ã«å–œã°ã›ã¦ãã ã•ã„ã€‚',
              'ã‚ãªãŸã®ç¬‘é¡”ãŒç›®ã«æµ®ã‹ã³ã¾ã™ï¼ä½•ã‹è‰¯ã„ã“ã¨ãŒã‚ã£ãŸã®ã§ã™ã­ã€‚'
            ];
            return joyResponses[Math.floor(Math.random() * joyResponses.length)];
          }
          
          if (dominantEmotion === 'sadness' && analysis.emotions.sadness > 5) {
            const sadnessResponses = [
              'ãŠæ°—æŒã¡ã€ã‚ˆãåˆ†ã‹ã‚Šã¾ã™ã€‚ä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ãã ã•ã„ã­ã€‚',
              'å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ãŒã‚ã‚Œã°ã€ã„ã¤ã§ã‚‚è¨€ã£ã¦ãã ã•ã„ã€‚',
              'ãŠæ°—æŒã¡ã€ç†è§£ã§ãã¾ã™ã€‚ä¸€ç·’ã«è§£æ±ºç­–ã‚’è€ƒãˆã¾ã—ã‚‡ã†ã€‚'
            ];
            return sadnessResponses[Math.floor(Math.random() * sadnessResponses.length)];
          }
          
          if (dominantEmotion === 'anger' && analysis.emotions.anger > 5) {
            const angerResponses = [
              'ãŠæ€’ã‚Šã®æ°—æŒã¡ã€ç†è§£ã§ãã¾ã™ã€‚ä¸€ç·’ã«è§£æ±ºç­–ã‚’è€ƒãˆã¾ã—ã‚‡ã†ã€‚',
              'ãã®æ°—æŒã¡ã€ã‚ˆãåˆ†ã‹ã‚Šã¾ã™ã€‚è½ã¡ç€ã„ã¦ä¸€ç·’ã«è€ƒãˆã¾ã—ã‚‡ã†ã€‚',
              'ãŠæ€’ã‚Šã®æ°—æŒã¡ã€ç†è§£ã§ãã¾ã™ã€‚ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ'
            ];
            return angerResponses[Math.floor(Math.random() * angerResponses.length)];
          }
        }
        
        // è³ªå•ã¸ã®å¿œç­”
        if (text.includes('ï¼Ÿ') || text.includes('?')) {
          const questionResponses = [
            'è‰¯ã„è³ªå•ã§ã™ã­ã€‚è©³ã—ããŠç­”ãˆã—ã¾ã™ã€‚ä½•ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ',
            'ãã‚Œã¯èˆˆå‘³æ·±ã„è³ªå•ã§ã™ã€‚ä¸€ç·’ã«è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
            'è‰¯ã„è³ªå•ã§ã™ã­ã€‚ä½•ã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ',
            'ãã‚Œã¯é¢ç™½ã„è³ªå•ã§ã™ã€‚è©³ã—ããŠç­”ãˆã—ã¾ã™ã­ã€‚',
            'è‰¯ã„è³ªå•ã§ã™ã­ã€‚ä½•ã«ã¤ã„ã¦ãŠèãã«ãªã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ'
          ];
          return questionResponses[Math.floor(Math.random() * questionResponses.length)];
        }
        
        // ã‚ˆã‚Šè‡ªç„¶ãªä¼šè©±å¿œç­”
        const responses = [
          'ãã†ã§ã™ã­ã€‚ä»–ã«ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'èˆˆå‘³æ·±ã„ãŠè©±ã§ã™ã­ã€‚ã‚‚ã£ã¨è©³ã—ãèã‹ã›ã¦ãã ã•ã„ã€‚',
          'ç†è§£ã—ã¾ã—ãŸã€‚ä½•ã‹ä»–ã«ã”è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ãªã‚‹ã»ã©ã€ãã†ã§ã™ã­ã€‚ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ãŠè©±ã—ã—ã¦ãã ã•ã£ã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä»–ã«ã‚‚ä½•ã‹ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ãã‚Œã¯é¢ç™½ã„ã§ã™ã­ã€‚ä»–ã«ä½•ã‹ãŠèã‹ã›ãã ã•ã„ã€‚',
          'ãã†ãªã‚“ã§ã™ã­ã€‚ä»–ã«ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ãŠã£ã—ã‚ƒã‚‹é€šã‚Šã§ã™ã€‚ä½•ã‹ä»–ã«ã”è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ãã‚Œã¯è‰¯ã„ã§ã™ã­ã€‚ä»–ã«ã‚‚ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ',
          'ãªã‚‹ã»ã©ã€ç†è§£ã—ã¾ã—ãŸã€‚ä»–ã«ä½•ã‹ã‚ã‚Šã¾ã™ã‹ï¼Ÿ'
        ];
        
        return responses[Math.floor(Math.random() * responses.length)];
        
      } catch (error) {
        console.error('åŸºæœ¬å¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        return 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å¿œç­”ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
      }
    }
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ã®å¿œç­”é©å¿œ
    function adaptResponseFromPattern(pattern, currentAnalysis) {
      let response = pattern.aiResponse;
      
      // ç¾åœ¨ã®æ–‡è„ˆã«åˆã‚ã›ã¦å¿œç­”ã‚’èª¿æ•´
      if (currentAnalysis.formality !== pattern.analysis.formality) {
        if (currentAnalysis.formality === 'formal') {
          response = response.replace(/ã ã‚ˆ/g, 'ã§ã™').replace(/ã ã­/g, 'ã§ã™ã­');
        } else {
          response = response.replace(/ã§ã™/g, 'ã ã‚ˆ').replace(/ã¾ã™ã­/g, 'ã ã­');
        }
      }
      
      return response;
    }
    
    // å¿œç­”å“è³ªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    function rateResponse(messageId, rating) {
      // 1-5ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
      const pattern = learningData.conversationPatterns.find(p => p.messageId === messageId);
      if (pattern) {
        pattern.quality = rating;
        saveLearningData();
      }
    }
    
    // å­¦ç¿’è¨­å®šUI
    function showLearningSettings() {
      const settingsHTML = `
        <div id="learning-settings" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
             background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333; z-index: 1000;">
          <h3 style="color: white; margin-top: 0;">ğŸ§  AIå­¦ç¿’è¨­å®š</h3>
          

          
          <div style="margin: 10px 0;">
            <label style="color: white;">å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«:</label><br>
            <select id="learning-style-select" style="padding: 5px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
              <option value="adaptive" ${userPreferences.learningStyle === 'adaptive' ? 'selected' : ''}>é©å¿œå‹</option>
              <option value="pattern" ${userPreferences.learningStyle === 'pattern' ? 'selected' : ''}>ãƒ‘ã‚¿ãƒ¼ãƒ³å­¦ç¿’</option>
              <option value="contextual" ${userPreferences.learningStyle === 'contextual' ? 'selected' : ''}>æ–‡è„ˆå­¦ç¿’</option>
            </select>
          </div>
          
          <div style="margin: 10px 0;">
            <label style="color: white;">å¿œç­”è¤‡é›‘åº¦:</label><br>
            <select id="complexity-select" style="padding: 5px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
              <option value="simple" ${userPreferences.responseComplexity === 'simple' ? 'selected' : ''}>ã‚·ãƒ³ãƒ—ãƒ«</option>
              <option value="medium" ${userPreferences.responseComplexity === 'medium' ? 'selected' : ''}>æ¨™æº–</option>
              <option value="complex" ${userPreferences.responseComplexity === 'complex' ? 'selected' : ''}>è¤‡é›‘</option>
            </select>
          </div>
          
          <div style="margin: 10px 0;">
            <label style="color: white;">
              <input type="checkbox" id="auto-learn-checkbox" ${userPreferences.autoLearn ? 'checked' : ''}> 
              è‡ªå‹•å­¦ç¿’ã‚’æœ‰åŠ¹åŒ–
            </label>
          </div>
          
          <div style="margin: 10px 0; color: #888;">
            å­¦ç¿’ãƒ‡ãƒ¼ã‚¿: ${learningData.conversationPatterns.length}ãƒ‘ã‚¿ãƒ¼ãƒ³<br>
            ç„¡æ–™AIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ : ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
          </div>
          
          <div style="margin-top: 20px;">
            <button onclick="saveLearningSettings()" style="padding: 10px 20px; margin-right: 10px; background: #333; color: white; border: none; border-radius: 5px;">ä¿å­˜</button>
            <button onclick="closeLearningSettings()" style="padding: 10px 20px; background: #555; color: white; border: none; border-radius: 5px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
        <div id="settings-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;" onclick="closeLearningSettings()"></div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', settingsHTML);
    }
    
    function saveLearningSettings() {
      userPreferences.learningStyle = document.getElementById('learning-style-select').value;
      userPreferences.responseComplexity = document.getElementById('complexity-select').value;
      userPreferences.autoLearn = document.getElementById('auto-learn-checkbox').checked;
      
      saveUserPreferences();
      closeLearningSettings();
      
      addMessage('system', ' å­¦ç¿’è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼ç„¡æ–™AIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ãŒæœ€é©åŒ–ã•ã‚Œã¾ã™ã€‚');
    }
    
    function closeLearningSettings() {
      const settings = document.getElementById('learning-settings');
      const overlay = document.getElementById('settings-overlay');
      if (settings) settings.remove();
      if (overlay) overlay.remove();
    }
    
    // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º
    function showSystemStatus() {
      try {
        const status = integratedAI.getSystemStatus();
        const progress = integratedAI.getLearningProgress();
        
        const statusHTML = `
          <div id="system-status" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
               background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333; z-index: 1000; max-width: 500px;">
            <h3 style="color: white; margin-top: 0;">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
            
            <div style="margin: 10px 0; color: white;">
              <strong>ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ:</strong><br>
              â€¢ æ„Ÿæƒ…åˆ†æ: ${status.emotionAnalyzer}<br>
              â€¢ æ–‡è„ˆç®¡ç†: ${status.contextManager}<br>
              â€¢ ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°: ${status.patternMatcher}<br>
              â€¢ å¤–éƒ¨API: ${status.externalAPI}<br>
              â€¢ ãƒ­ãƒ¼ã‚«ãƒ«AI: ${status.localAI}<br>
              â€¢ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿: ${status.learningData}ãƒ‘ã‚¿ãƒ¼ãƒ³<br>
              â€¢ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º: ${status.cacheSize}ä»¶
            </div>
            
            <div style="margin: 10px 0; color: white;">
              <strong>å­¦ç¿’é€²æ—:</strong><br>
              â€¢ ç·ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°: ${progress.totalPatterns}<br>
              â€¢ é«˜å“è³ªãƒ‘ã‚¿ãƒ¼ãƒ³: ${progress.highQualityPatterns}<br>
              â€¢ å“è³ªæ¯”ç‡: ${progress.qualityRatio.toFixed(1)}%<br>
              â€¢ æœ€è¿‘ã®æ´»å‹•: ${progress.recentActivity.length}ä»¶
            </div>
            
            <div style="margin: 10px 0; color: #888;">
              <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
              â€¢ ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent.substring(0, 50)}...<br>
              â€¢ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${new Date().toLocaleString('ja-JP')}
            </div>
            
            <div style="margin-top: 20px;">
              <button onclick="closeSystemStatus()" style="padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px;">é–‰ã˜ã‚‹</button>
            </div>
          </div>
          <div id="status-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;" onclick="closeSystemStatus()"></div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', statusHTML);
        
      } catch (error) {
        console.error('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }
    }
    
    function closeSystemStatus() {
      const status = document.getElementById('system-status');
      const overlay = document.getElementById('status-overlay');
      if (status) status.remove();
      if (overlay) overlay.remove();
    }
    
    // åˆæœŸåŒ–æ™‚ã«å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    loadLearningData();
  </script>
</body>
</html>